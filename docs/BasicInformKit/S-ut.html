<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>S/dt</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../webs.html">Sources</a></h1>
<ul>
<li><a href="../compiler.html">compiler tools</a></li>
<li><a href="../other.html">other tools</a></li>
<li><a href="../extensions.html"><b>extensions and kits</b></a></li>
<li><a href="../units.html">unit test tools</a></li>
/ul>
<h2>Extensions</h2>
<ul>
<li><a href="../basic_inform/index.html">Basic Inform</a></li>
<li><a href="../standard_rules/index.html">Standard Rules</a></li>
</ul>
<h2>Kits</h2>
<ul>
<li><a href="../BasicInformKit/index.html">BasicInformKit</a></li>
<li><a href="../BasicInformExtrasKit/index.html">BasicInformExtrasKit</a></li>
<li><a href="../CommandParserKit/index.html">CommandParserKit</a></li>
<li><a href="../EnglishLanguageKit/index.html">EnglishLanguageKit</a></li>
<li><a href="../WorldModelKit/index.html">WorldModelKit</a></li>
</ul>


		</nav>
		<main role="main">
		
<!--Weave of 'S/ut' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">Source</a></li><li><a href="../extensions.html">Kits</a></li><li><a href="index.html">BasicInformKit</a></li><li><b>Utilities Template</b></li></ul><p class="purpose">Miscellaneous utility routines for some fundamental I6 needs.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Miscellany</a></li><li><a href="#SP2">&#167;2. Language of Play</a></li><li><a href="#SP3">&#167;3. VM-Specific Code</a></li><li><a href="#SP4">&#167;4. More</a></li><li><a href="#SP5">&#167;5. Print Decimal Number</a></li><li><a href="#SP6">&#167;6. Print Text</a></li><li><a href="#SP7">&#167;7. Properties</a></li><li><a href="#SP8">&#167;8. Print Or Run</a></li><li><a href="#SP9">&#167;9. Saying Phrases</a></li><li><a href="#SP10">&#167;10. Kinds</a></li><li><a href="#SP11">&#167;11. GenerateRandomNumber</a></li><li><a href="#SP12">&#167;12. PrintSpaces</a></li><li><a href="#SP13">&#167;13. SwapWorkflags</a></li><li><a href="#SP14">&#167;14. TestUseOption</a></li><li><a href="#SP15">&#167;15. ZRegion</a></li><li><a href="#SP16">&#167;16. Memcpy</a></li><li><a href="#SP17">&#167;17. Arrcpy</a></li><li><a href="#SP18">&#167;18. Verbs as Values</a></li><li><a href="#SP19">&#167;19. Seed Random Number Generator Rule</a></li><li><a href="#SP20">&#167;20. Extracting Verb Numbers</a></li><li><a href="#SP21">&#167;21. Say One Of</a></li><li><a href="#SP22">&#167;22. Rounding</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Miscellany. </b></p>


<pre class="display">
    <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">TARGET_ZCODE</span><span class="plain">;</span>
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">BLOCKV_STACK_SIZE</span><span class="plain"> = </span><span class="constant">224</span><span class="plain">;</span>
    <span class="plain">#</span><span class="identifier">ifnot</span><span class="plain">;</span>
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">BLOCKV_STACK_SIZE</span><span class="plain"> = </span><span class="identifier">DynamicMemoryAllocation</span><span class="plain">/4;</span>
    <span class="plain">#</span><span class="identifier">endif</span><span class="plain">;</span>

    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">blockv_stack</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="identifier">BLOCKV_STACK_SIZE</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">I7SFRAME</span><span class="plain">;</span>

    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">TEXT_TY_RE_Err</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">prior_named_noun</span><span class="plain">; </span><span class="comment">! for adaptive text generation</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">prior_named_list</span><span class="plain">; </span><span class="comment">! ditto: length of list of items</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">prior_named_list_gender</span><span class="plain">; </span><span class="comment">! ditto: common gender of list of items, or -1</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">story_tense</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! ditto: present tense</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">story_viewpoint</span><span class="plain"> = </span><span class="constant">2</span><span class="plain">; </span><span class="comment">! ditto: second person singular</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__p</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__pc</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__pc_save</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__n</span><span class="plain">; </span><span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__comp</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">los_rv</span><span class="plain"> = </span><span class="reserved">false</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">parameter_object</span><span class="plain">; </span><span class="comment">! = I7 "parameter-object" = I7 "container in question"</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">parameter_value</span><span class="plain">; </span><span class="comment">! not typesafe in I7</span>
    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">deferred_calling_list</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="constant">27</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">property_to_be_totalled</span><span class="plain">; </span><span class="comment">! used to implement "total P of..."</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">property_loop_sign</span><span class="plain">; </span><span class="comment">! $+1$ for increasing order, $-1$ for decreasing</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">suppress_scope_loops</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">temporary_value</span><span class="plain">; </span><span class="comment">! can be used anywhere side-effects can't occur</span>
    <span class="comment">! [13]</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_fg</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! foreground colour</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_bg</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! background colour</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_fgstatus</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! foreground colour of statusline</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_bgstatus</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! background colour of statusline</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_on</span><span class="plain">; </span><span class="comment">! has colour been enabled by the player?</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">statuswin_current</span><span class="plain">; </span><span class="comment">! if writing to top window</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">suppress_text_substitution</span><span class="plain"> = </span><span class="reserved">false</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">deadflag</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>

    <span class="comment">! [14]</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">statuswin_cursize</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">statuswin_size</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>

    <span class="comment">! [16]</span>
    <span class="comment">! Global debug_flag = 0;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">debug_rules</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">debug_rule_nesting</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">reason_the_action_failed</span><span class="plain">; </span><span class="comment">! = I7 "reason the action failed"</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">indef_mode</span><span class="plain">;                  </span><span class="comment">! "Indefinite" mode - ie, "take a brick"</span>
                                        <span class="comment">! is in this mode</span>

    <span class="comment">! [3]</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">standard_interpreter</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>

    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">LocalParking</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="constant">64</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. Language of Play. </b>The equivalent of I6's language definition file, though here the idea is
that a translation should have an inclusion to replace the "Language.i6t"
segment, which contains the English definition.
</p>


<pre class="display">

    <span class="identifier">Default</span><span class="plain"> </span><span class="identifier">LanguageCases</span><span class="plain"> </span><span class="constant">1</span><span class="plain">;</span>

</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. VM-Specific Code. </b>These sections of code contain different definitions of the same routines,
and in some cases the same arrays, to handle low-level functions in the
virtual machine &mdash; saving the game, performing UNDO, parsing typed text into
dictionary word addresses and so on.
</p>


<pre class="display">
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. More. </b></p>


<pre class="display">

    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">Protect_I7_Arrays</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="constant">16339</span><span class="plain"> </span><span class="constant">12345</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Print Decimal Number. </b><code class="display"><span class="extract">DecimalNumber</span></code> is a trivial function which just prints a number, in decimal
digits. It is left over from the I6 library's support routines for Glulx,
where it was intended as a stub to pass to the Glulx <code class="display"><span class="extract">Glulx_PrintAnything</span></code> routine
(which I7 does not use). In I7, however, it's also used as the default
printing routine for new kinds of value.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">DecimalNumber</span><span class="plain"> </span><span class="identifier">num</span><span class="plain">; </span><span class="reserved">print</span><span class="plain"> </span><span class="identifier">num</span><span class="plain">; ];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6. Print Text. </b>The routine for printing an I7 "text" value, which might be text with or
without substitutions.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">PrintI6Text</span><span class="plain"> </span><span class="identifier">x</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">x</span><span class="plain"> </span><span class="reserved">ofclass</span><span class="plain"> </span><span class="identifier">String</span><span class="plain">) </span><span class="reserved">print</span><span class="plain"> (</span><span class="reserved">string</span><span class="plain">) </span><span class="identifier">x</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">x</span><span class="plain"> </span><span class="reserved">ofclass</span><span class="plain"> </span><span class="identifier">Routine</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> (</span><span class="identifier">x</span><span class="plain">)();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">x</span><span class="plain"> == </span><span class="identifier">EMPTY_TEXT_PACKED</span><span class="plain">) </span><span class="reserved">rfalse</span><span class="plain">;</span>
        <span class="reserved">rtrue</span><span class="plain">;</span>
    <span class="plain">];</span>
    <span class="plain">[ </span><span class="identifier">I7_String</span><span class="plain"> </span><span class="identifier">x</span><span class="plain">; </span><span class="identifier">TEXT_TY_Say</span><span class="plain">(</span><span class="identifier">x</span><span class="plain">); ]; </span><span class="comment">! An alternative name now used only by extensions</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7. Properties. </b>Some either/or properties are compiled to I6 attributes, which must be
predeclared, so we do that first. (All other properties can simply be
used without declaration.)
</p>

<p class="inwebparagraph">What then follows is a table of property metadata: in particular, specifying
which properties can be used with which I6 classes or objects. Policing
this at run-time costs a little speed, but traps many errors of programming,
and keeps everything typesafe. It is the price we pay for the relatively
lenient compile-time checking of I7's "object" kind of value. To make
it as efficient as possible, we calculate offsets into the metadata: this
has to be done (once) at run-time, with the routine compiled.
</p>


<pre class="display">
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">attributed_property_offsets_SIZE</span><span class="plain"> </span><span class="constant">48</span><span class="plain">;</span>
    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">attributed_property_offsets</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="identifier">attributed_property_offsets_SIZE</span><span class="plain">;</span>
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">valued_property_offsets_SIZE</span><span class="plain"> (100 + </span><span class="identifier">CCOUNT_PROPERTY</span><span class="plain"> + </span><span class="identifier">INDIV_PROP_START</span><span class="plain">-48);</span>
    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">valued_property_offsets</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="identifier">valued_property_offsets_SIZE</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8. Print Or Run. </b>This utility remains from the old I6 library: it essentially treats a
property as textual and prints it where possible. Where the <code class="display"><span class="extract">no_break</span></code>
flag is set, we expect the text to form only a small part of a paragraph,
and it's inappropriate to break here: for instance, for printing the
"printed name" of an object. Where the flag is clear, however, the text
is expected to form its own paragraph.
</p>

<p class="inwebparagraph">Where <code class="display"><span class="extract">PrintOrRun</span></code> is used in breaking mode, which is only for a very few
properties in I7 (indeed at present only <code class="display"><span class="extract">initial</span></code> and <code class="display"><span class="extract">description</span></code>),
the routine called is given the chance to decide whether to print or not.
It should return <code class="display"><span class="extract">true</span></code> or <code class="display"><span class="extract">false</span></code> according to whether it did so; this
allows us to divide the paragraph or not accordingly.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">PrintOrRun</span><span class="plain"> </span><span class="identifier">obj</span><span class="plain"> </span><span class="identifier">prop</span><span class="plain"> </span><span class="identifier">no_break</span><span class="plain">  </span><span class="identifier">pv</span><span class="plain"> </span><span class="identifier">st</span><span class="plain"> </span><span class="identifier">routine_return_value</span><span class="plain">;</span>
        <span class="plain">@</span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">self</span><span class="plain">; </span><span class="identifier">self</span><span class="plain"> = </span><span class="identifier">obj</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">prop</span><span class="plain"> == </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="reserved">print</span><span class="plain"> (</span><span class="identifier">name</span><span class="plain">) </span><span class="identifier">prop</span><span class="plain">; </span><span class="identifier">routine_return_value</span><span class="plain"> = </span><span class="reserved">true</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">routine_return_value</span><span class="plain"> = </span><span class="identifier">TEXT_TY_Say</span><span class="plain">(</span><span class="identifier">obj</span><span class="plain">.</span><span class="identifier">prop</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="plain">@</span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">self</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">routine_return_value</span><span class="plain">) {</span>
            <span class="identifier">say__p</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no_break</span><span class="plain"> == </span><span class="reserved">false</span><span class="plain">) {</span>
                <span class="reserved">new_line</span><span class="plain">;</span>
                <span class="identifier">DivideParagraphPoint</span><span class="plain">();</span>
            <span class="plain">}</span>
        <span class="plain">}</span>

        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">routine_return_value</span><span class="plain">;</span>
    <span class="plain">];</span>

    <span class="plain">[ </span><span class="identifier">DA_Number</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">; </span><span class="reserved">print</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">; ];</span>
    <span class="plain">[ </span><span class="identifier">DA_TruthState</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain">==0) </span><span class="reserved">print</span><span class="plain"> </span><span class="string">"false"</span><span class="plain">; </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">print</span><span class="plain"> </span><span class="string">"true"</span><span class="plain">; ];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9. Saying Phrases. </b></p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">SayPhraseName</span><span class="plain"> </span><span class="identifier">closure</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">closure</span><span class="plain"> == </span><span class="constant">0</span><span class="plain">) </span><span class="reserved">print</span><span class="plain"> </span><span class="string">"nothing"</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">print</span><span class="plain"> (</span><span class="reserved">string</span><span class="plain">) </span><span class="identifier">closure</span><span class="plain">--&gt;2;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10. Kinds. </b></p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">KindAtomic</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">kind</span><span class="plain"> &gt;= </span><span class="constant">0</span><span class="plain">) &amp;&amp; (</span><span class="identifier">kind</span><span class="plain"> &lt; </span><span class="identifier">BASE_KIND_HWM</span><span class="plain">)) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain">--&gt;0;</span>
    <span class="plain">];</span>

    <span class="plain">[ </span><span class="identifier">KindBaseArity</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">kind</span><span class="plain"> &gt;= </span><span class="constant">0</span><span class="plain">) &amp;&amp; (</span><span class="identifier">kind</span><span class="plain"> &lt; </span><span class="identifier">BASE_KIND_HWM</span><span class="plain">)) </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">0</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain">--&gt;1;</span>
    <span class="plain">];</span>

    <span class="plain">[ </span><span class="identifier">KindBaseTerm</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">kind</span><span class="plain"> &gt;= </span><span class="constant">0</span><span class="plain">) &amp;&amp; (</span><span class="identifier">kind</span><span class="plain"> &lt; </span><span class="identifier">BASE_KIND_HWM</span><span class="plain">)) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">UNKNOWN_TY</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain">--&gt;(2+</span><span class="identifier">n</span><span class="plain">);</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP11"></a><b>&#167;11. GenerateRandomNumber. </b>The following uses the virtual machine's RNG (via the I6 built-in function
<code class="display"><span class="extract">random</span></code>) to produce a uniformly random integer in the range n to m
inclusive, where n and m are allowed to be either way around; so that
a random number between 17 and 4 is the same thing as a random number
between 4 and 17, and there is therefore no pair of n and m corresponding
to an empty range of values.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">GenerateRandomNumber</span><span class="plain"> </span><span class="identifier">n</span><span class="plain"> </span><span class="identifier">m</span><span class="plain"> </span><span class="identifier">s</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain">==</span><span class="identifier">m</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain">&gt;</span><span class="identifier">m</span><span class="plain">) { </span><span class="identifier">s</span><span class="plain"> = </span><span class="identifier">n</span><span class="plain">; </span><span class="identifier">n</span><span class="plain"> = </span><span class="identifier">m</span><span class="plain">; </span><span class="identifier">m</span><span class="plain"> = </span><span class="identifier">s</span><span class="plain">; }</span>
        <span class="identifier">n</span><span class="plain">--;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="reserved">random</span><span class="plain">(</span><span class="identifier">m</span><span class="plain">-</span><span class="identifier">n</span><span class="plain">) + </span><span class="identifier">n</span><span class="plain">;</span>
    <span class="plain">];</span>
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">R_DecimalNumber</span><span class="plain"> = </span><span class="identifier">GenerateRandomNumber</span><span class="plain">;</span>
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">R_PrintTimeOfDay</span><span class="plain"> = </span><span class="identifier">GenerateRandomNumber</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP12"></a><b>&#167;12. PrintSpaces. </b>Which prints a row of n spaces, for n&gt;= 0.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">PrintSpaces</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">;</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="reserved">print</span><span class="plain"> </span><span class="string">" "</span><span class="plain">;</span>
            <span class="identifier">n</span><span class="plain"> = </span><span class="identifier">n</span><span class="plain"> </span><span class="constant">-</span><span class="plain"> </span><span class="constant">1</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP13"></a><b>&#167;13. SwapWorkflags. </b>Recall that we have two general-purpose temporary attributes for each object:
<code class="display"><span class="extract">workflag</span></code> and <code class="display"><span class="extract">workflag2</span></code>. The following swaps their values over for every
object at once.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">SwapWorkflags</span><span class="plain"> </span><span class="identifier">obj</span><span class="plain"> </span><span class="identifier">lst</span><span class="plain">;</span>
        <span class="reserved">objectloop</span><span class="plain"> (</span><span class="identifier">obj</span><span class="plain"> </span><span class="reserved">ofclass</span><span class="plain"> </span><span class="identifier">Object</span><span class="plain">) {</span>
            <span class="identifier">lst</span><span class="plain"> = </span><span class="reserved">false</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">obj</span><span class="plain"> </span><span class="reserved">has</span><span class="plain"> </span><span class="identifier">workflag2</span><span class="plain">) </span><span class="identifier">lst</span><span class="plain"> = </span><span class="reserved">true</span><span class="plain">;</span>
            <span class="reserved">give</span><span class="plain"> </span><span class="identifier">obj</span><span class="plain"> ~</span><span class="identifier">workflag2</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">obj</span><span class="plain"> </span><span class="reserved">has</span><span class="plain"> </span><span class="identifier">workflag</span><span class="plain">) </span><span class="reserved">give</span><span class="plain"> </span><span class="identifier">obj</span><span class="plain"> </span><span class="identifier">workflag2</span><span class="plain">;</span>
            <span class="reserved">give</span><span class="plain"> </span><span class="identifier">obj</span><span class="plain"> ~</span><span class="identifier">workflag</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">lst</span><span class="plain">) </span><span class="reserved">give</span><span class="plain"> </span><span class="identifier">obj</span><span class="plain"> </span><span class="identifier">workflag</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP14"></a><b>&#167;14. TestUseOption. </b>This routine, compiled by NI, returns <code class="display"><span class="extract">true</span></code> if the supplied argument is the
number of a use option in force for the current run of NI, and <code class="display"><span class="extract">false</span></code>
otherwise.
</p>

<p class="inwebparagraph"><a id="SP15"></a><b>&#167;15. ZRegion. </b>I7 contains many relics from I6, but here's a relic from I5: a routine which
used to determine the metaclass of a value, before that concept was given a
name. In I6 code, it can be implemented simply using <code class="display"><span class="extract">metaclass</span></code>, as the
following shows. (The name is from "region of the Z-machine".)
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">ZRegion</span><span class="plain"> </span><span class="identifier">addr</span><span class="plain">;</span>
        <span class="reserved">switch</span><span class="plain"> (</span><span class="reserved">metaclass</span><span class="plain">(</span><span class="identifier">addr</span><span class="plain">)) {</span>
            <span class="reserved">nothing</span><span class="plain">: </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">0</span><span class="plain">;</span>
            <span class="identifier">Object</span><span class="plain">, </span><span class="identifier">Class</span><span class="plain">: </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">1</span><span class="plain">;</span>
            <span class="identifier">Routine</span><span class="plain">: </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">2</span><span class="plain">;</span>
            <span class="identifier">String</span><span class="plain">: </span><span class="reserved">return</span><span class="plain"> </span><span class="constant">3</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP16"></a><b>&#167;16. Memcpy. </b>This is equivalent to C's memcpy function, in good ways and bad.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">Memcpy</span><span class="plain"> </span><span class="identifier">to_addr</span><span class="plain"> </span><span class="identifier">from_addr</span><span class="plain"> </span><span class="identifier">size</span><span class="plain">  </span><span class="identifier">n</span><span class="plain">;</span>
    <span class="plain">#</span><span class="identifier">Ifdef</span><span class="plain"> </span><span class="identifier">TARGET_ZCODE</span><span class="plain">;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain"> = </span><span class="identifier">size</span><span class="plain">/</span><span class="identifier">WORDSIZE</span><span class="plain">: (</span><span class="identifier">n</span><span class="plain">--) &gt; </span><span class="constant">0</span><span class="plain">: ) </span><span class="identifier">to_addr</span><span class="plain">--&gt;</span><span class="identifier">n</span><span class="plain"> = </span><span class="identifier">from_addr</span><span class="plain">--&gt;</span><span class="identifier">n</span><span class="plain">;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain"> = </span><span class="identifier">size</span><span class="plain">: ((</span><span class="identifier">n</span><span class="plain">--) % </span><span class="identifier">WORDSIZE</span><span class="plain"> ~= </span><span class="constant">0</span><span class="plain">): ) </span><span class="identifier">to_addr</span><span class="plain">-&gt;</span><span class="identifier">n</span><span class="plain"> = </span><span class="identifier">from_addr</span><span class="plain">-&gt;</span><span class="identifier">n</span><span class="plain">;</span>
    <span class="plain">#</span><span class="identifier">Ifnot</span><span class="plain">; </span><span class="comment">! TARGET_GLULX</span>
        <span class="plain">@</span><span class="identifier">mcopy</span><span class="plain"> </span><span class="identifier">size</span><span class="plain"> </span><span class="identifier">from_addr</span><span class="plain"> </span><span class="identifier">to_addr</span><span class="plain">;</span>
    <span class="plain">#</span><span class="identifier">Endif</span><span class="plain">; </span><span class="comment">! TARGET_</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP17"></a><b>&#167;17. Arrcpy. </b>This is not quite so efficient, but not terrible.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">Arrcpy</span><span class="plain"> </span><span class="identifier">to_array</span><span class="plain"> </span><span class="identifier">to_entry_size</span><span class="plain"> </span><span class="identifier">from_array</span><span class="plain"> </span><span class="identifier">from_entry_size</span><span class="plain"> </span><span class="identifier">no_entries</span><span class="plain">  </span><span class="identifier">n</span><span class="plain"> </span><span class="identifier">val</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">to_entry_size</span><span class="plain"> == </span><span class="identifier">from_entry_size</span><span class="plain">)</span>
            <span class="identifier">Memcpy</span><span class="plain">(</span><span class="identifier">to_array</span><span class="plain">, </span><span class="identifier">from_array</span><span class="plain">, </span><span class="identifier">to_entry_size</span><span class="plain">*</span><span class="identifier">no_entries</span><span class="plain">);</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">to_entry_size</span><span class="plain"> == </span><span class="constant">2</span><span class="plain">) &amp;&amp; (</span><span class="identifier">from_entry_size</span><span class="plain"> == </span><span class="constant">4</span><span class="plain">)) {</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">: </span><span class="identifier">n</span><span class="plain">&lt;</span><span class="identifier">no_entries</span><span class="plain">: </span><span class="identifier">n</span><span class="plain">++) {</span>
                <span class="identifier">val</span><span class="plain"> = </span><span class="identifier">from_array</span><span class="plain">--&gt;</span><span class="identifier">n</span><span class="plain">;</span>
                <span class="identifier">to_array</span><span class="plain">-&gt;0 = (</span><span class="identifier">val</span><span class="plain">/256)%256; </span><span class="identifier">to_array</span><span class="plain">-&gt;1 = </span><span class="identifier">val</span><span class="plain">%256;</span>
                <span class="identifier">to_array</span><span class="plain"> = </span><span class="identifier">to_array</span><span class="plain"> + </span><span class="constant">2</span><span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="string">"*** Arrcpy doesn't support this ***"</span><span class="plain">;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP18"></a><b>&#167;18. Verbs as Values. </b></p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">PrintVerbAsValue</span><span class="plain"> </span><span class="identifier">vb</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">vb</span><span class="plain"> == </span><span class="constant">0</span><span class="plain">) </span><span class="reserved">print</span><span class="plain"> </span><span class="string">"(no verb)"</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> { </span><span class="reserved">print</span><span class="plain"> </span><span class="string">"verb "</span><span class="plain">; </span><span class="identifier">vb</span><span class="plain">(1); }</span>
    <span class="plain">];</span>

    <span class="plain">[ </span><span class="identifier">VerbIsMeaningful</span><span class="plain"> </span><span class="identifier">vb</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">vb</span><span class="plain">) &amp;&amp; (</span><span class="identifier">BlkValueCompare</span><span class="plain">(</span><span class="identifier">vb</span><span class="plain">(</span><span class="identifier">CV_MEANING</span><span class="plain">), </span><span class="identifier">MEANINGLESS_RR</span><span class="plain">) ~= </span><span class="constant">0</span><span class="plain">)) </span><span class="reserved">rtrue</span><span class="plain">;</span>
        <span class="reserved">rfalse</span><span class="plain">;</span>
    <span class="plain">];</span>

    <span class="plain">[ </span><span class="identifier">VerbIsModal</span><span class="plain"> </span><span class="identifier">vb</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">vb</span><span class="plain">) &amp;&amp; (</span><span class="identifier">vb</span><span class="plain">(</span><span class="identifier">CV_MODAL</span><span class="plain">))) </span><span class="reserved">rtrue</span><span class="plain">;</span>
        <span class="reserved">rfalse</span><span class="plain">;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP19"></a><b>&#167;19. Seed Random Number Generator Rule. </b>Unless a seed is provided by NI, and it won't be for released story files,
the VM's interpreter is supposed to start up with a good seed in its random
number generator: something usually derived from, say, the milliseconds part
of the current time of day, which is unlikely to repeat or show any pattern
in real-world use. However, early Z-machine interpreters often did this quite
badly, starting with poor seed values which meant that the first few random
numbers always had something in common (being fairly small in their range,
for instance). To obviate this we extract and throw away 100 random numbers
to get the generator going, shaking out more obvious early patterns, but
that cannot really help much if the VM interpreter's RNG is badly written.
"Anyone who considers arithmetical methods of producing random digits is,
of course, in a state of sin" (von Neumann).
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">SEED_RANDOM_NUMBER_GENERATOR_R</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">RNG_SEED_AT_START_OF_PLAY</span><span class="plain">) </span><span class="identifier">VM_Seed_RNG</span><span class="plain">(</span><span class="identifier">RNG_SEED_AT_START_OF_PLAY</span><span class="plain">);</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">=1: </span><span class="identifier">i</span><span class="plain">&lt;=100: </span><span class="identifier">i</span><span class="plain">++) </span><span class="reserved">random</span><span class="plain">(</span><span class="identifier">i</span><span class="plain">);</span>
        <span class="reserved">rfalse</span><span class="plain">;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP20"></a><b>&#167;20. Extracting Verb Numbers. </b>A long tale of woe lies behind the following. Infocom games stored verb numbers
in a single byte in dictionary entries, but they did so counting downwards, so
that verb number 0 was stored as 255, 1 as 254, and so on. Inform followed
suit so that debugging of Inform 1 could be aided by using the then-available
tools for dumping dictionaries from Infocom story files; by using the Infocom
format for dictionary tables, Inform's life was easier.
</p>

<p class="inwebparagraph">But there was an implicit restriction there of 255 distinct verbs (not 256
since not all words were verbs). When Glulx raised almost all of the Z-machine
limits, it made space for 65535 verbs instead of 255, but it appears that
nobody remembered to implement this in I6-for-Glulx and the Glulx form of
the I6 library. This was only put right in March 2009, and the following
routine was added to concentrate lookups of this field in one place.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">DictionaryWordToVerbNum</span><span class="plain"> </span><span class="identifier">dword</span><span class="plain"> </span><span class="identifier">verbnum</span><span class="plain">;</span>
    <span class="plain">#</span><span class="identifier">Ifdef</span><span class="plain"> </span><span class="identifier">TARGET_ZCODE</span><span class="plain">;</span>
        <span class="identifier">verbnum</span><span class="plain"> = </span><span class="constant">$ff-</span><span class="plain">(</span><span class="identifier">dword</span><span class="plain">-&gt;#</span><span class="identifier">dict_par2</span><span class="plain">);</span>
    <span class="plain">#</span><span class="identifier">Ifnot</span><span class="plain">; </span><span class="comment">! GLULX</span>
        <span class="identifier">dword</span><span class="plain"> = </span><span class="identifier">dword</span><span class="plain"> + #</span><span class="identifier">dict_par2</span><span class="plain"> </span><span class="constant">-</span><span class="plain"> </span><span class="constant">1</span><span class="plain">;</span>
        <span class="plain">@</span><span class="identifier">aloads</span><span class="plain"> </span><span class="identifier">dword</span><span class="plain"> </span><span class="constant">0</span><span class="plain"> </span><span class="identifier">verbnum</span><span class="plain">;</span>
        <span class="identifier">verbnum</span><span class="plain"> = </span><span class="constant">$ffff-</span><span class="identifier">verbnum</span><span class="plain">;</span>
    <span class="plain">#</span><span class="identifier">Endif</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">verbnum</span><span class="plain">;</span>
    <span class="plain">];</span>


    <span class="plain">[ </span><span class="identifier">RegardingSingleObject</span><span class="plain"> </span><span class="identifier">obj</span><span class="plain">;</span>
        <span class="identifier">prior_named_list</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>
        <span class="identifier">prior_named_list_gender</span><span class="plain"> = </span><span class="constant">-1</span><span class="plain">;</span>
        <span class="identifier">prior_named_noun</span><span class="plain"> = </span><span class="identifier">obj</span><span class="plain">;</span>
    <span class="plain">];</span>

    <span class="plain">[ </span><span class="identifier">RegardingNumber</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">;</span>
        <span class="identifier">prior_named_list</span><span class="plain"> = </span><span class="identifier">n</span><span class="plain">;</span>
        <span class="identifier">prior_named_list_gender</span><span class="plain"> = </span><span class="constant">-1</span><span class="plain">;</span>
        <span class="identifier">prior_named_noun</span><span class="plain"> = </span><span class="reserved">nothing</span><span class="plain">;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP21"></a><b>&#167;21. Say One Of. </b>These routines are described in the Extensions chapter of the Inform
documentation.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">I7_SOO_PAR</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">count</span><span class="plain"> &lt;= </span><span class="constant">1</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">; </span><span class="reserved">return</span><span class="plain"> </span><span class="reserved">random</span><span class="plain">(</span><span class="identifier">count</span><span class="plain">); ];</span>
    <span class="plain">[ </span><span class="identifier">I7_SOO_RAN</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">v</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">count</span><span class="plain"> &lt;= </span><span class="constant">1</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">;</span>
        <span class="identifier">v</span><span class="plain"> = </span><span class="identifier">oldval</span><span class="plain">; </span><span class="reserved">while</span><span class="plain"> (</span><span class="identifier">v</span><span class="plain"> == </span><span class="identifier">oldval</span><span class="plain">) </span><span class="identifier">v</span><span class="plain"> = </span><span class="reserved">random</span><span class="plain">(</span><span class="identifier">count</span><span class="plain">); </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">v</span><span class="plain">; ];</span>
    <span class="plain">[ </span><span class="identifier">I7_SOO_STI</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">v</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">oldval</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain">; </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">I7_SOO_PAR</span><span class="plain">(</span><span class="identifier">oldval</span><span class="plain">, </span><span class="identifier">count</span><span class="plain">); ];</span>
    <span class="plain">[ </span><span class="identifier">I7_SOO_CYC</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">; </span><span class="identifier">oldval</span><span class="plain">++; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">oldval</span><span class="plain"> &gt; </span><span class="identifier">count</span><span class="plain">) </span><span class="identifier">oldval</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain">; ];</span>
    <span class="plain">[ </span><span class="identifier">I7_SOO_STOP</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">; </span><span class="identifier">oldval</span><span class="plain">++; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">oldval</span><span class="plain"> &gt; </span><span class="identifier">count</span><span class="plain">) </span><span class="identifier">oldval</span><span class="plain"> = </span><span class="identifier">count</span><span class="plain">; </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain">; ];</span>
    <span class="plain">[ </span><span class="identifier">I7_SOO_TAP</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">tn</span><span class="plain"> </span><span class="identifier">rn</span><span class="plain"> </span><span class="identifier">c</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">count</span><span class="plain"> &lt;= </span><span class="constant">1</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">; </span><span class="identifier">tn</span><span class="plain"> = </span><span class="identifier">count</span><span class="plain">*(</span><span class="identifier">count</span><span class="plain">+1)/2;</span>
        <span class="identifier">rn</span><span class="plain"> = </span><span class="reserved">random</span><span class="plain">(</span><span class="identifier">tn</span><span class="plain">); </span><span class="reserved">for</span><span class="plain"> (</span><span class="identifier">c</span><span class="plain">=1:</span><span class="identifier">c</span><span class="plain">&lt;=</span><span class="identifier">count</span><span class="plain">:</span><span class="identifier">c</span><span class="plain">++) { </span><span class="identifier">rn</span><span class="plain"> = </span><span class="identifier">rn</span><span class="plain"> </span><span class="constant">-</span><span class="plain"> </span><span class="identifier">c</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rn</span><span class="plain">&lt;=0) </span><span class="reserved">return</span><span class="plain"> (</span><span class="identifier">count</span><span class="plain">-</span><span class="identifier">c</span><span class="plain">+1); } ];</span>
    <span class="plain">[ </span><span class="identifier">I7_SOO_TRAN</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">oldval</span><span class="plain">&lt;</span><span class="identifier">count</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain">+1;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> + </span><span class="constant">1</span><span class="plain"> + </span><span class="identifier">I7_SOO_RAN</span><span class="plain">(</span><span class="identifier">oldval</span><span class="plain">%(</span><span class="identifier">count</span><span class="plain">+1), </span><span class="identifier">count</span><span class="plain">); ];</span>
    <span class="plain">[ </span><span class="identifier">I7_SOO_TPAR</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain"> </span><span class="identifier">count</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">oldval</span><span class="plain">&lt;</span><span class="identifier">count</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain">+1;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> + </span><span class="constant">1</span><span class="plain"> + </span><span class="identifier">I7_SOO_PAR</span><span class="plain">(</span><span class="identifier">oldval</span><span class="plain">%(</span><span class="identifier">count</span><span class="plain">+1), </span><span class="identifier">count</span><span class="plain">); ];</span>

    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">I7_SOO_SHUF</span><span class="plain">-&gt;32;</span>

    <span class="plain">[ </span><span class="identifier">I7_SOO_SHU</span><span class="plain"> </span><span class="identifier">oldval</span><span class="plain"> </span><span class="identifier">count</span><span class="plain"> </span><span class="identifier">sd</span><span class="plain"> </span><span class="identifier">ct</span><span class="plain"> </span><span class="identifier">v</span><span class="plain"> </span><span class="identifier">i</span><span class="plain"> </span><span class="identifier">j</span><span class="plain"> </span><span class="identifier">s</span><span class="plain"> </span><span class="identifier">ssd</span><span class="plain"> </span><span class="identifier">scope</span><span class="plain"> </span><span class="identifier">cc</span><span class="plain"> </span><span class="identifier">base</span><span class="plain">;</span>
        <span class="identifier">base</span><span class="plain"> = </span><span class="identifier">count</span><span class="plain">+1;</span>
        <span class="identifier">v</span><span class="plain"> = </span><span class="identifier">oldval</span><span class="plain">%</span><span class="identifier">base</span><span class="plain">; </span><span class="identifier">oldval</span><span class="plain"> = </span><span class="identifier">oldval</span><span class="plain">/</span><span class="identifier">base</span><span class="plain">; </span><span class="identifier">ct</span><span class="plain"> = </span><span class="identifier">oldval</span><span class="plain">%</span><span class="identifier">base</span><span class="plain">; </span><span class="identifier">sd</span><span class="plain"> = </span><span class="identifier">oldval</span><span class="plain">/</span><span class="identifier">base</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">count</span><span class="plain"> &gt; </span><span class="constant">32</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">I7_SOO_PAR</span><span class="plain">(</span><span class="identifier">oldval</span><span class="plain">, </span><span class="identifier">count</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">count</span><span class="plain"> &lt;= </span><span class="constant">1</span><span class="plain">) </span><span class="identifier">v</span><span class="plain"> = </span><span class="identifier">count</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> {</span>
            <span class="comment">!print "^In v=", v, " ct=", ct, " sd=", sd, "^";</span>
            <span class="identifier">cc</span><span class="plain"> = </span><span class="identifier">base</span><span class="plain">*</span><span class="identifier">base</span><span class="plain">;</span>
            <span class="identifier">scope</span><span class="plain"> = (</span><span class="identifier">MAX_POSITIVE_NUMBER</span><span class="plain">-1)/</span><span class="identifier">cc</span><span class="plain">;</span>
            <span class="comment">!print "Scope = ", scope, "^";</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sd</span><span class="plain"> == </span><span class="constant">0</span><span class="plain">) { </span><span class="identifier">sd</span><span class="plain"> = </span><span class="reserved">random</span><span class="plain">(</span><span class="identifier">scope</span><span class="plain">); </span><span class="identifier">ct</span><span class="plain">=0; }</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">=0:</span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">count</span><span class="plain">:</span><span class="identifier">i</span><span class="plain">++) </span><span class="identifier">I7_SOO_SHUF</span><span class="plain">-&gt;</span><span class="identifier">i</span><span class="plain"> = </span><span class="identifier">i</span><span class="plain">;</span>
            <span class="identifier">ssd</span><span class="plain"> = </span><span class="identifier">sd</span><span class="plain">;</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">=0:</span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">count</span><span class="plain">-1:</span><span class="identifier">i</span><span class="plain">++) {</span>
                <span class="identifier">j</span><span class="plain"> = (</span><span class="identifier">sd</span><span class="plain">)%(</span><span class="identifier">count</span><span class="plain">-</span><span class="identifier">i</span><span class="plain">)+</span><span class="identifier">i</span><span class="plain">; </span><span class="identifier">sd</span><span class="plain"> = (</span><span class="identifier">sd</span><span class="plain">*31973)+17; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">sd</span><span class="plain">&lt;0) </span><span class="identifier">sd</span><span class="plain">=-</span><span class="identifier">sd</span><span class="plain">;</span>
                <span class="identifier">s</span><span class="plain"> = </span><span class="identifier">I7_SOO_SHUF</span><span class="plain">-&gt;</span><span class="identifier">j</span><span class="plain">; </span><span class="identifier">I7_SOO_SHUF</span><span class="plain">-&gt;</span><span class="identifier">j</span><span class="plain"> = </span><span class="identifier">I7_SOO_SHUF</span><span class="plain">-&gt;</span><span class="identifier">i</span><span class="plain">; </span><span class="identifier">I7_SOO_SHUF</span><span class="plain">-&gt;</span><span class="identifier">i</span><span class="plain"> = </span><span class="identifier">s</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="comment">!for (i=0:i&lt;count:i++) print I7_SOO_SHUF-&gt;i, " "; print "^";</span>
            <span class="identifier">v</span><span class="plain"> = (</span><span class="identifier">I7_SOO_SHUF</span><span class="plain">-&gt;</span><span class="identifier">ct</span><span class="plain">)+1;</span>
            <span class="identifier">ct</span><span class="plain">++; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ct</span><span class="plain"> &gt;= </span><span class="identifier">count</span><span class="plain">) { </span><span class="identifier">ct</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">ssd</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; }</span>
        <span class="plain">}</span>
        <span class="comment">!print "Out v=", v, " ct=", ct, " ssd=", sd, "^";</span>
        <span class="comment">!print "Return ", v + ct*base + ssd*base*base, "^";</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">v</span><span class="plain"> + </span><span class="identifier">ct</span><span class="plain">*</span><span class="identifier">base</span><span class="plain"> + </span><span class="identifier">ssd</span><span class="plain">*</span><span class="identifier">base</span><span class="plain">*</span><span class="identifier">base</span><span class="plain">;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP22"></a><b>&#167;22. Rounding. </b>The following rounds a numerical value <code class="display"><span class="extract">t1</span></code> to the nearest unit of <code class="display"><span class="extract">t2</span></code>;
for instance, if <code class="display"><span class="extract">t2</span></code> is 5 then it rounds to the nearest 5. The name is an
anachronism, as it's used for all kinds of value.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">RoundOffValue</span><span class="plain"> </span><span class="identifier">t1</span><span class="plain"> </span><span class="identifier">t2</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">t1</span><span class="plain"> &gt;= </span><span class="constant">0</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> ((</span><span class="identifier">t1</span><span class="plain">+</span><span class="identifier">t2</span><span class="plain">/2)/</span><span class="identifier">t2</span><span class="plain">)*</span><span class="identifier">t2</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="constant">-</span><span class="plain">((-</span><span class="identifier">t1</span><span class="plain">+</span><span class="identifier">t2</span><span class="plain">/2)/</span><span class="identifier">t2</span><span class="plain">)*</span><span class="identifier">t2</span><span class="plain">;</span>
    <span class="plain">];</span>


</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><a href="S-dt.html">Back to 'Definitions Template'</a></li><li><a href="S-gt.html">Continue with 'Glulx Template'</a></li></ul><hr class="tocbar">
<!--End of weave-->
		</main>
	</body>
</html>

