<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>CSS</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../index.html">
<img src="../docs-src/Figures/Inform.png" height=72">
</a></h1>
<ul><li><a href="../compiler.html">compiler tools</a></li>
<li><a href="../other.html">other tools</a></li>
<li><a href="../extensions.html">extensions and kits</a></li>
<li><a href="../units.html">unit test tools</a></li>
</ul><h2>Other Tools</h2><ul>
<li><a href="../inblorb/index.html">inblorb</a></li>
<li><a href="index.html"><span class="selectedlink">indoc</span></a></li>
<li><a href="../inpolicy/index.html">inpolicy</a></li>
<li><a href="../inrtps/index.html">inrtps</a></li>
</ul><h2>Foundation</h2><ul>
<li><a href="../../../inweb/docs/foundation-module/index.html">foundation</a></li>

</ul>
		</nav>
		<main role="main">
		
<!--Weave of 'CSS' generated by 7-->
<ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="../other.html">Other Tools</a></li><li><a href="index.html">indoc</a></li><li><a href="index.html#2">Chapter 2: Processing</a></li><li><b>CSS</b></li></ul><p class="purpose">Cascading style sheets for HTML output.</p>

<ul class="toc"><li><a href="2-css.html#SP1">&#167;1. Definitions</a></li><li><a href="2-css.html#SP4">&#167;4. Requesting CSS tweaks</a></li><li><a href="2-css.html#SP5">&#167;5. Constructing CSS files</a></li><li><a href="2-css.html#SP8">&#167;8. Verbosity</a></li><li><a href="2-css.html#SP9">&#167;9. Span notations</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Definitions. </b></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>The whole idea of a CSS file is to provide styling independent from content,
and since <code class="display"><span class="extract">indoc</span></code> generates content, it shouldn't meddle with CSS files at
all. It does so for two reasons:
</p>

<p class="inwebparagraph"></p>

<ul class="items"><li>(a) Because the CSS may refer to background images, by URL, and these URLs
depend on the website structure, which may vary according to the instructions
and target chosen. So <code class="display"><span class="extract">indoc</span></code> needs to correct such URLs on the fly. What it
does is to replace the word <code class="display"><span class="extract">IMAGES/</span></code> with the correct relative path, and this
also means that the image name is flagged as one that will be needed by the
resulting website.
</li></ul>
<ul class="items"><li>(b) Because the instructions have requested one or more changes, or "tweaks",
to the CSS to be used on a given volume or volumes. Such instructions are
kept in the following hashes:
</li></ul>
<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">CSS_tweak_data</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">css_style</span><span class="plain">; </span><span class="comment"> the CSS style name to tweak</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">css_tweak</span><span class="plain">; </span><span class="comment"> the instruction</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">css_tweaked</span><span class="plain">; </span><span class="comment"> has this instruction happened yet?</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">css_plus</span><span class="plain">; </span><span class="comment"> 1 for "augment this style", 0 for "replace this style"</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">css_to_be_added</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">within_volume</span><span class="plain">;</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">CSS_tweak_data</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure CSS_tweak_data is private to this section.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>Span notations allow markup such as <code class="display"><span class="extract">this is *dreadful*</span></code> to represent
emphasis; and are also used to mark headwords for indexing, as in
<code class="display"><span class="extract">this is ^{nifty}</span></code>.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_PATTERN_LENGTH</span><span class="plain"> </span><span class="constant">1024</span>
    <span class="definitionkeyword">define</span> <span class="constant">MARKUP_SPP</span><span class="plain"> </span><span class="constant">1</span>
    <span class="definitionkeyword">define</span> <span class="constant">INDEX_TEXT_SPP</span><span class="plain"> </span><span class="constant">2</span>
    <span class="definitionkeyword">define</span> <span class="constant">INDEX_SYMBOLS_SPP</span><span class="plain"> </span><span class="constant">3</span>
</pre>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">span_notation</span><span class="plain"> {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">sp_purpose</span><span class="plain">;							</span><span class="comment"> one of the <code class="display"><span class="extract">*_SPP</span></code> constants</span>
        <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">sp_left</span><span class="plain">[</span><span class="constant">MAX_PATTERN_LENGTH</span><span class="plain">]; 	</span><span class="comment"> wide C string: the start pattern</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">sp_left_len</span><span class="plain">;</span>
        <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">sp_right</span><span class="plain">[</span><span class="constant">MAX_PATTERN_LENGTH</span><span class="plain">];	</span><span class="comment"> wide C string: and end pattern</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">sp_right_len</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">sp_style</span><span class="plain">;</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">span_notation</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure span_notation is accessed in 3/gi and here.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Requesting CSS tweaks. </b>The null volume means "in all volumes".
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::request_css_tweak<button class="popup" onclick="togglePopup('usagePopup86')">...<span class="popuptext" id="usagePopup86">Usage of <b>CSS::request_css_tweak</b>:<br>Instructions - <a href="1-ins.html#SP5_1_3">&#167;5.1.3</a></span></button></span><span class="plain">(</span><span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">style</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">want</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">plus</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">V</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) {</span>
            <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">volume</span><span class="plain">)</span>
                <span class="functiontext"><a href="2-css.html#SP4">CSS::request_css_tweak</a></span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="identifier">style</span><span class="plain">, </span><span class="identifier">want</span><span class="plain">, </span><span class="identifier">plus</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">CSS_tweak_data</span><span class="plain"> *</span><span class="identifier">TD</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">CSS_tweak_data</span><span class="plain">);</span>
            <span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_style</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">style</span><span class="plain">);</span>
            <span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_tweak</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">want</span><span class="plain">);</span>
            <span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_tweaked</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_plus</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>
            <span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_to_be_added</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">within_volume</span><span class="plain"> = </span><span class="identifier">V</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">plus</span><span class="plain"> == </span><span class="constant">2</span><span class="plain">) </span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_to_be_added</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Constructing CSS files. </b>There's one CSS file for each volume.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::write_CSS_files<button class="popup" onclick="togglePopup('usagePopup87')">...<span class="popuptext" id="usagePopup87">Usage of <b>CSS::write_CSS_files</b>:<br>Main - <a href="1-mn.html#SP1_3">&#167;1.3</a></span></button></span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">from</span><span class="plain">) {</span>
        <span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">volume</span><span class="plain">) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">, </span><span class="string">"indoc"</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no_volumes</span><span class="plain"> &gt; </span><span class="constant">1</span><span class="plain">) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">, </span><span class="string">"_%S"</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">-&gt;</span><span class="element">vol_abbrev</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">, </span><span class="string">".css"</span><span class="plain">);</span>
            <span class="identifier">V</span><span class="plain">-&gt;</span><span class="element">vol_CSS_leafname</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">);</span>
            <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/3-fln.html#SP2">Filenames::in</a></span><span class="plain">(</span><span class="identifier">indoc_settings</span><span class="plain">-&gt;</span><span class="element">destination</span><span class="plain">, </span><span class="identifier">leafname</span><span class="plain">);</span>

            <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">CSS_struct</span><span class="plain">;</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = &amp;</span><span class="identifier">CSS_struct</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/2-str.html#SP24">Streams::open_to_file</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/3-em.html#SP2">Errors::fatal_with_file</a></span><span class="plain">(</span><span class="string">"can't write CSS file"</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">indoc_settings</span><span class="plain">-&gt;</span><span class="element">verbose_mode</span><span class="plain">) </span><span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"[Writing %/f]\n"</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">);</span>

            &lt;<span class="cwebmacro">Construct the CSS for this volume</span> <span class="cwebmacronumber">5.1</span>&gt;<span class="plain">;</span>
            &lt;<span class="cwebmacro">Add any missing CSS material to this volume</span> <span class="cwebmacronumber">5.2</span>&gt;<span class="plain">;</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/2-str.html#SP34">Streams::close</a></span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
        <span class="plain">}</span>
        &lt;<span class="cwebmacro">Check that all of the tweaks have had an effect</span> <span class="cwebmacronumber">5.3</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP5_1"></a><b>&#167;5.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Construct the CSS for this volume</span> <span class="cwebmacronumber">5.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">CSS_helper_state</span><span class="plain"> </span><span class="identifier">chs</span><span class="plain">;</span>
        <span class="identifier">chs</span><span class="plain">.</span><span class="element">tx_mode</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">chs</span><span class="plain">.</span><span class="element">this_style</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP2">Str::new</a></span><span class="plain">();</span>
        <span class="identifier">chs</span><span class="plain">.</span><span class="element">this_style_tweaked</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">chs</span><span class="plain">.</span><span class="element">V</span><span class="plain"> = </span><span class="identifier">V</span><span class="plain">;</span>
        <span class="identifier">chs</span><span class="plain">.</span><span class="element">OUT</span><span class="plain"> = </span><span class="identifier">OUT</span><span class="plain">;</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-tf.html#SP5">TextFiles::read</a></span><span class="plain">(</span><span class="identifier">from</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open CSS file model"</span><span class="plain">,</span>
            <span class="constant">TRUE</span><span class="plain">, </span><span class="functiontext"><a href="2-css.html#SP6">CSS::construct_helper</a></span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">chs</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="2-css.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b></p>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">CSS_helper_state</span><span class="plain"> {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">tx_mode</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">this_style</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">this_style_tweaked</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain">;</span>
    <span class="plain">} </span><span class="reserved">CSS_helper_state</span><span class="plain">;</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::construct_helper<button class="popup" onclick="togglePopup('usagePopup88')">...<span class="popuptext" id="usagePopup88">Usage of <b>CSS::construct_helper</b>:<br><a href="2-css.html#SP5_1">&#167;5.1</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">,</span>
        <span class="reserved">void</span><span class="plain"> *</span><span class="identifier">v_chs</span><span class="plain">) {</span>
        <span class="reserved">CSS_helper_state</span><span class="plain"> *</span><span class="identifier">chs</span><span class="plain"> = (</span><span class="reserved">CSS_helper_state</span><span class="plain"> *) </span><span class="identifier">v_chs</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = </span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">OUT</span><span class="plain">;</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP23">Str::trim_white_space_at_end</a></span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">tx_mode</span><span class="plain">) {</span>
            &lt;<span class="cwebmacro">Apply CSS modifications requested by the instructions</span> <span class="cwebmacronumber">6.1</span>&gt;<span class="plain">;</span>
            <span class="functiontext"><a href="2-css.html#SP7">CSS::expand_IMAGES</a></span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S\n"</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(</span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%c*BEGIN%c*"</span><span class="plain">)) </span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">tx_mode</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure CSS_helper_state is accessed in 2/rr, 2/utc and here.</p>

<p class="inwebparagraph"><a id="SP6_1"></a><b>&#167;6.1.  </b>We detect the style opening and closing in a way which wouldn't work for
all CSS files, but here we know that <code class="display"><span class="extract">base.css</span></code> is tidily written.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Apply CSS modifications requested by the instructions</span> <span class="cwebmacronumber">6.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?) *{"</span><span class="plain">))</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">this_style</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0]);</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" *}"</span><span class="plain">)) {</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">this_style</span><span class="plain">); </span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">this_style_tweaked</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">CSS_tweak_data</span><span class="plain"> *</span><span class="identifier">TD</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">, </span><span class="reserved">CSS_tweak_data</span><span class="plain">) {</span>
                <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP18">Str::eq</a></span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_style</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="identifier">this_style</span><span class="plain">)) &amp;&amp; (</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">within_volume</span><span class="plain"> == </span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">V</span><span class="plain">)) {</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">this_style_tweaked</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) </span>&lt;<span class="cwebmacro">Add the new CSS lines supplied</span> <span class="cwebmacronumber">6.1.1</span>&gt;<span class="plain">;</span>
                    &lt;<span class="cwebmacro">Decide whether to keep the original CSS line</span> <span class="cwebmacronumber">6.1.2</span>&gt;<span class="plain">;</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="2-css.html#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_1"></a><b>&#167;6.1.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Add the new CSS lines supplied</span> <span class="cwebmacronumber">6.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">want</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">want</span><span class="plain">, </span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_tweak</span><span class="plain">);</span>
        <span class="functiontext"><a href="2-css.html#SP7">CSS::expand_IMAGES</a></span><span class="plain">(</span><span class="identifier">want</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">want</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">want</span><span class="plain">);</span>
        <span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">this_style_tweaked</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_tweaked</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_plus</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">)</span>
            <span class="functiontext"><a href="2-css.html#SP8">CSS::alert_CSS_change</a></span><span class="plain">(</span><span class="identifier">I</span><span class="string">"Augmenting"</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">this_style</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">V</span><span class="plain">);</span>
        <span class="reserved">else</span>
            <span class="functiontext"><a href="2-css.html#SP8">CSS::alert_CSS_change</a></span><span class="plain">(</span><span class="identifier">I</span><span class="string">"Replacing"</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">this_style</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-&gt;</span><span class="element">V</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="2-css.html#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_2"></a><b>&#167;6.1.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Decide whether to keep the original CSS line</span> <span class="cwebmacronumber">6.1.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">keep</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_plus</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="identifier">keep</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
            <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr2</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr2</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" *(%C+):%c*"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tag</span><span class="plain"> = </span><span class="identifier">mr2</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0];</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP25">Str::includes</a></span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_tweak</span><span class="plain">, </span><span class="identifier">tag</span><span class="plain">)) </span><span class="identifier">keep</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr2</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">keep</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) { </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">; }</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="2-css.html#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP5_2"></a><b>&#167;5.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Add any missing CSS material to this volume</span> <span class="cwebmacronumber">5.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">CSS_tweak_data</span><span class="plain"> *</span><span class="identifier">TD</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">, </span><span class="reserved">CSS_tweak_data</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">within_volume</span><span class="plain"> == </span><span class="identifier">V</span><span class="plain">) &amp;&amp; (</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_tweaked</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) &amp;&amp; (</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_to_be_added</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tag</span><span class="plain"> = </span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_style</span><span class="plain">;</span>
                <span class="functiontext"><a href="2-css.html#SP8">CSS::alert_CSS_change</a></span><span class="plain">(</span><span class="identifier">I</span><span class="string">"Adding"</span><span class="plain">, </span><span class="identifier">tag</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S {\n"</span><span class="plain">, </span><span class="identifier">tag</span><span class="plain">);</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">expanded</span><span class="plain">);</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">expanded</span><span class="plain">, </span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_tweak</span><span class="plain">);</span>
                <span class="functiontext"><a href="2-css.html#SP7">CSS::expand_IMAGES</a></span><span class="plain">(</span><span class="identifier">expanded</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S}\n"</span><span class="plain">, </span><span class="identifier">expanded</span><span class="plain">);</span>
                <span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_tweaked</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="2-css.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP5_3"></a><b>&#167;5.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Check that all of the tweaks have had an effect</span> <span class="cwebmacronumber">5.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">CSS_tweak_data</span><span class="plain"> *</span><span class="identifier">TD</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">, </span><span class="reserved">CSS_tweak_data</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">within_volume</span><span class="plain"> == </span><span class="identifier">V</span><span class="plain">) &amp;&amp; (</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_tweaked</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tag</span><span class="plain"> = </span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_style</span><span class="plain">;</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"CSS modification had no effect: failed to "</span><span class="plain">);</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">TD</span><span class="plain">-&gt;</span><span class="element">css_plus</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"augment"</span><span class="plain">);</span>
                <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"replace"</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">" the style \"%S\""</span><span class="plain">, </span><span class="identifier">tag</span><span class="plain">);</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/3-em.html#SP5">Errors::in_text_file_S</a></span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="2-css.html#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::expand_IMAGES<button class="popup" onclick="togglePopup('usagePopup89')">...<span class="popuptext" id="usagePopup89">Usage of <b>CSS::expand_IMAGES</b>:<br><a href="2-css.html#SP6">&#167;6</a>, <a href="2-css.html#SP6_1_1">&#167;6.1.1</a>, <a href="2-css.html#SP5_2">&#167;5.2</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">text</span><span class="plain">) {</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::create_mr</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">indoc_settings</span><span class="plain">-&gt;</span><span class="element">suppress_fonts</span><span class="plain">) {</span>
            <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?)font-family:(%c*?);(%c*)"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0], *</span><span class="identifier">M</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">, *</span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[2];</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(</span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1], </span><span class="identifier">L</span><span class="string">"%c*monospace%c*"</span><span class="plain">)) </span><span class="identifier">M</span><span class="plain"> = </span><span class="identifier">I</span><span class="string">"___MONOSPACE___"</span><span class="plain">;</span>
                <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="string">"%S%S%S"</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">, </span><span class="identifier">M</span><span class="plain">, </span><span class="identifier">R</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP14">Regexp::replace</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"___MONOSPACE___"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"font-family: monospace;"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP10">Regexp::match</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?)'IMAGES/(%c*?)'(%c*)"</span><span class="plain">)) {</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[0], *</span><span class="identifier">name</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[1], *</span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">mr</span><span class="plain">.</span><span class="element">exp</span><span class="plain">[2];</span>
            <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP15">Str::clear</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="string">"%S'"</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">);</span>
            <span class="functiontext"><a href="2-haj.html#SP4">HTMLUtilities::image_URL</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">name</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="string">"'%S"</span><span class="plain">, </span><span class="identifier">R</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP9">Regexp::dispose_of</a></span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8. Verbosity. </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::alert_CSS_change<button class="popup" onclick="togglePopup('usagePopup90')">...<span class="popuptext" id="usagePopup90">Usage of <b>CSS::alert_CSS_change</b>:<br><a href="2-css.html#SP6_1_1">&#167;6.1.1</a>, <a href="2-css.html#SP5_2">&#167;5.2</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">what</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">this_style</span><span class="plain">, </span><span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">indoc_settings</span><span class="plain">-&gt;</span><span class="element">verbose_mode</span><span class="plain">)</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"%S CSS style \"%S\" in volume \"%S\"\n"</span><span class="plain">, </span><span class="identifier">what</span><span class="plain">, </span><span class="identifier">this_style</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">-&gt;</span><span class="element">vol_title</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9. Span notations. </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::add_span_notation<button class="popup" onclick="togglePopup('usagePopup91')">...<span class="popuptext" id="usagePopup91">Usage of <b>CSS::add_span_notation</b>:<br>Instructions - <a href="1-ins.html#SP5_1_3">&#167;5.1.3</a><br>Contents and Indexes - <a href="3-gi.html#SP1">&#167;1</a>, <a href="3-gi.html#SP4">&#167;4</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">R</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">style</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">purpose</span><span class="plain">) {</span>
        <span class="reserved">span_notation</span><span class="plain"> *</span><span class="identifier">SN</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">span_notation</span><span class="plain">);</span>
        <span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_style</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP3">Str::duplicate</a></span><span class="plain">(</span><span class="identifier">style</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP6">Str::copy_to_wide_string</a></span><span class="plain">(</span><span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_left</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">, </span><span class="constant">MAX_PATTERN_LENGTH</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP6">Str::copy_to_wide_string</a></span><span class="plain">(</span><span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_right</span><span class="plain">, </span><span class="identifier">R</span><span class="plain">, </span><span class="constant">MAX_PATTERN_LENGTH</span><span class="plain">);</span>
        <span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_left_len</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8">Str::len</a></span><span class="plain">(</span><span class="identifier">L</span><span class="plain">);</span>
        <span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_right_len</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8">Str::len</a></span><span class="plain">(</span><span class="identifier">R</span><span class="plain">);</span>
        <span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_purpose</span><span class="plain"> = </span><span class="identifier">purpose</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10.  </b>We have to escape any characters which might be special to our regular
expression parser:
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::make_regex_safe<button class="popup" onclick="togglePopup('usagePopup92')">...<span class="popuptext" id="usagePopup92">Usage of <b>CSS::make_regex_safe</b>:<br>none</span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">text</span><span class="plain">) {</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP14">Regexp::replace</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%%"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP14">Regexp::replace</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%("</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%("</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP14">Regexp::replace</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%)"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%)"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP14">Regexp::replace</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%+"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%+"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP14">Regexp::replace</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%*"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%*"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP14">Regexp::replace</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%?"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%?"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP14">Regexp::replace</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%["</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%["</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-pm.html#SP14">Regexp::replace</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%]"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%]"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP11"></a><b>&#167;11.  </b>The following looks slow, but in fact there's no problem in practice.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::expand_spannotations<button class="popup" onclick="togglePopup('usagePopup93')">...<span class="popuptext" id="usagePopup93">Usage of <b>CSS::expand_spannotations</b>:<br>Rawtext Reader - <a href="2-rr.html#SP4_2">&#167;4.2</a></span></button></span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">text</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">purpose</span><span class="plain">) {</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">changes</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0, </span><span class="identifier">L</span><span class="plain"> = </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP8">Str::len</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">); </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">L</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">claimed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="reserved">span_notation</span><span class="plain"> *</span><span class="identifier">SN</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">SN</span><span class="plain">, </span><span class="reserved">span_notation</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_purpose</span><span class="plain"> == </span><span class="identifier">purpose</span><span class="plain">) {</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP25">Str::includes_wide_string_at</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_left</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">)) {</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">changes</span><span class="plain">++ == </span><span class="constant">0</span><span class="plain">)</span>
                            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">j</span><span class="plain">=0; </span><span class="identifier">j</span><span class="plain">&lt;</span><span class="identifier">i</span><span class="plain">; </span><span class="identifier">j</span><span class="plain">++) </span><span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">j</span><span class="plain">));</span>
                        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">content_from</span><span class="plain"> = </span><span class="identifier">i</span><span class="plain"> + </span><span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_left_len</span><span class="plain">, </span><span class="identifier">content_to</span><span class="plain"> = -1;</span>
                        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">k2</span><span class="plain"> = </span><span class="identifier">content_from</span><span class="plain">; </span><span class="identifier">k2</span><span class="plain">&lt;</span><span class="identifier">L</span><span class="plain">; </span><span class="identifier">k2</span><span class="plain">++)</span>
                            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP25">Str::includes_wide_string_at</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_right</span><span class="plain">, </span><span class="identifier">k2</span><span class="plain">)) {</span>
                                <span class="plain"> </span><span class="identifier">content_to</span><span class="plain"> = </span><span class="identifier">k2</span><span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
                            <span class="plain">}</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">content_to</span><span class="plain"> &gt;= </span><span class="constant">0</span><span class="plain">) {</span>
                            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="string">"___mu___%S___mo___"</span><span class="plain">, </span><span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_style</span><span class="plain">);</span>
                            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">j</span><span class="plain">=</span><span class="identifier">content_from</span><span class="plain">; </span><span class="identifier">j</span><span class="plain">&lt;</span><span class="identifier">content_to</span><span class="plain">; </span><span class="identifier">j</span><span class="plain">++)</span>
                                <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">j</span><span class="plain">));</span>
                            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="string">"___mc___"</span><span class="plain">);</span>
                            <span class="identifier">i</span><span class="plain"> = </span><span class="identifier">content_to</span><span class="plain"> + </span><span class="identifier">SN</span><span class="plain">-&gt;</span><span class="element">sp_right_len</span><span class="plain"> - </span><span class="constant">1</span><span class="plain">;</span>
                        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                            <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">));</span>
                        <span class="plain">}</span>
                        <span class="identifier">claimed</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
                    <span class="plain">}</span>
                <span class="plain">}</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">changes</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) &amp;&amp; (</span><span class="identifier">claimed</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">))</span>
                <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP13">Str::get_at</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">));</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">changes</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) </span><span class="functiontext"><a href="../../../inweb/docs/foundation-module/4-sm.html#SP16">Str::copy</a></span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">modified</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><a href="2-haj.html">Back to 'HTML and JavaScript'</a></li><li><i>(This section ends Chapter 2: Processing.)</i></li></ul><hr class="tocbar">
<!--End of weave-->
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
		</main>
	</body>
</html>

