<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>2/haj</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../webs.html">Sources</a></h1>
<ul>
<li><a href="../compiler.html">compiler</a></li>
<li><a href="../other.html"><b>other tools</b></a></li>
<li><a href="../extensions.html">extensions and kits</a></li>
<li><a href="../units.html">unit test tools</a></li>
</ul>
<h2>Other Tools</h2>
<ul>
<li><a href="../inblorb/index.html">inblorb</a></li>
<li><a href="../indoc/index.html">indoc</a></li>
<li><a href="../inpolicy/index.html">inpolicy</a></li>
<li><a href="../inrtps/index.html">inrtps</a></li>
</ul>
<h2>Foundation</h2>
<ul>
<li><a href="../../../inweb/docs/foundation-module/index.html">foundation</a></li>
</ul>


		</nav>
		<main role="main">
		
<!--Weave of '2/css' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">Source</a></li><li><a href="../other.html">Other Tools</a></li><li><a href="index.html">indoc</a></li><li><a href="index.html#2">Chapter 2: Processing</a></li><li><b>CSS</b></li></ul><p class="purpose">Cascading style sheets for HTML output.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Definitions</a></li><li><a href="#SP4">&#167;4. Requesting CSS tweaks</a></li><li><a href="#SP5">&#167;5. Constructing CSS files</a></li><li><a href="#SP8">&#167;8. Verbosity</a></li><li><a href="#SP9">&#167;9. Span notations</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Definitions. </b></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>The whole idea of a CSS file is to provide styling independent from content,
and since <code class="display"><span class="extract">indoc</span></code> generates content, it shouldn't meddle with CSS files at
all. It does so for two reasons:
</p>

<p class="inwebparagraph"></p>

<ul class="items"><li>(a) Because the CSS may refer to background images, by URL, and these URLs
depend on the website structure, which may vary according to the instructions
and target chosen. So <code class="display"><span class="extract">indoc</span></code> needs to correct such URLs on the fly. What it
does is to replace the word:
</li></ul>

<pre class="display">
        <span class="plain">IMAGES/</span>
</pre>

<p class="inwebparagraph">with the correct relative path, and this also means that the image name is
flagged as one that will be needed by the resulting website.
</p>

<p class="inwebparagraph"></p>

<ul class="items"><li>(b) Because the instructions have requested one or more changes, or "tweaks",
to the CSS to be used on a given volume or volumes. Such instructions are
kept in the following hashes:
</li></ul>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">CSS_tweak_data</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">css_style</span><span class="plain">; </span>    <span class="comment">the CSS style name to tweak</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">css_tweak</span><span class="plain">; </span>    <span class="comment">the instruction</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">css_tweaked</span><span class="plain">; </span>    <span class="comment">has this instruction happened yet?</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">css_plus</span><span class="plain">; </span>    <span class="comment">1 for "augment this style", 0 for "replace this style"</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">css_to_be_added</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">within_volume</span><span class="plain">;</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">CSS_tweak_data</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure CSS_tweak_data is private to this section.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>Span notations allow markup such as <code class="display"><span class="extract">this is *dreadful*</span></code> to represent
emphasis; and are also used to mark headwords for indexing, as in
<code class="display"><span class="extract">this is ^{nifty}</span></code>.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_PATTERN_LENGTH</span><span class="plain"> 1024</span>
    <span class="definitionkeyword">define</span> <span class="constant">MARKUP_SPP</span><span class="plain"> 1</span>
    <span class="definitionkeyword">define</span> <span class="constant">INDEX_TEXT_SPP</span><span class="plain"> 2</span>
    <span class="definitionkeyword">define</span> <span class="constant">INDEX_SYMBOLS_SPP</span><span class="plain"> 3</span>
</pre>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">span_notation</span><span class="plain"> {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">sp_purpose</span><span class="plain">;							</span>    <span class="comment">one of the <code class="display"><span class="extract">*_SPP</span></code> constants</span>
        <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">sp_left</span><span class="plain">[</span><span class="constant">MAX_PATTERN_LENGTH</span><span class="plain">]; 	</span>    <span class="comment">wide C string: the start pattern</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">sp_left_len</span><span class="plain">;</span>
        <span class="identifier">wchar_t</span><span class="plain"> </span><span class="identifier">sp_right</span><span class="plain">[</span><span class="constant">MAX_PATTERN_LENGTH</span><span class="plain">];	</span>    <span class="comment">wide C string: and end pattern</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">sp_right_len</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">sp_style</span><span class="plain">;</span>
        <span class="constant">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">span_notation</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure span_notation is accessed in 3/cai and here.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Requesting CSS tweaks. </b>The null volume means "in all volumes".
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::request_css_tweak</span><span class="plain">(</span><span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">style</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">want</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">plus</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">V</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) {</span>
            <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">volume</span><span class="plain">)</span>
                <span class="functiontext">CSS::request_css_tweak</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="identifier">style</span><span class="plain">, </span><span class="identifier">want</span><span class="plain">, </span><span class="identifier">plus</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">CSS_tweak_data</span><span class="plain"> *</span><span class="identifier">TD</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">CSS_tweak_data</span><span class="plain">);</span>
            <span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_style</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">style</span><span class="plain">);</span>
            <span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_tweak</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">want</span><span class="plain">);</span>
            <span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_tweaked</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_plus</span><span class="plain"> = 1;</span>
            <span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_to_be_added</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;within_volume</span><span class="plain"> = </span><span class="identifier">V</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">plus</span><span class="plain"> == 2) </span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_to_be_added</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CSS::request_css_tweak is used in 1/ins (<a href="1-ins.html#SP5_1_3">&#167;5.1.3</a>).</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Constructing CSS files. </b>There's one CSS file for each volume.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::write_CSS_files</span><span class="plain">(</span><span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">from</span><span class="plain">) {</span>
        <span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">V</span><span class="plain">, </span><span class="reserved">volume</span><span class="plain">) {</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">, </span><span class="string">"indoc"</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no_volumes</span><span class="plain"> &gt; 1) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">, </span><span class="string">"_%S"</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;vol_abbrev</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">, </span><span class="string">".css"</span><span class="plain">);</span>
            <span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;vol_CSS_leafname</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">leafname</span><span class="plain">);</span>
            <span class="reserved">filename</span><span class="plain"> *</span><span class="identifier">F</span><span class="plain"> = </span><span class="functiontext">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">indoc_settings</span><span class="plain">-</span><span class="element">&gt;destination</span><span class="plain">, </span><span class="identifier">leafname</span><span class="plain">);</span>

            <span class="reserved">text_stream</span><span class="plain"> </span><span class="identifier">CSS_struct</span><span class="plain">;</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = &amp;</span><span class="identifier">CSS_struct</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Streams::open_to_file</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">, </span><span class="constant">UTF8_ENC</span><span class="plain">) == </span><span class="constant">FALSE</span><span class="plain">)</span>
                <span class="functiontext">Errors::fatal_with_file</span><span class="plain">(</span><span class="string">"can't write CSS file"</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">indoc_settings</span><span class="plain">-</span><span class="element">&gt;verbose_mode</span><span class="plain">) </span><span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"[Writing %/f]\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">F</span><span class="plain">);</span>

            &lt;<span class="cwebmacro">Construct the CSS for this volume</span> <span class="cwebmacronumber">5.1</span>&gt;<span class="plain">;</span>
            &lt;<span class="cwebmacro">Add any missing CSS material to this volume</span> <span class="cwebmacronumber">5.2</span>&gt;<span class="plain">;</span>
            <span class="functiontext">Streams::close</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">);</span>
        <span class="plain">}</span>
        &lt;<span class="cwebmacro">Check that all of the tweaks have had an effect</span> <span class="cwebmacronumber">5.3</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CSS::write_CSS_files is used in 1/mn (<a href="1-mn.html#SP1_3">&#167;1.3</a>).</p>

<p class="inwebparagraph"><a id="SP5_1"></a><b>&#167;5.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Construct the CSS for this volume</span> <span class="cwebmacronumber">5.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">CSS_helper_state</span><span class="plain"> </span><span class="identifier">chs</span><span class="plain">;</span>
        <span class="identifier">chs</span><span class="element">.tx_mode</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">chs</span><span class="element">.this_style</span><span class="plain"> = </span><span class="functiontext">Str::new</span><span class="plain">();</span>
        <span class="identifier">chs</span><span class="element">.this_style_tweaked</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="identifier">chs</span><span class="element">.V</span><span class="plain"> = </span><span class="identifier">V</span><span class="plain">;</span>
        <span class="identifier">chs</span><span class="element">.OUT</span><span class="plain"> = </span><span class="identifier">OUT</span><span class="plain">;</span>
        <span class="functiontext">TextFiles::read</span><span class="plain">(</span><span class="identifier">from</span><span class="plain">, </span><span class="constant">FALSE</span><span class="plain">, </span><span class="string">"can't open CSS file model"</span><span class="plain">,</span>
            <span class="constant">TRUE</span><span class="plain">, </span><span class="functiontext">CSS::construct_helper</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, &amp;</span><span class="identifier">chs</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b></p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">CSS_helper_state</span><span class="plain"> {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">tx_mode</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">this_style</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">this_style_tweaked</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain">;</span>
    <span class="plain">} </span><span class="reserved">CSS_helper_state</span><span class="plain">;</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::construct_helper</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">line</span><span class="plain">, </span><span class="reserved">text_file_position</span><span class="plain"> *</span><span class="identifier">tfp</span><span class="plain">,</span>
        <span class="reserved">void</span><span class="plain"> *</span><span class="identifier">v_chs</span><span class="plain">) {</span>
        <span class="reserved">CSS_helper_state</span><span class="plain"> *</span><span class="identifier">chs</span><span class="plain"> = (</span><span class="reserved">CSS_helper_state</span><span class="plain"> *) </span><span class="identifier">v_chs</span><span class="plain">;</span>
        <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">OUT</span><span class="plain"> = </span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;OUT</span><span class="plain">;</span>
        <span class="functiontext">Str::trim_white_space_at_end</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;tx_mode</span><span class="plain">) {</span>
            &lt;<span class="cwebmacro">Apply CSS modifications requested by the instructions</span> <span class="cwebmacronumber">6.1</span>&gt;<span class="plain">;</span>
            <span class="functiontext">CSS::expand_IMAGES</span><span class="plain">(</span><span class="identifier">line</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(</span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%c*BEGIN%c*"</span><span class="plain">)) </span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;tx_mode</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CSS::construct_helper is used in <a href="#SP5_1">&#167;5.1</a>.</p>

<p class="endnote">The structure CSS_helper_state is accessed in 2/rr, 2/utc and here.</p>

<p class="inwebparagraph"><a id="SP6_1"></a><b>&#167;6.1.  </b>We detect the style opening and closing in a way which wouldn't work for
all CSS files, but here we know that <code class="display"><span class="extract">base.css</span></code> is tidily written.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Apply CSS modifications requested by the instructions</span> <span class="cwebmacronumber">6.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?) *{"</span><span class="plain">))</span>
            <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;this_style</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0]);</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" *}"</span><span class="plain">)) {</span>
            <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;this_style</span><span class="plain">); </span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;this_style_tweaked</span><span class="plain"> = 0;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">CSS_tweak_data</span><span class="plain"> *</span><span class="identifier">TD</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">, </span><span class="reserved">CSS_tweak_data</span><span class="plain">) {</span>
                <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">Str::eq</span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_style</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;this_style</span><span class="plain">)) &amp;&amp; (</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;within_volume</span><span class="plain"> == </span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;V</span><span class="plain">)) {</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;this_style_tweaked</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) </span>&lt;<span class="cwebmacro">Add the new CSS lines supplied</span> <span class="cwebmacronumber">6.1.1</span>&gt;<span class="plain">;</span>
                    &lt;<span class="cwebmacro">Decide whether to keep the original CSS line</span> <span class="cwebmacronumber">6.1.2</span>&gt;<span class="plain">;</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_1"></a><b>&#167;6.1.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Add the new CSS lines supplied</span> <span class="cwebmacronumber">6.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">want</span><span class="plain">);</span>
        <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">want</span><span class="plain">, </span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_tweak</span><span class="plain">);</span>
        <span class="functiontext">CSS::expand_IMAGES</span><span class="plain">(</span><span class="identifier">want</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">want</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">want</span><span class="plain">);</span>
        <span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;this_style_tweaked</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_tweaked</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_plus</span><span class="plain"> &gt; 0)</span>
            <span class="functiontext">CSS::alert_CSS_change</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"Augmenting"</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;this_style</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;V</span><span class="plain">);</span>
        <span class="reserved">else</span>
            <span class="functiontext">CSS::alert_CSS_change</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"Replacing"</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;this_style</span><span class="plain">, </span><span class="identifier">chs</span><span class="plain">-</span><span class="element">&gt;V</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP6_1_2"></a><b>&#167;6.1.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Decide whether to keep the original CSS line</span> <span class="cwebmacronumber">6.1.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">keep</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_plus</span><span class="plain"> &gt; 0) {</span>
            <span class="identifier">keep</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
            <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr2</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr2</span><span class="plain">, </span><span class="identifier">line</span><span class="plain">, </span><span class="identifier">L</span><span class="string">" *(%C+):%c*"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tag</span><span class="plain"> = </span><span class="identifier">mr2</span><span class="element">.exp</span><span class="plain">[0];</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::includes</span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_tweak</span><span class="plain">, </span><span class="identifier">tag</span><span class="plain">)) </span><span class="identifier">keep</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr2</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">keep</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) { </span><span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">; }</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_1">&#167;6.1</a>.</p>

<p class="inwebparagraph"><a id="SP5_2"></a><b>&#167;5.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Add any missing CSS material to this volume</span> <span class="cwebmacronumber">5.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">CSS_tweak_data</span><span class="plain"> *</span><span class="identifier">TD</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">, </span><span class="reserved">CSS_tweak_data</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;within_volume</span><span class="plain"> == </span><span class="identifier">V</span><span class="plain">) &amp;&amp; (</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_tweaked</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">) &amp;&amp; (</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_to_be_added</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tag</span><span class="plain"> = </span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_style</span><span class="plain">;</span>
                <span class="functiontext">CSS::alert_CSS_change</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"Adding"</span><span class="plain">, </span><span class="identifier">tag</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S {\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">tag</span><span class="plain">);</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">expanded</span><span class="plain">);</span>
                <span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">expanded</span><span class="plain">, </span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_tweak</span><span class="plain">);</span>
                <span class="functiontext">CSS::expand_IMAGES</span><span class="plain">(</span><span class="identifier">expanded</span><span class="plain">);</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S}\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">expanded</span><span class="plain">);</span>
                <span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_tweaked</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP5_3"></a><b>&#167;5.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Check that all of the tweaks have had an effect</span> <span class="cwebmacronumber">5.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">CSS_tweak_data</span><span class="plain"> *</span><span class="identifier">TD</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">TD</span><span class="plain">, </span><span class="reserved">CSS_tweak_data</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;within_volume</span><span class="plain"> == </span><span class="identifier">V</span><span class="plain">) &amp;&amp; (</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_tweaked</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">tag</span><span class="plain"> = </span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_style</span><span class="plain">;</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"CSS modification had no effect: failed to "</span><span class="plain">);</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">TD</span><span class="plain">-</span><span class="element">&gt;css_plus</span><span class="plain"> &gt; 0) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"augment"</span><span class="plain">);</span>
                <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">"replace"</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="string">" the style \</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">"</span><span class="plain">, </span><span class="identifier">tag</span><span class="plain">);</span>
                <span class="functiontext">Errors::in_text_file_S</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">err</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::expand_IMAGES</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">text</span><span class="plain">) {</span>
        <span class="reserved">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="functiontext">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">indoc_settings</span><span class="plain">-</span><span class="element">&gt;suppress_fonts</span><span class="plain">) {</span>
            <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?)font-family:(%c*?);(%c*)"</span><span class="plain">)) {</span>
                <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0], *</span><span class="identifier">M</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">, *</span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[2];</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(</span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1], </span><span class="identifier">L</span><span class="string">"%c*monospace%c*"</span><span class="plain">)) </span><span class="identifier">M</span><span class="plain"> = </span><span class="identifier">I</span><span class="string">"___MONOSPACE___"</span><span class="plain">;</span>
                <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="string">"%S%S%S"</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">, </span><span class="identifier">M</span><span class="plain">, </span><span class="identifier">R</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="functiontext">Regexp::replace</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"___MONOSPACE___"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"font-family: monospace;"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">while</span><span class="plain"> (</span><span class="functiontext">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c*?)'IMAGES/(%c*?)'(%c*)"</span><span class="plain">)) {</span>
            <span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[0], *</span><span class="identifier">name</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[1], *</span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">mr</span><span class="element">.exp</span><span class="plain">[2];</span>
            <span class="functiontext">Str::clear</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="string">"%S'"</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">);</span>
            <span class="functiontext">HTMLUtilities::image_URL</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">name</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="string">"'%S"</span><span class="plain">, </span><span class="identifier">R</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="functiontext">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CSS::expand_IMAGES is used in <a href="#SP6">&#167;6</a>, <a href="#SP6_1_1">&#167;6.1.1</a>, <a href="#SP5_2">&#167;5.2</a>.</p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8. Verbosity. </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::alert_CSS_change</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">what</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">this_style</span><span class="plain">, </span><span class="reserved">volume</span><span class="plain"> *</span><span class="identifier">V</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">indoc_settings</span><span class="plain">-</span><span class="element">&gt;verbose_mode</span><span class="plain">)</span>
            <span class="identifier">PRINT</span><span class="plain">(</span><span class="string">"%S CSS style \</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string"> in volume \</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">what</span><span class="plain">, </span><span class="identifier">this_style</span><span class="plain">, </span><span class="identifier">V</span><span class="plain">-</span><span class="element">&gt;vol_title</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CSS::alert_CSS_change is used in <a href="#SP6_1_1">&#167;6.1.1</a>, <a href="#SP5_2">&#167;5.2</a>.</p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9. Span notations. </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::add_span_notation</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">R</span><span class="plain">, </span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">style</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">purpose</span><span class="plain">) {</span>
        <span class="reserved">span_notation</span><span class="plain"> *</span><span class="identifier">SN</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">span_notation</span><span class="plain">);</span>
        <span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_style</span><span class="plain"> = </span><span class="functiontext">Str::duplicate</span><span class="plain">(</span><span class="identifier">style</span><span class="plain">);</span>
        <span class="functiontext">Str::copy_to_wide_string</span><span class="plain">(</span><span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_left</span><span class="plain">, </span><span class="identifier">L</span><span class="plain">, </span><span class="constant">MAX_PATTERN_LENGTH</span><span class="plain">);</span>
        <span class="functiontext">Str::copy_to_wide_string</span><span class="plain">(</span><span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_right</span><span class="plain">, </span><span class="identifier">R</span><span class="plain">, </span><span class="constant">MAX_PATTERN_LENGTH</span><span class="plain">);</span>
        <span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_left_len</span><span class="plain"> = </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">L</span><span class="plain">);</span>
        <span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_right_len</span><span class="plain"> = </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">R</span><span class="plain">);</span>
        <span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_purpose</span><span class="plain"> = </span><span class="identifier">purpose</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CSS::add_span_notation is used in 1/ins (<a href="1-ins.html#SP5_1_3">&#167;5.1.3</a>), 3/cai (<a href="3-cai.html#SP1">&#167;1</a>, <a href="3-cai.html#SP4">&#167;4</a>).</p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10.  </b>We have to escape any characters which might be special to our regular
expression parser:
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::make_regex_safe</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">text</span><span class="plain">) {</span>
        <span class="functiontext">Regexp::replace</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%%"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext">Regexp::replace</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%("</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%("</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext">Regexp::replace</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%)"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%)"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext">Regexp::replace</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%+"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%+"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext">Regexp::replace</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%*"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%*"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext">Regexp::replace</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%?"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%?"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext">Regexp::replace</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%["</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%["</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
        <span class="functiontext">Regexp::replace</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%]"</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"%%]"</span><span class="plain">, </span><span class="constant">REP_REPEATING</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CSS::make_regex_safe appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP11"></a><b>&#167;11.  </b>The following looks slow, but in fact there's no problem in practice.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CSS::expand_spannotations</span><span class="plain">(</span><span class="reserved">text_stream</span><span class="plain"> *</span><span class="identifier">text</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">purpose</span><span class="plain">) {</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">changes</span><span class="plain"> = 0;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0, </span><span class="identifier">L</span><span class="plain"> = </span><span class="functiontext">Str::len</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">); </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">L</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">claimed</span><span class="plain"> = </span><span class="constant">FALSE</span><span class="plain">;</span>
            <span class="reserved">span_notation</span><span class="plain"> *</span><span class="identifier">SN</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">SN</span><span class="plain">, </span><span class="reserved">span_notation</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_purpose</span><span class="plain"> == </span><span class="identifier">purpose</span><span class="plain">) {</span>
                    <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::includes_wide_string_at</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_left</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">)) {</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">changes</span><span class="plain">++ == 0)</span>
                            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">j</span><span class="plain">=0; </span><span class="identifier">j</span><span class="plain">&lt;</span><span class="identifier">i</span><span class="plain">; </span><span class="identifier">j</span><span class="plain">++) </span><span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">j</span><span class="plain">));</span>
                        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">content_from</span><span class="plain"> = </span><span class="identifier">i</span><span class="plain"> + </span><span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_left_len</span><span class="plain">, </span><span class="identifier">content_to</span><span class="plain"> = -1;</span>
                        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">k2</span><span class="plain"> = </span><span class="identifier">content_from</span><span class="plain">; </span><span class="identifier">k2</span><span class="plain">&lt;</span><span class="identifier">L</span><span class="plain">; </span><span class="identifier">k2</span><span class="plain">++)</span>
                            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Str::includes_wide_string_at</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_right</span><span class="plain">, </span><span class="identifier">k2</span><span class="plain">)) {</span>
                                <span class="identifier">content_to</span><span class="plain"> = </span><span class="identifier">k2</span><span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
                            <span class="plain">}</span>
                        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">content_to</span><span class="plain"> &gt;= 0) {</span>
                            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="string">"___mu___%S___mo___"</span><span class="plain">, </span><span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_style</span><span class="plain">);</span>
                            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">j</span><span class="plain">=</span><span class="identifier">content_from</span><span class="plain">; </span><span class="identifier">j</span><span class="plain">&lt;</span><span class="identifier">content_to</span><span class="plain">; </span><span class="identifier">j</span><span class="plain">++)</span>
                                <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">j</span><span class="plain">));</span>
                            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="string">"___mc___"</span><span class="plain">);</span>
                            <span class="identifier">i</span><span class="plain"> = </span><span class="identifier">content_to</span><span class="plain"> + </span><span class="identifier">SN</span><span class="plain">-</span><span class="element">&gt;sp_right_len</span><span class="plain"> - 1;</span>
                        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                            <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">));</span>
                        <span class="plain">}</span>
                        <span class="identifier">claimed</span><span class="plain"> = </span><span class="constant">TRUE</span><span class="plain">;</span>
                    <span class="plain">}</span>
                <span class="plain">}</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">changes</span><span class="plain"> &gt; 0) &amp;&amp; (</span><span class="identifier">claimed</span><span class="plain"> == </span><span class="constant">FALSE</span><span class="plain">))</span>
                <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">, </span><span class="functiontext">Str::get_at</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">));</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">changes</span><span class="plain"> &gt; 0) </span><span class="functiontext">Str::copy</span><span class="plain">(</span><span class="identifier">text</span><span class="plain">, </span><span class="identifier">modified</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">modified</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CSS::expand_spannotations is used in 2/rr (<a href="2-rr.html#SP4_2">&#167;4.2</a>).</p>

<hr class="tocbar">
<ul class="toc"><li><a href="2-haj.html">Back to 'HTML and JavaScript'</a></li><li><i>(This section ends Chapter 2: Processing.)</i></li></ul><hr class="tocbar">
<!--End of weave-->
		</main>
	</body>
</html>

