<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>1/im</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../webs.html">Sources</a></h1>
<ul>
<li><a href="../compiler.html"><b>compiler</b></a></li>
<li><a href="../other.html">other tools</a></li>
<li><a href="../extensions.html">extensions and kits</a></li>
<li><a href="../units.html">unit test tools</a></li>
</ul>
<h2>Compiler Webs</h2>
<ul>
<li><a href="../inbuild/index.html">inbuild</a></li>
<li><a href="../inform7/index.html">inform7</a></li>
<li><a href="../inter/index.html">inter</a></li>
</ul>
<h2>Inbuild Modules</h2>
<ul>
<li><a href="../inbuild-module/index.html">inbuild</a></li>
<li><a href="../arch-module/index.html">arch</a></li>
<li><a href="../words-module/index.html">words</a></li>
<li><a href="../syntax-module/index.html">syntax</a></li>
<li><a href="../html-module/index.html">html</a></li>
</ul>
<h2>Inform7 Modules</h2>
<ul>
<li><a href="../core-module/index.html">core</a></li>
<li><a href="../problems-module/index.html">problems</a></li>
<li><a href="../inflections-module/index.html">inflections</a></li>
<li><a href="../linguistics-module/index.html">linguistics</a></li>
<li><a href="../kinds-module/index.html">kinds</a></li>
<li><a href="../if-module/index.html">if</a></li>
<li><a href="../multimedia-module/index.html">multimedia</a></li>
<li><a href="../index-module/index.html">index</a></li>
</ul>
<h2>Inter Modules</h2>
<ul>
<li><a href="../inter-module/index.html">inter</a></li>
<li><a href="../building-module/index.html">building</a></li>
<li><a href="../codegen-module/index.html">codegen</a></li>
</ul>
<h2>Foundation</h2>
<ul>
<li><a href="../../../inweb/docs/foundation-module/index.html">foundation</a></li>
</ul>


		</nav>
		<main role="main">
		
<!--Weave of '1/ic' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">Source</a></li><li><a href="../compiler.html">Compiler Modules</a></li><li><a href="index.html">inbuild</a></li><li><a href="index.html#1">Chapter 1: Setting Up</a></li><li><b>Inbuild Control</b></li></ul><p class="purpose">The top-level controller through which client tools use this module.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Phases</a></li><li><a href="#SP3">&#167;3. Startup phase</a></li><li><a href="#SP4">&#167;4. Configuration phase</a></li><li><a href="#SP9">&#167;9. The Pretinkering, Tinkering, Nested and Projected phases</a></li><li><a href="#SP11">&#167;11. The Going Operational and Operational phases</a></li><li><a href="#SP12">&#167;12. The nest list</a></li><li><a href="#SP17">&#167;17. The shared project</a></li><li><a href="#SP22">&#167;22. Kit requests</a></li><li><a href="#SP23">&#167;23. Access to unmanaged Inform resources</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Phases. </b>The <code class="display"><span class="extract">inbuild</span></code> module provides services to whichever program is using it:
recall that the module is included both in <code class="display"><span class="extract">inform7</span></code> and in <code class="display"><span class="extract">inbuild</span></code> (the
command line tool), so either of those might be what we call "the client".
</p>

<p class="inwebparagraph">This section defines how the client communicates with us to get everything
set up correctly. Although nothing at all clever happens in this code, it
requires careful sequencing to avoid invisible errors coming in because
function X assumes that function Y has already been called, or perhaos that
it never will be again. The <code class="display"><span class="extract">inbuild</span></code> module therefore runs through a
number of named "phases" on its way to reaching fully-operational status,
at which time the client can freely use its facilities.
</p>


<pre class="definitions">
    <span class="definitionkeyword">enum</span> <span class="constant">STARTUP_INBUILD_PHASE</span><span class="definitionkeyword"> from </span><span class="constant">1</span>
    <span class="definitionkeyword">enum</span> <span class="constant">CONFIGURATION_INBUILD_PHASE</span>
    <span class="definitionkeyword">enum</span> <span class="constant">PRETINKERING_INBUILD_PHASE</span>
    <span class="definitionkeyword">enum</span> <span class="constant">TINKERING_INBUILD_PHASE</span>
    <span class="definitionkeyword">enum</span> <span class="constant">NESTED_INBUILD_PHASE</span>
    <span class="definitionkeyword">enum</span> <span class="constant">PROJECTED_INBUILD_PHASE</span>
    <span class="definitionkeyword">enum</span> <span class="constant">TARGETED_INBUILD_PHASE</span>
    <span class="definitionkeyword">enum</span> <span class="constant">GOING_OPERATIONAL_INBUILD_PHASE</span>
    <span class="definitionkeyword">enum</span> <span class="constant">OPERATIONAL_INBUILD_PHASE</span>
</pre>

<pre class="display">
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>We're going to use the following assertions to make sure we don't slip up.
Some functions run only in some phases. Phases can be skipped, but not taken
out of turn.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">inbuild_phase</span><span class="plain"> &lt; </span><span class="identifier">P</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"too soon"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">inbuild_phase</span><span class="plain"> &gt; </span><span class="identifier">P</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"too late"</span><span class="plain">);</span>
    <span class="definitionkeyword">define</span> <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">inbuild_phase</span><span class="plain"> &lt; </span><span class="identifier">P</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"too soon"</span><span class="plain">);</span>
    <span class="definitionkeyword">define</span> <span class="identifier">RUN_ONLY_BEFORE_PHASE</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">inbuild_phase</span><span class="plain"> &gt;= </span><span class="identifier">P</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"too late"</span><span class="plain">);</span>
</pre>

<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="constant">STARTUP_INBUILD_PHASE</span><span class="plain">;</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::enter_phase</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">p</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">p</span><span class="plain"> &lt;= </span><span class="identifier">inbuild_phase</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"phases out of sequence"</span><span class="plain">);</span>
        <span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="identifier">p</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::enter_phase appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. Startup phase. </b>The following is called when the <code class="display"><span class="extract">inbuild</span></code> module starts up.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::startup</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="functiontext">KitManager::start</span><span class="plain">();</span>
        <span class="functiontext">ExtensionManager::start</span><span class="plain">();</span>
        <span class="functiontext">TemplateManager::start</span><span class="plain">();</span>
        <span class="functiontext">LanguageManager::start</span><span class="plain">();</span>
        <span class="functiontext">ProjectBundleManager::start</span><span class="plain">();</span>
        <span class="functiontext">ProjectFileManager::start</span><span class="plain">();</span>
        <span class="functiontext">PipelineManager::start</span><span class="plain">();</span>

        <span class="functiontext">InterSkill::create</span><span class="plain">();</span>
        <span class="functiontext">Inform7Skill::create</span><span class="plain">();</span>
        <span class="functiontext">Inform6Skill::create</span><span class="plain">();</span>
        <span class="functiontext">InblorbSkill::create</span><span class="plain">();</span>

        <span class="functiontext">ControlStructures::create_standard</span><span class="plain">();</span>

        <span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="constant">CONFIGURATION_INBUILD_PHASE</span><span class="plain">;</span>
        <span class="functiontext">Inbuild::set_defaults</span><span class="plain">();</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::startup is used in 1/im (<a href="1-im.html#SP3">&#167;3</a>).</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Configuration phase. </b>Initially, then, we are in the configuration phase. When the client defines
its command-line options, we expect it to call <code class="display"><span class="extract">Inbuild::declare_options</span></code>
so that we can define further options &mdash; this provides the large set of
common options found in both <code class="display"><span class="extract">inform7</span></code> and <code class="display"><span class="extract">inbuild</span></code>, our two possible clients.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::declare_options</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">CONFIGURATION_INBUILD_PHASE</span><span class="plain">)</span>
        &lt;<span class="cwebmacro">Declare Inform-related options</span> <span class="cwebmacronumber">4.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Declare resource-related options</span> <span class="cwebmacronumber">4.4</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Declare Inter-related options</span> <span class="cwebmacronumber">4.6</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::declare_options appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP4_1"></a><b>&#167;4.1.  </b>These options all predate the 2015-20 reworking of the compiler, and their
names are a series of historical accidents. <code class="display"><span class="extract">-format</span></code> in particular works in
a clunky sort of way and should perhaps be deprecated in favour of some
better way to choose a virtual machine to compile to.
</p>


<pre class="definitions">
    <span class="definitionkeyword">enum</span> <span class="constant">INBUILD_INFORM_CLSG</span>
    <span class="definitionkeyword">enum</span> <span class="constant">PROJECT_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">DEBUG_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">RELEASE_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">FORMAT_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">SOURCE_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">CENSUS_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">RNG_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">CASE_CLSW</span>
</pre>
<p class="inwebparagraph"><a id="SP4_2"></a><b>&#167;4.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Declare Inform-related options</span> <span class="cwebmacronumber">4.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">CommandLine::begin_group</span><span class="plain">(</span><span class="constant">INBUILD_INFORM_CLSG</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"for translating Inform source text to Inter"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">PROJECT_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"project"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"work within the Inform project X"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_boolean_switch</span><span class="plain">(</span><span class="constant">DEBUG_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"debug"</span><span class="plain">, 1,</span>
            <span class="identifier">L</span><span class="string">"compile with debugging features even on a Release"</span><span class="plain">, </span><span class="identifier">FALSE</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_boolean_switch</span><span class="plain">(</span><span class="constant">RELEASE_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"release"</span><span class="plain">, 1,</span>
            <span class="identifier">L</span><span class="string">"compile a version suitable for a Release build"</span><span class="plain">, </span><span class="identifier">FALSE</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_textual_switch</span><span class="plain">(</span><span class="constant">FORMAT_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"format"</span><span class="plain">, 1,</span>
            <span class="identifier">L</span><span class="string">"compile I6 code suitable for the virtual machine X"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">SOURCE_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"source"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"use file X as the Inform source text"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_boolean_switch</span><span class="plain">(</span><span class="constant">CENSUS_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"census"</span><span class="plain">, 1,</span>
            <span class="identifier">L</span><span class="string">"perform an extensions census"</span><span class="plain">, </span><span class="identifier">FALSE</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_boolean_switch</span><span class="plain">(</span><span class="constant">RNG_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"rng"</span><span class="plain">, 1,</span>
            <span class="identifier">L</span><span class="string">"fix the random number generator of the story file (for testing)"</span><span class="plain">, </span><span class="identifier">FALSE</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">CASE_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"case"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"make any source links refer to the source in extension example X"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::end_group</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_3"></a><b>&#167;4.3.  </b>Again, except for <code class="display"><span class="extract">-nest</span></code>, these go back to the mid-2010s.
</p>


<pre class="definitions">
    <span class="definitionkeyword">enum</span> <span class="constant">INBUILD_RESOURCES_CLSG</span>
    <span class="definitionkeyword">enum</span> <span class="constant">NEST_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">INTERNAL_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">EXTERNAL_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">TRANSIENT_CLSW</span>
</pre>
<p class="inwebparagraph"><a id="SP4_4"></a><b>&#167;4.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Declare resource-related options</span> <span class="cwebmacronumber">4.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">CommandLine::begin_group</span><span class="plain">(</span><span class="constant">INBUILD_RESOURCES_CLSG</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"for locating resources in the file system"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">NEST_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"nest"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"add the nest at pathname X to the search list"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">INTERNAL_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"internal"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"use X as the location of built-in material such as the Standard Rules"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">EXTERNAL_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"external"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"use X as the user's home for installed material such as extensions"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">TRANSIENT_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"transient"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"use X for transient data such as the extensions census"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::end_group</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_5"></a><b>&#167;4.5.  </b>These are all new in 2020. They are not formally shared with the <code class="display"><span class="extract">inter</span></code> tool,
but <code class="display"><span class="extract">-pipeline-file</span></code> and <code class="display"><span class="extract">-variable</span></code> have the same effect as they would there.
</p>


<pre class="definitions">
    <span class="definitionkeyword">enum</span> <span class="constant">INBUILD_INTER_CLSG</span>
    <span class="definitionkeyword">enum</span> <span class="constant">KIT_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">PIPELINE_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">PIPELINE_FILE_CLSW</span>
    <span class="definitionkeyword">enum</span> <span class="constant">PIPELINE_VARIABLE_CLSW</span>
</pre>
<p class="inwebparagraph"><a id="SP4_6"></a><b>&#167;4.6.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Declare Inter-related options</span> <span class="cwebmacronumber">4.6</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">CommandLine::begin_group</span><span class="plain">(</span><span class="constant">INBUILD_INTER_CLSG</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"for tweaking code generation from Inter"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">KIT_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"kit"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"include Inter code from the kit called X"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">PIPELINE_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"pipeline"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"specify code-generation pipeline by name (default is \</span><span class="plain">"</span><span class="string">compile\</span><span class="plain">"</span><span class="string">)"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">PIPELINE_FILE_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"pipeline-file"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"specify code-generation pipeline as file X"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::declare_switch</span><span class="plain">(</span><span class="constant">PIPELINE_VARIABLE_CLSW</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"variable"</span><span class="plain">, 2,</span>
            <span class="identifier">L</span><span class="string">"set pipeline variable X (in form name=value)"</span><span class="plain">);</span>
        <span class="identifier">CommandLine::end_group</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5.  </b>Use of the above options will cause the following global variables to be
set appropriately.
</p>


<pre class="display">
    <span class="identifier">filename</span><span class="plain"> *</span><span class="identifier">inter_pipeline_file</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="identifier">dictionary</span><span class="plain"> *</span><span class="identifier">pipeline_vars</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">shared_transient_resources</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">this_is_a_debug_compile</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">; </span>    <span class="comment">Destined to be compiled with debug features</span>
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">this_is_a_release_compile</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">; </span>    <span class="comment">Omit sections of source text marked not for release</span>
    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">story_filename_extension</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">; </span>    <span class="comment">What story file we will eventually have</span>
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">census_mode</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">; </span>    <span class="comment">Running only to update extension documentation</span>
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">rng_seed_at_start_of_play</span><span class="plain"> = 0; </span>    <span class="comment">The seed value, or 0 if not seeded</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::set_defaults</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">CONFIGURATION_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">CODEGEN_MODULE</span>
        <span class="identifier">pipeline_vars</span><span class="plain"> = </span><span class="identifier">CodeGen::Pipeline::basic_dictionary</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"output.ulx"</span><span class="plain">);</span>
        <span class="plain">#</span><span class="identifier">endif</span>
        <span class="functiontext">Inbuild::set_inter_pipeline</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"compile"</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::set_defaults is used in <a href="#SP3">&#167;3</a>.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>The pipeline name can be set not only here but also by <code class="display"><span class="extract">inform7</span></code> much
later on (way past the configuration stage), if it reads a sentence like:
</p>

<blockquote>
    <p>Use inter pipeline "special".</p>

</blockquote>


<pre class="display">
    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">inter_pipeline_name</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::set_inter_pipeline</span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">name</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">inter_pipeline_name</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">inter_pipeline_name</span><span class="plain"> = </span><span class="identifier">Str::new</span><span class="plain">();</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">Str::clear</span><span class="plain">(</span><span class="identifier">inter_pipeline_name</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">inter_pipeline_name</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">name</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::set_inter_pipeline is used in <a href="#SP5">&#167;5</a>.</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b><code class="display"><span class="extract">inform7</span></code> needs to know this:
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">Inbuild::currently_releasing</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">this_is_a_release_compile</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::currently_releasing is used in 6/hdn (<a href="6-hdn.html#SP18">&#167;18</a>).</p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8.  </b>The <code class="display"><span class="extract">inbuild</span></code> module itself doesn't parse command-line options: that's for
the client to do, using code from Foundation. When the client finds an option
it doesn't know about, that will be one of ourse, so it should call the following:
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::option</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">id</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">val</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">arg</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">state</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">CONFIGURATION_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">id</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">DEBUG_CLSW</span><span class="plain">: </span><span class="identifier">this_is_a_debug_compile</span><span class="plain"> = </span><span class="identifier">val</span><span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">FORMAT_CLSW</span><span class="plain">: </span><span class="identifier">story_filename_extension</span><span class="plain"> = </span><span class="identifier">Str::duplicate</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">RELEASE_CLSW</span><span class="plain">: </span><span class="identifier">this_is_a_release_compile</span><span class="plain"> = </span><span class="identifier">val</span><span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">NEST_CLSW</span><span class="plain">:</span>
                <span class="functiontext">Inbuild::add_nest</span><span class="plain">(</span><span class="identifier">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">), </span><span class="constant">GENERIC_NEST_TAG</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">INTERNAL_CLSW</span><span class="plain">:</span>
                <span class="functiontext">Inbuild::add_nest</span><span class="plain">(</span><span class="identifier">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">), </span><span class="constant">INTERNAL_NEST_TAG</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">EXTERNAL_CLSW</span><span class="plain">:</span>
                <span class="functiontext">Inbuild::add_nest</span><span class="plain">(</span><span class="identifier">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">), </span><span class="constant">EXTERNAL_NEST_TAG</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">TRANSIENT_CLSW</span><span class="plain">:</span>
                <span class="identifier">shared_transient_resources</span><span class="plain"> = </span><span class="identifier">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">KIT_CLSW</span><span class="plain">: </span><span class="functiontext">Inbuild::request_kit</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">PROJECT_CLSW</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Inbuild::set_I7_bundle</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">) == </span><span class="identifier">FALSE</span><span class="plain">)</span>
                    <span class="identifier">Errors::fatal_with_text</span><span class="plain">(</span><span class="string">"can't specify the project twice: '%S'"</span><span class="plain">, </span><span class="identifier">arg</span><span class="plain">);</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">SOURCE_CLSW</span><span class="plain">:</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Inbuild::set_I7_source</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">) == </span><span class="identifier">FALSE</span><span class="plain">)</span>
                    <span class="identifier">Errors::fatal_with_text</span><span class="plain">(</span><span class="string">"can't specify the source file twice: '%S'"</span><span class="plain">, </span><span class="identifier">arg</span><span class="plain">);</span>
                <span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">CENSUS_CLSW</span><span class="plain">: </span><span class="identifier">census_mode</span><span class="plain"> = </span><span class="identifier">val</span><span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">PIPELINE_CLSW</span><span class="plain">: </span><span class="identifier">inter_pipeline_name</span><span class="plain"> = </span><span class="identifier">Str::duplicate</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">PIPELINE_FILE_CLSW</span><span class="plain">: </span><span class="identifier">inter_pipeline_file</span><span class="plain"> = </span><span class="identifier">Filenames::from_text</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">PIPELINE_VARIABLE_CLSW</span><span class="plain">: </span>&lt;<span class="cwebmacro">Set a pipeline variable</span> <span class="cwebmacronumber">8.1</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">RNG_CLSW</span><span class="plain">: </span>&lt;<span class="cwebmacro">Seed the random number generator</span> <span class="cwebmacronumber">8.2</span>&gt;<span class="plain">; </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">CASE_CLSW</span><span class="plain">: </span><span class="identifier">HTMLFiles::set_source_link_case</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::option appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP8_1"></a><b>&#167;8.1.  </b>Note that the following has no effect unless the <code class="display"><span class="extract">codegen</span></code> module is part
of the client. In practice, that will be true for <code class="display"><span class="extract">inform7</span></code> but not <code class="display"><span class="extract">inbuild</span></code>.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Set a pipeline variable</span> <span class="cwebmacronumber">8.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">match_results</span><span class="plain"> </span><span class="identifier">mr</span><span class="plain"> = </span><span class="identifier">Regexp::create_mr</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Regexp::match</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">, </span><span class="identifier">arg</span><span class="plain">, </span><span class="identifier">L</span><span class="string">"(%c+)=(%c+)"</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::get_first_char</span><span class="plain">(</span><span class="identifier">arg</span><span class="plain">) != </span><span class="character">'*'</span><span class="plain">) {</span>
                <span class="identifier">Errors::fatal</span><span class="plain">(</span><span class="string">"-variable names must begin with '*'"</span><span class="plain">);</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">CODEGEN_MODULE</span>
                <span class="identifier">Str::copy</span><span class="plain">(</span><span class="identifier">Dictionaries::create_text</span><span class="plain">(</span><span class="identifier">pipeline_vars</span><span class="plain">, </span><span class="identifier">mr</span><span class="plain">.</span><span class="identifier">exp</span><span class="plain">[0]), </span><span class="identifier">mr</span><span class="plain">.</span><span class="identifier">exp</span><span class="plain">[1]);</span>
                <span class="plain">#</span><span class="identifier">endif</span>
            <span class="plain">}</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">Errors::fatal</span><span class="plain">(</span><span class="string">"-variable should take the form 'name=value'"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">Regexp::dispose_of</span><span class="plain">(&amp;</span><span class="identifier">mr</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP8_2"></a><b>&#167;8.2.  </b>16339 is a well-known prime number for use in 16-bit random number algorithms,
such as the one used in the Z-machine VM. It works fine in 32-bit cases too.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Seed the random number generator</span> <span class="cwebmacronumber">8.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">val</span><span class="plain">) </span><span class="identifier">rng_seed_at_start_of_play</span><span class="plain"> = -16339;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">rng_seed_at_start_of_play</span><span class="plain"> = 0;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9. The Pretinkering, Tinkering, Nested and Projected phases. </b>Once the tool has finished with the command line, it should call this
function. Inbuild rapidly runs through the next few phases as it does so.
From the "nested" phase, the final list of nests in the search path for
finding kits, extensions and so on exists; from the "projected" phase,
the main Inform project (if there is one) exists.
</p>

<p class="inwebparagraph">Recall that Inbuild does not need to be dealing with an Inform 7 project
as a target, but that if it is, then it is the only such. We call this
the "shared project". There will be lots of other copies known to Inbuild &mdash;
all the kits and extensions needed to build the shared project &mdash; but only
one project.
</p>

<p class="inwebparagraph">The client should set <code class="display"><span class="extract">compile_only</span></code> if it just wants to make a basic,
non-incremental compilation of the project. In practice, <code class="display"><span class="extract">inform7</span></code> wants
that but <code class="display"><span class="extract">inbuild</span></code> does not.
</p>

<p class="inwebparagraph">When this call returns to the client, <code class="display"><span class="extract">inbuild</span></code> is in the Targeted phase,
which continues until the client calls <code class="display"><span class="extract">Inbuild::go_operational</span></code> (see below).
</p>


<pre class="display">
    <span class="reserved">inbuild_copy</span><span class="plain"> *</span><span class="functiontext">Inbuild::optioneering_complete</span><span class="plain">(</span><span class="reserved">inbuild_copy</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">compile_only</span><span class="plain">,</span>
        <span class="reserved">void</span><span class="plain"> (*</span><span class="identifier">preform_callback</span><span class="plain">)(</span><span class="reserved">inform_language</span><span class="plain"> *)) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">CONFIGURATION_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="constant">PRETINKERING_INBUILD_PHASE</span><span class="plain">;</span>

        &lt;<span class="cwebmacro">Find the virtual machine</span> <span class="cwebmacronumber">9.1</span>&gt;<span class="plain">;</span>
        <span class="reserved">inform_project</span><span class="plain"> *</span><span class="identifier">project</span><span class="plain"> = </span><span class="functiontext">Inbuild::create_shared_project</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">);</span>

        <span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="constant">TINKERING_INBUILD_PHASE</span><span class="plain">;</span>
        <span class="functiontext">Inbuild::sort_nest_list</span><span class="plain">();</span>

        <span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="constant">NESTED_INBUILD_PHASE</span><span class="plain">;</span>
        &lt;<span class="cwebmacro">Read the definition of the natural language of syntax</span> <span class="cwebmacronumber">9.2</span>&gt;<span class="plain">;</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">project</span><span class="plain">) {</span>
            <span class="functiontext">Inbuild::pass_kit_requests</span><span class="plain">();</span>
            <span class="functiontext">Copies::read_source_text_for</span><span class="plain">(</span><span class="identifier">project</span><span class="plain">-</span><span class="element">&gt;as_copy</span><span class="plain">);</span>
        <span class="plain">}</span>

        <span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="constant">PROJECTED_INBUILD_PHASE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">project</span><span class="plain">)</span>
            <span class="functiontext">Projects::construct_build_target</span><span class="plain">(</span><span class="identifier">project</span><span class="plain">,</span>
                <span class="functiontext">Inbuild::current_vm</span><span class="plain">(), </span><span class="identifier">this_is_a_release_compile</span><span class="plain">, </span><span class="identifier">compile_only</span><span class="plain">);</span>

        <span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="constant">TARGETED_INBUILD_PHASE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">project</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">project</span><span class="plain">-</span><span class="element">&gt;as_copy</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::optioneering_complete appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP9_1"></a><b>&#167;9.1.  </b>The VM to be used depends on the settings of all three of <code class="display"><span class="extract">-format</span></code>,
<code class="display"><span class="extract">-release</span></code> and <code class="display"><span class="extract">-debug</span></code>, and those can be given in any order at the command
line, which is why we couldn't work this out earlier:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Find the virtual machine</span> <span class="cwebmacronumber">9.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">ext</span><span class="plain"> = </span><span class="identifier">story_filename_extension</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">ext</span><span class="plain">) == 0) </span><span class="identifier">ext</span><span class="plain"> = </span><span class="identifier">I</span><span class="string">"ulx"</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">with_debugging</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">this_is_a_release_compile</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">) || (</span><span class="identifier">this_is_a_debug_compile</span><span class="plain">))</span>
            <span class="identifier">with_debugging</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="functiontext">Inbuild::set_current_vm</span><span class="plain">(</span><span class="identifier">TargetVMs::find</span><span class="plain">(</span><span class="identifier">ext</span><span class="plain">, </span><span class="identifier">with_debugging</span><span class="plain">));</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP9_2"></a><b>&#167;9.2.  </b>The "language of syntax" of a project is the natural language, by default
English, in which its source text is written.
</p>

<p class="inwebparagraph">We scan the available natural languages first. To do that it's sufficient to
generate a list of search results for all possible languages: each as it
comes to light will have been recorded as a possibility. We can then simply
ignore the search results. Note that this can only be done in the Nested
phase or after, because we need the nests in order to perform a search.
</p>

<p class="inwebparagraph">Once that's done, we ask the client to load the Preform grammar for the
language of the project. For now that's always English, but here is where
we would attempt to detect the language of syntax if we could.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Read the definition of the natural language of syntax</span> <span class="cwebmacronumber">9.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">inbuild_requirement</span><span class="plain"> *</span><span class="identifier">req</span><span class="plain"> = </span><span class="functiontext">Requirements::anything_of_genre</span><span class="plain">(</span><span class="identifier">language_genre</span><span class="plain">);</span>
        <span class="identifier">linked_list</span><span class="plain"> *</span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">inbuild_search_result</span><span class="plain">);</span>
        <span class="functiontext">Nests::search_for</span><span class="plain">(</span><span class="identifier">req</span><span class="plain">, </span><span class="functiontext">Inbuild::nest_list</span><span class="plain">(), </span><span class="identifier">L</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">project</span><span class="plain">) {</span>
            <span class="functiontext">Projects::set_to_English</span><span class="plain">(</span><span class="identifier">project</span><span class="plain">);</span>
            <span class="plain">(*</span><span class="identifier">preform_callback</span><span class="plain">)(</span><span class="functiontext">Projects::get_language_of_syntax</span><span class="plain">(</span><span class="identifier">project</span><span class="plain">));</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="plain">(*</span><span class="identifier">preform_callback</span><span class="plain">)(</span><span class="functiontext">Languages::internal_English</span><span class="plain">());</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10.  </b></p>


<pre class="display">
    <span class="identifier">target_vm</span><span class="plain"> *</span><span class="identifier">current_target_VM</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="identifier">target_vm</span><span class="plain"> *</span><span class="functiontext">Inbuild::current_vm</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">TINKERING_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">current_target_VM</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::set_current_vm</span><span class="plain">(</span><span class="identifier">target_vm</span><span class="plain"> *</span><span class="identifier">VM</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">PRETINKERING_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="identifier">current_target_VM</span><span class="plain"> = </span><span class="identifier">VM</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::current_vm is used in <a href="#SP9">&#167;9</a>, 6/hdn (<a href="6-hdn.html#SP14">&#167;14</a>), 6/inc (<a href="6-inc.html#SP6_1">&#167;6.1</a>).</p>

<p class="endnote">The function Inbuild::set_current_vm is used in <a href="#SP9_1">&#167;9.1</a>.</p>

<p class="inwebparagraph"><a id="SP11"></a><b>&#167;11. The Going Operational and Operational phases. </b><code class="display"><span class="extract">inbuild</span></code> is now in the Targeted phase, then, meaning that the client has
called <code class="display"><span class="extract">Inbuild::optioneering_complete</span></code> and has been making further
preparations of its own. (For example, it could attach further kit
dependencies to the shared project.) The client has one further duty to
perform: to call <code class="display"><span class="extract">Inbuild::go_operational</span></code>. After that, everything is ready
for use.
</p>

<p class="inwebparagraph">The brief "going operational" phase is used, for example, to build out
dependency graphs. We do that copy by copy. The shared project, if there is
one, goes first; then everything else known to us.
</p>


<pre class="display">
    <span class="reserved">inform_project</span><span class="plain"> *</span><span class="functiontext">Inbuild::go_operational</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">TARGETED_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="constant">GOING_OPERATIONAL_INBUILD_PHASE</span><span class="plain">;</span>
        <span class="reserved">inform_project</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = </span><span class="functiontext">Inbuild::project</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">P</span><span class="plain">) </span><span class="functiontext">Copies::go_operational</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;as_copy</span><span class="plain">);</span>
        <span class="reserved">inbuild_copy</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">, </span><span class="reserved">inbuild_copy</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">P</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) || (</span><span class="identifier">C</span><span class="plain"> != </span><span class="identifier">P</span><span class="plain">-</span><span class="element">&gt;as_copy</span><span class="plain">))</span>
                <span class="functiontext">Copies::go_operational</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">);</span>
        <span class="identifier">inbuild_phase</span><span class="plain"> = </span><span class="constant">OPERATIONAL_INBUILD_PHASE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">census_mode</span><span class="plain">) </span><span class="functiontext">Extensions::Census::handle_census_mode</span><span class="plain">();</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext">Inbuild::project</span><span class="plain">();</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::go_operational appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP12"></a><b>&#167;12. The nest list. </b>Nests are directories which hold resources to be used by the Intools, and
one of Inbuild's main roles is to search and manage nests. All nests can
hold extensions, kits, language definitions, and so on.
</p>

<p class="inwebparagraph">But among nests three are special, and can hold other things as well.
</p>

<p class="inwebparagraph"></p>

<ul class="items"><li>(a) The "internal" nest is part of the installation of Inform as software.
It contains, for example, the build-in extensions. But it also contains
miscellaneous other files needed by Infomr (see below).
</li></ul>
<ul class="items"><li>(b) The "external" nest is the one to which the user installs her own
selection of extensions, and so on. On most platforms, the external nest
is also the default home of "transient" storage, for more ephemeral content,
such as the mechanically generated extension documentation. Some mobile
operating systems are aggressive about wanting to delete ephemeral files
used by applications, so <code class="display"><span class="extract">-transient</span></code> can be used to divert these.
</li></ul>
<ul class="items"><li>(c) Every project has its own private nest, in the form of its associated
Materials folder. For example, in <code class="display"><span class="extract">Jane Eyre.inform</span></code> is a project, then
alongside it is <code class="display"><span class="extract">Jane Eyre.materials</span></code> and this is a nest.
</li></ul>
<p class="inwebparagraph">Nests used by the Inform and Inbuild tools are tagged with the following
comstamts, except that no nest is ever tagged <code class="display"><span class="extract">NOT_A_NEST_TAG</span></code>.
(There used to be quite a good joke here, but refactoring of the
code removed its premiss. Literate programming is like that sometimes.)
</p>

<p class="inwebparagraph">The sequence of the following enumerated values is significant: lower
origins are better than later ones, when choosing the best result of
a search for resources.
</p>


<pre class="definitions">
    <span class="definitionkeyword">enum</span> <span class="constant">NOT_A_NEST_TAG</span><span class="definitionkeyword"> from </span><span class="constant">0</span>
    <span class="definitionkeyword">enum</span> <span class="constant">MATERIALS_NEST_TAG</span>
    <span class="definitionkeyword">enum</span> <span class="constant">EXTERNAL_NEST_TAG</span>
    <span class="definitionkeyword">enum</span> <span class="constant">GENERIC_NEST_TAG</span>
    <span class="definitionkeyword">enum</span> <span class="constant">INTERNAL_NEST_TAG</span>
</pre>
<p class="inwebparagraph"><a id="SP13"></a><b>&#167;13.  </b>Inform customarily has exactly one <code class="display"><span class="extract">-internal</span></code> and one <code class="display"><span class="extract">-external</span></code> nest,
but in fact any number of each are allowed, including none. However, the
first to be declared are used by the compiler as "the" internal and external
nests, respectively.
</p>

<p class="inwebparagraph">The following hold the nests in declaration order.
</p>


<pre class="display">
    <span class="identifier">linked_list</span><span class="plain"> *</span><span class="identifier">unsorted_nest_list</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="identifier">shared_internal_nest</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="identifier">shared_external_nest</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="identifier">shared_materials_nest</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>

    <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="functiontext">Inbuild::add_nest</span><span class="plain">(</span><span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">tag</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_BEFORE_PHASE</span><span class="plain">(</span><span class="constant">TINKERING_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">unsorted_nest_list</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            <span class="identifier">unsorted_nest_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">inbuild_nest</span><span class="plain">);</span>
        <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="identifier">N</span><span class="plain"> = </span><span class="functiontext">Nests::new</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">);</span>
        <span class="functiontext">Nests::set_tag</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="identifier">tag</span><span class="plain">);</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">inbuild_nest</span><span class="plain">, </span><span class="identifier">unsorted_nest_list</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">tag</span><span class="plain"> == </span><span class="constant">EXTERNAL_NEST_TAG</span><span class="plain">) &amp;&amp; (</span><span class="identifier">shared_external_nest</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">))</span>
            <span class="identifier">shared_external_nest</span><span class="plain"> = </span><span class="identifier">N</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">tag</span><span class="plain"> == </span><span class="constant">INTERNAL_NEST_TAG</span><span class="plain">) &amp;&amp; (</span><span class="identifier">shared_internal_nest</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">))</span>
            <span class="identifier">shared_internal_nest</span><span class="plain"> = </span><span class="identifier">N</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">tag</span><span class="plain"> == </span><span class="constant">INTERNAL_NEST_TAG</span><span class="plain">) </span><span class="functiontext">Nests::protect</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">N</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::add_nest is used in <a href="#SP8">&#167;8</a>, <a href="#SP19_1">&#167;19.1</a>, <a href="#SP19_2">&#167;19.2</a>.</p>

<p class="inwebparagraph"><a id="SP14"></a><b>&#167;14.  </b>It is then sorted in tag order. This is so that if we look for, say, an
extension with a given name, then results in a project's materials folder
are given precedence over those in the external folder, and so on.
</p>


<pre class="display">
    <span class="identifier">linked_list</span><span class="plain"> *</span><span class="identifier">shared_nest_list</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::sort_nest_list</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">TINKERING_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="identifier">shared_nest_list</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="reserved">inbuild_nest</span><span class="plain">);</span>
        <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="identifier">N</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">inbuild_nest</span><span class="plain">, </span><span class="identifier">unsorted_nest_list</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Nests::get_tag</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">) == </span><span class="constant">MATERIALS_NEST_TAG</span><span class="plain">)</span>
                <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">inbuild_nest</span><span class="plain">, </span><span class="identifier">shared_nest_list</span><span class="plain">);</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">inbuild_nest</span><span class="plain">, </span><span class="identifier">unsorted_nest_list</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Nests::get_tag</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">) == </span><span class="constant">EXTERNAL_NEST_TAG</span><span class="plain">)</span>
                <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">inbuild_nest</span><span class="plain">, </span><span class="identifier">shared_nest_list</span><span class="plain">);</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">inbuild_nest</span><span class="plain">, </span><span class="identifier">unsorted_nest_list</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Nests::get_tag</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">) == </span><span class="constant">GENERIC_NEST_TAG</span><span class="plain">)</span>
                <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">inbuild_nest</span><span class="plain">, </span><span class="identifier">shared_nest_list</span><span class="plain">);</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">inbuild_nest</span><span class="plain">, </span><span class="identifier">unsorted_nest_list</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Nests::get_tag</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">) == </span><span class="constant">INTERNAL_NEST_TAG</span><span class="plain">)</span>
                <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">N</span><span class="plain">, </span><span class="reserved">inbuild_nest</span><span class="plain">, </span><span class="identifier">shared_nest_list</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::sort_nest_list is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP15"></a><b>&#167;15.  </b>And the rest of Inform or Inbuild can now use:
</p>


<pre class="display">
    <span class="identifier">linked_list</span><span class="plain"> *</span><span class="functiontext">Inbuild::nest_list</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">NESTED_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">shared_nest_list</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"nest list never sorted"</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">shared_nest_list</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="functiontext">Inbuild::internal</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">NESTED_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">shared_internal_nest</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="functiontext">Inbuild::external</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">NESTED_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">shared_external_nest</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="identifier">pathname</span><span class="plain"> *</span><span class="functiontext">Inbuild::materials</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">NESTED_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">shared_materials_nest</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">shared_materials_nest</span><span class="plain">-</span><span class="element">&gt;location</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="functiontext">Inbuild::materials_nest</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">NESTED_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">shared_materials_nest</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::nest_list is used in <a href="#SP9_2">&#167;9.2</a>, 3/is (<a href="3-is.html#SP1">&#167;1</a>), 5/kts (<a href="5-kts.html#SP1">&#167;1</a>, <a href="5-kts.html#SP2">&#167;2</a>), 5/ed2 (<a href="5-ed2.html#SP4">&#167;4</a>), 5/ec (<a href="5-ec.html#SP1">&#167;1</a>), 5/ps (<a href="5-ps.html#SP1">&#167;1</a>, <a href="5-ps.html#SP3">&#167;3</a>), 6/inc (<a href="6-inc.html#SP6_1">&#167;6.1</a>, <a href="6-inc.html#SP6_1_2">&#167;6.1.2</a>).</p>

<p class="endnote">The function Inbuild::internal is used in <a href="#SP23">&#167;23</a>, 5/ls (<a href="5-ls.html#SP7">&#167;7</a>).</p>

<p class="endnote">The function Inbuild::external is used in 5/ps (<a href="5-ps.html#SP4">&#167;4</a>).</p>

<p class="endnote">The function Inbuild::materials appears nowhere else.</p>

<p class="endnote">The function Inbuild::materials_nest appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP16"></a><b>&#167;16.  </b>As noted above, the transient area is used for ephemera such as dynamically
written documentation and telemetry files. <code class="display"><span class="extract">-transient</span></code> sets it, but otherwise
the external nest is used.
</p>


<pre class="display">
    <span class="identifier">pathname</span><span class="plain"> *</span><span class="functiontext">Inbuild::transient</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">PROJECTED_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">shared_transient_resources</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">shared_external_nest</span><span class="plain">)</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="identifier">shared_external_nest</span><span class="plain">-</span><span class="element">&gt;location</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">shared_transient_resources</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::transient is used in 5/ed (<a href="5-ed.html#SP11">&#167;11</a>), 5/ed2 (<a href="5-ed2.html#SP3">&#167;3</a>), 5/ec (<a href="5-ec.html#SP15">&#167;15</a>), 5/ps (<a href="5-ps.html#SP3">&#167;3</a>).</p>

<p class="inwebparagraph"><a id="SP17"></a><b>&#167;17. The shared project. </b>In any single run, each of the Inform tools concerns itself with a single
Inform 7 program. This can be presented to it either in a project bundle
(a directory which contains source, settings, space for an index and for
temporary build files), or as a single file (just a text file containing
source text).
</p>

<p class="inwebparagraph">It is also possible o set a folder to be the project bundle, and nevertheless
specify a file somewhere else to be the source text. What you can't do is
specify the bundle twice, or specify the file twice.
</p>


<pre class="display">
    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">project_bundle_request</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">project_file_request</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>

    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">Inbuild::set_I7_source</span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">loc</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">CONFIGURATION_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">project_file_request</span><span class="plain">) &gt; 0) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="identifier">project_file_request</span><span class="plain"> = </span><span class="identifier">Str::duplicate</span><span class="plain">(</span><span class="identifier">loc</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">TRUE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::set_I7_source is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP18"></a><b>&#167;18.  </b>If we are given a <code class="display"><span class="extract">-project</span></code> on the command line, we can then work out
where its Materials folder is, and therefore where any expert settings files
would be. Note that the name of the expert settings file depends on the name
of the client, i.e., it will be <code class="display"><span class="extract">inform7-settings.txt</span></code> or <code class="display"><span class="extract">inbuild-settings.txt</span></code>
depending on who's asking.
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">Inbuild::set_I7_bundle</span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">loc</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">CONFIGURATION_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">project_bundle_request</span><span class="plain">) &gt; 0) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="identifier">project_bundle_request</span><span class="plain"> = </span><span class="identifier">Str::duplicate</span><span class="plain">(</span><span class="identifier">loc</span><span class="plain">);</span>
        <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">pathname_of_bundle</span><span class="plain"> = </span><span class="identifier">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">project_bundle_request</span><span class="plain">);</span>
        <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">materials</span><span class="plain"> = </span><span class="functiontext">Inbuild::pathname_of_materials</span><span class="plain">(</span><span class="identifier">pathname_of_bundle</span><span class="plain">);</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">leaf</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">leaf</span><span class="plain">, </span><span class="string">"%s-settings.txt"</span><span class="plain">, </span><span class="identifier">INTOOL_NAME</span><span class="plain">);</span>
        <span class="identifier">filename</span><span class="plain"> *</span><span class="identifier">expert_settings</span><span class="plain"> = </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">materials</span><span class="plain">, </span><span class="identifier">leaf</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">TextFiles::exists</span><span class="plain">(</span><span class="identifier">expert_settings</span><span class="plain">))</span>
            <span class="identifier">CommandLine::also_read_file</span><span class="plain">(</span><span class="identifier">expert_settings</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">leaf</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">TRUE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::set_I7_bundle is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP19"></a><b>&#167;19.  </b>If a bundle is found, then by default the source text within it is called
<code class="display"><span class="extract">story.ni</span></code>. The <code class="display"><span class="extract">.ni</span></code> is an anachronism now, but at one time stood for
"natural Inform", the working title for Inform 7 in the early 2000s.
</p>


<pre class="display">
    <span class="reserved">inform_project</span><span class="plain"> *</span><span class="identifier">shared_project</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>

    <span class="reserved">inform_project</span><span class="plain"> *</span><span class="functiontext">Inbuild::create_shared_project</span><span class="plain">(</span><span class="reserved">inbuild_copy</span><span class="plain"> *</span><span class="identifier">C</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">PRETINKERING_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="identifier">filename</span><span class="plain"> *</span><span class="identifier">filename_of_i7_source</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">pathname_of_bundle</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">project_bundle_request</span><span class="plain">) &gt; 0) {</span>
            <span class="identifier">pathname_of_bundle</span><span class="plain"> = </span><span class="identifier">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">project_bundle_request</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">project_file_request</span><span class="plain">) &gt; 0) {</span>
            <span class="identifier">filename_of_i7_source</span><span class="plain"> = </span><span class="identifier">Filenames::from_text</span><span class="plain">(</span><span class="identifier">project_file_request</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">C</span><span class="plain">) {</span>
            <span class="identifier">pathname_of_bundle</span><span class="plain"> = </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;location_if_path</span><span class="plain">;</span>
            <span class="identifier">filename_of_i7_source</span><span class="plain"> = </span><span class="identifier">C</span><span class="plain">-</span><span class="element">&gt;location_if_file</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">pathname_of_bundle</span><span class="plain">) &amp;&amp; (</span><span class="identifier">filename_of_i7_source</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">))</span>
            <span class="identifier">filename_of_i7_source</span><span class="plain"> =</span>
                <span class="identifier">Filenames::in_folder</span><span class="plain">(</span>
                    <span class="identifier">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">pathname_of_bundle</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Source"</span><span class="plain">),</span>
                    <span class="identifier">I</span><span class="string">"story.ni"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pathname_of_bundle</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">C</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">C</span><span class="plain"> = </span><span class="functiontext">ProjectBundleManager::claim_folder_as_copy</span><span class="plain">(</span><span class="identifier">pathname_of_bundle</span><span class="plain">);</span>
            <span class="identifier">shared_project</span><span class="plain"> = </span><span class="functiontext">ProjectBundleManager::from_copy</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">filename_of_i7_source</span><span class="plain">) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">C</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">C</span><span class="plain"> = </span><span class="functiontext">ProjectFileManager::claim_file_as_copy</span><span class="plain">(</span><span class="identifier">filename_of_i7_source</span><span class="plain">);</span>
            <span class="identifier">shared_project</span><span class="plain"> = </span><span class="functiontext">ProjectFileManager::from_copy</span><span class="plain">(</span><span class="identifier">C</span><span class="plain">);</span>
        <span class="plain">}</span>
        &lt;<span class="cwebmacro">Create the default externals nest</span> <span class="cwebmacronumber">19.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Create the materials nest</span> <span class="cwebmacronumber">19.2</span>&gt;<span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">shared_project</span><span class="plain">) {</span>
            <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = (</span><span class="identifier">shared_materials_nest</span><span class="plain">)?(</span><span class="identifier">shared_materials_nest</span><span class="plain">-</span><span class="element">&gt;location</span><span class="plain">):</span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">P</span><span class="plain">) </span><span class="identifier">P</span><span class="plain"> = </span><span class="identifier">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Source"</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">project_file_request</span><span class="plain">) &gt; 0) </span><span class="identifier">P</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="functiontext">Projects::set_source_filename</span><span class="plain">(</span><span class="identifier">shared_project</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">filename_of_i7_source</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">rng_seed_at_start_of_play</span><span class="plain"> != 0)</span>
                <span class="functiontext">Projects::fix_rng</span><span class="plain">(</span><span class="identifier">shared_project</span><span class="plain">, </span><span class="identifier">rng_seed_at_start_of_play</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">shared_project</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::create_shared_project is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP19_1"></a><b>&#167;19.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Create the default externals nest</span> <span class="cwebmacronumber">19.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="identifier">E</span><span class="plain"> = </span><span class="identifier">shared_external_nest</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">E</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) {</span>
            <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain"> = </span><span class="identifier">home_path</span><span class="plain">;</span>
            <span class="reserved">char</span><span class="plain"> *</span><span class="identifier">subfolder_within</span><span class="plain"> = </span><span class="identifier">INFORM_FOLDER_RELATIVE_TO_HOME</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">subfolder_within</span><span class="plain">[0]) {</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">SF</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">SF</span><span class="plain">, </span><span class="string">"%s"</span><span class="plain">, </span><span class="identifier">subfolder_within</span><span class="plain">);</span>
                <span class="identifier">P</span><span class="plain"> = </span><span class="identifier">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">home_path</span><span class="plain">, </span><span class="identifier">SF</span><span class="plain">);</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">SF</span><span class="plain">);</span>
            <span class="plain">}</span>
            <span class="identifier">P</span><span class="plain"> = </span><span class="identifier">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Inform"</span><span class="plain">);</span>
            <span class="identifier">E</span><span class="plain"> = </span><span class="functiontext">Inbuild::add_nest</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="constant">EXTERNAL_NEST_TAG</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP19">&#167;19</a>.</p>

<p class="inwebparagraph"><a id="SP19_2"></a><b>&#167;19.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Create the materials nest</span> <span class="cwebmacronumber">19.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">materials</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pathname_of_bundle</span><span class="plain">) {</span>
            <span class="identifier">materials</span><span class="plain"> = </span><span class="functiontext">Inbuild::pathname_of_materials</span><span class="plain">(</span><span class="identifier">pathname_of_bundle</span><span class="plain">);</span>
            <span class="identifier">Pathnames::create_in_file_system</span><span class="plain">(</span><span class="identifier">materials</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">filename_of_i7_source</span><span class="plain">) {</span>
            <span class="identifier">materials</span><span class="plain"> = </span><span class="identifier">Pathnames::from_text</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"inform.materials"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">materials</span><span class="plain">) {</span>
            <span class="identifier">shared_materials_nest</span><span class="plain"> = </span><span class="functiontext">Inbuild::add_nest</span><span class="plain">(</span><span class="identifier">materials</span><span class="plain">, </span><span class="constant">MATERIALS_NEST_TAG</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP19">&#167;19</a>.</p>

<p class="inwebparagraph"><a id="SP20"></a><b>&#167;20.  </b>And the rest of Inform or Inbuild can now use:
</p>


<pre class="display">
    <span class="reserved">inform_project</span><span class="plain"> *</span><span class="functiontext">Inbuild::project</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_FROM_PHASE</span><span class="plain">(</span><span class="constant">TINKERING_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">shared_project</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::project is used in <a href="#SP11">&#167;11</a>, 3/is (<a href="3-is.html#SP1">&#167;1</a>), 5/es (<a href="5-es.html#SP5">&#167;5</a>).</p>

<p class="inwebparagraph"><a id="SP21"></a><b>&#167;21.  </b>The materials folder sits alongside the project folder and has the same name,
but ending <code class="display"><span class="extract">.materials</span></code> instead of <code class="display"><span class="extract">.inform</span></code>.
</p>


<pre class="display">
    <span class="identifier">pathname</span><span class="plain"> *</span><span class="functiontext">Inbuild::pathname_of_materials</span><span class="plain">(</span><span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">pathname_of_bundle</span><span class="plain">) {</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">mf</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">mf</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">Pathnames::directory_name</span><span class="plain">(</span><span class="identifier">pathname_of_bundle</span><span class="plain">));</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain"> = </span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">mf</span><span class="plain">)-1;</span>
        <span class="reserved">while</span><span class="plain"> ((</span><span class="identifier">i</span><span class="plain">&gt;0) &amp;&amp; (</span><span class="identifier">Str::get_at</span><span class="plain">(</span><span class="identifier">mf</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">) != </span><span class="character">'.'</span><span class="plain">)) </span><span class="identifier">i</span><span class="plain">--;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">&gt;0) {</span>
            <span class="identifier">Str::truncate</span><span class="plain">(</span><span class="identifier">mf</span><span class="plain">, </span><span class="identifier">i</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">mf</span><span class="plain">, </span><span class="string">".materials"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">materials</span><span class="plain"> = </span><span class="identifier">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">Pathnames::up</span><span class="plain">(</span><span class="identifier">pathname_of_bundle</span><span class="plain">), </span><span class="identifier">mf</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">mf</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">materials</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::pathname_of_materials is used in <a href="#SP18">&#167;18</a>, <a href="#SP19_2">&#167;19.2</a>.</p>

<p class="inwebparagraph"><a id="SP22"></a><b>&#167;22. Kit requests. </b>These are triggered by, for example, <code class="display"><span class="extract">-kit MyFancyKit</span></code> at the command line.
For timing reasons, we store those up in the configuration phase and then
add them as dependencies only when a project exists.
</p>


<pre class="display">
    <span class="identifier">linked_list</span><span class="plain"> *</span><span class="identifier">kits_requested_at_command_line</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::request_kit</span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">name</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">CONFIGURATION_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">kits_requested_at_command_line</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            <span class="identifier">kits_requested_at_command_line</span><span class="plain"> = </span><span class="identifier">NEW_LINKED_LIST</span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain">);</span>
        <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">kit_name</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">kit_name</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain">, </span><span class="identifier">kits_requested_at_command_line</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::eq</span><span class="plain">(</span><span class="identifier">kit_name</span><span class="plain">, </span><span class="identifier">name</span><span class="plain">))</span>
                <span class="reserved">return</span><span class="plain">;</span>
        <span class="identifier">ADD_TO_LINKED_LIST</span><span class="plain">(</span><span class="identifier">Str::duplicate</span><span class="plain">(</span><span class="identifier">name</span><span class="plain">), </span><span class="identifier">text_stream</span><span class="plain">, </span><span class="identifier">kits_requested_at_command_line</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Inbuild::pass_kit_requests</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">RUN_ONLY_IN_PHASE</span><span class="plain">(</span><span class="constant">NESTED_INBUILD_PHASE</span><span class="plain">)</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">shared_project</span><span class="plain">) &amp;&amp; (</span><span class="identifier">kits_requested_at_command_line</span><span class="plain">)) {</span>
            <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">kit_name</span><span class="plain">;</span>
            <span class="identifier">LOOP_OVER_LINKED_LIST</span><span class="plain">(</span><span class="identifier">kit_name</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain">, </span><span class="identifier">kits_requested_at_command_line</span><span class="plain">) {</span>
                <span class="functiontext">Projects::add_kit_dependency</span><span class="plain">(</span><span class="identifier">shared_project</span><span class="plain">, </span><span class="identifier">kit_name</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
                <span class="functiontext">Projects::not_necessarily_parser_IF</span><span class="plain">(</span><span class="identifier">shared_project</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::request_kit is used in <a href="#SP8">&#167;8</a>.</p>

<p class="endnote">The function Inbuild::pass_kit_requests is used in <a href="#SP9">&#167;9</a>.</p>

<p class="inwebparagraph"><a id="SP23"></a><b>&#167;23. Access to unmanaged Inform resources. </b>Inform needs a whole pile of files to have been installed on the host computer
before it can run: everything from the Standard Rules to a PDF file explaining
what interactive fiction is. They're never written to, only read. They are
stored in subdirectories called <code class="display"><span class="extract">Miscellany</span></code> or <code class="display"><span class="extract">HTML</span></code> of the internal nest;
but they're just plain old files, and are not managed by Inbuild as "copies".
</p>

<p class="inwebparagraph">Our client can access these files using the following function:
</p>


<pre class="definitions">
    <span class="definitionkeyword">enum</span> <span class="constant">CBLORB_REPORT_MODEL_IRES</span><span class="definitionkeyword"> from </span><span class="constant">1</span>
    <span class="definitionkeyword">enum</span> <span class="constant">DOCUMENTATION_SNIPPETS_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">INTRO_BOOKLET_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">INTRO_POSTCARD_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">LARGE_DEFAULT_COVER_ART_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">SMALL_DEFAULT_COVER_ART_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">DOCUMENTATION_XREFS_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">JAVASCRIPT_FOR_STANDARD_PAGES_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">JAVASCRIPT_FOR_EXTENSIONS_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">JAVASCRIPT_FOR_ONE_EXTENSION_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">CSS_FOR_STANDARD_PAGES_IRES</span>
    <span class="definitionkeyword">enum</span> <span class="constant">EXTENSION_DOCUMENTATION_MODEL_IRES</span>
</pre>

<pre class="display">
    <span class="identifier">filename</span><span class="plain"> *</span><span class="functiontext">Inbuild::file_from_installation</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">ires</span><span class="plain">) {</span>
        <span class="reserved">inbuild_nest</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain"> = </span><span class="functiontext">Inbuild::internal</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">I</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">Errors::fatal</span><span class="plain">(</span><span class="string">"Did not set -internal when calling"</span><span class="plain">);</span>
        <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">misc</span><span class="plain"> = </span><span class="identifier">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">-</span><span class="element">&gt;location</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Miscellany"</span><span class="plain">);</span>
        <span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">models</span><span class="plain"> = </span><span class="identifier">Pathnames::subfolder</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">-</span><span class="element">&gt;location</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"HTML"</span><span class="plain">);</span>
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">ires</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">DOCUMENTATION_SNIPPETS_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">misc</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"definitions.html"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">INTRO_BOOKLET_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">misc</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"IntroductionToIF.pdf"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">INTRO_POSTCARD_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">misc</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Postcard.pdf"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">LARGE_DEFAULT_COVER_ART_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">misc</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Cover.jpg"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">SMALL_DEFAULT_COVER_ART_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">misc</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"Small Cover.jpg"</span><span class="plain">);</span>

            <span class="reserved">case</span><span class="plain"> </span><span class="constant">CBLORB_REPORT_MODEL_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">models</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"CblorbModel.html"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">DOCUMENTATION_XREFS_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">models</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"xrefs.txt"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">JAVASCRIPT_FOR_STANDARD_PAGES_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">models</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"main.js"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">JAVASCRIPT_FOR_EXTENSIONS_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">models</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"extensions.js"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">JAVASCRIPT_FOR_ONE_EXTENSION_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">models</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"extensionfile.js"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">CSS_FOR_STANDARD_PAGES_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">models</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"main.css"</span><span class="plain">);</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="constant">EXTENSION_DOCUMENTATION_MODEL_IRES</span><span class="plain">:</span>
                    <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">models</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"extensionfile.html"</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"unknown installation resource file"</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>

</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Inbuild::file_from_installation is used in 5/ed2 (<a href="5-ed2.html#SP3_2">&#167;3.2</a>), 5/ec (<a href="5-ec.html#SP15">&#167;15</a>).</p>

<hr class="tocbar">
<ul class="toc"><li><a href="1-im.html">Back to 'Inbuild Module'</a></li><li><i>(This section ends Chapter 1: Setting Up.)</i></li></ul><hr class="tocbar">
<!--End of weave-->
		</main>
	</body>
</html>

