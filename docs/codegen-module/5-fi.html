<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>5/fbi</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '5/fi' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">codegen</a></li><li><a href="index.html#5">Chapter 5: Final Code</a></li><li><b>Final Inventory</b></li></ul><p class="purpose">To print a summary of the contents of a repository.</p>

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1.  </b>This target is fairly simple: when we get the message to begin generation,
we simply ask the Inter module to output some text, and return true to
tell the generator that nothing more need be done.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::Inventory::create_target</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">inv_cgt</span><span class="plain"> = </span><span class="functiontext">CodeGen::Targets::new</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"inventory"</span><span class="plain">);</span>
        <span class="identifier">METHOD_ADD</span><span class="plain">(</span><span class="identifier">inv_cgt</span><span class="plain">, </span><span class="constant">BEGIN_GENERATION_MTID</span><span class="plain">, </span><span class="functiontext">CodeGen::Inventory::inv</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">CodeGen::Inventory::inv</span><span class="plain">(</span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">cgt</span><span class="plain">, </span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">gen</span><span class="plain">-</span><span class="element">&gt;from_step</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"temporary generations cannot be output"</span><span class="plain">);</span>
        <span class="functiontext">CodeGen::Inventory::print</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">-</span><span class="element">&gt;from_step</span><span class="plain">-</span><span class="element">&gt;text_out_file</span><span class="plain">, </span><span class="identifier">gen</span><span class="plain">-</span><span class="element">&gt;from</span><span class="plain">, </span><span class="identifier">gen</span><span class="plain">-</span><span class="element">&gt;just_this_package</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">TRUE</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::Inventory::print</span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="identifier">inter_repository</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain">, </span><span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">from</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">I</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"no repository"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">from</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"no package"</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">recurse</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">from</span><span class="plain"> == </span><span class="identifier">Inter::Packages::main</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">)) </span><span class="identifier">recurse</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">ptype</span><span class="plain"> = </span><span class="identifier">Inter::Packages::type</span><span class="plain">(</span><span class="identifier">from</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::eq</span><span class="plain">(</span><span class="identifier">ptype</span><span class="plain">-&gt;</span><span class="identifier">symbol_name</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"_module"</span><span class="plain">)) {</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"Module '%S'\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">from</span><span class="plain">-&gt;</span><span class="identifier">package_name</span><span class="plain">-&gt;</span><span class="identifier">symbol_name</span><span class="plain">);</span>
                <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">title</span><span class="plain"> = </span><span class="functiontext">CodeGen::Inventory::read_metadata</span><span class="plain">(</span><span class="identifier">from</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"`title"</span><span class="plain">);</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">title</span><span class="plain">) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"From extension '%S by %S' version %S\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">title</span><span class="plain">,</span>
                    <span class="functiontext">CodeGen::Inventory::read_metadata</span><span class="plain">(</span><span class="identifier">from</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"`author"</span><span class="plain">),</span>
                    <span class="functiontext">CodeGen::Inventory::read_metadata</span><span class="plain">(</span><span class="identifier">from</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"`version"</span><span class="plain">));</span>
                <span class="identifier">recurse</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::eq</span><span class="plain">(</span><span class="identifier">ptype</span><span class="plain">-&gt;</span><span class="identifier">symbol_name</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"_submodule"</span><span class="plain">)) {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">from</span><span class="plain">-&gt;</span><span class="identifier">child_package</span><span class="plain">) {</span>
                    <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S:\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">from</span><span class="plain">-&gt;</span><span class="identifier">package_name</span><span class="plain">-&gt;</span><span class="identifier">symbol_name</span><span class="plain">);</span>
                    <span class="identifier">INDENT</span><span class="plain">;</span>
                        <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">from</span><span class="plain">-&gt;</span><span class="identifier">child_package</span><span class="plain">; </span><span class="identifier">R</span><span class="plain">; </span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">R</span><span class="plain">-&gt;</span><span class="identifier">next_package</span><span class="plain">)</span>
                            <span class="functiontext">CodeGen::unmark</span><span class="plain">(</span><span class="identifier">R</span><span class="plain">-&gt;</span><span class="identifier">package_name</span><span class="plain">);</span>
                        <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">from</span><span class="plain">-&gt;</span><span class="identifier">child_package</span><span class="plain">; </span><span class="identifier">R</span><span class="plain">; </span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">R</span><span class="plain">-&gt;</span><span class="identifier">next_package</span><span class="plain">) {</span>
                            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">CodeGen::marked</span><span class="plain">(</span><span class="identifier">R</span><span class="plain">-&gt;</span><span class="identifier">package_name</span><span class="plain">)) </span><span class="reserved">continue</span><span class="plain">;</span>
                            <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">ptype</span><span class="plain"> = </span><span class="identifier">Inter::Packages::type</span><span class="plain">(</span><span class="identifier">R</span><span class="plain">);</span>
                            <span class="identifier">OUTDENT</span><span class="plain">;</span>
                            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"  %S "</span><span class="plain">, </span><span class="identifier">ptype</span><span class="plain">-&gt;</span><span class="identifier">symbol_name</span><span class="plain">);</span>
                            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">N</span><span class="plain"> = 1;</span>
                            <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">R2</span><span class="plain"> = </span><span class="identifier">R</span><span class="plain">-&gt;</span><span class="identifier">next_package</span><span class="plain">; </span><span class="identifier">R2</span><span class="plain">; </span><span class="identifier">R2</span><span class="plain"> = </span><span class="identifier">R2</span><span class="plain">-&gt;</span><span class="identifier">next_package</span><span class="plain">)</span>
                                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Inter::Packages::type</span><span class="plain">(</span><span class="identifier">R2</span><span class="plain">) == </span><span class="identifier">ptype</span><span class="plain">)</span>
                                    <span class="identifier">N</span><span class="plain">++;</span>
                            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"x %d: "</span><span class="plain">, </span><span class="identifier">N</span><span class="plain">);</span>
                            <span class="identifier">INDENT</span><span class="plain">;</span>
                            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">pos</span><span class="plain"> = </span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">ptype</span><span class="plain">-&gt;</span><span class="identifier">symbol_name</span><span class="plain">) + 7;</span>
                            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">first</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
                            <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">R2</span><span class="plain"> = </span><span class="identifier">R</span><span class="plain">; </span><span class="identifier">R2</span><span class="plain">; </span><span class="identifier">R2</span><span class="plain"> = </span><span class="identifier">R2</span><span class="plain">-&gt;</span><span class="identifier">next_package</span><span class="plain">) {</span>
                                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Inter::Packages::type</span><span class="plain">(</span><span class="identifier">R2</span><span class="plain">) == </span><span class="identifier">ptype</span><span class="plain">) {</span>
                                    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">name</span><span class="plain"> = </span><span class="functiontext">CodeGen::Inventory::read_metadata</span><span class="plain">(</span><span class="identifier">R2</span><span class="plain">, </span><span class="identifier">I</span><span class="string">"`name"</span><span class="plain">);</span>
                                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">name</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">name</span><span class="plain"> = </span><span class="identifier">R2</span><span class="plain">-&gt;</span><span class="identifier">package_name</span><span class="plain">-&gt;</span><span class="identifier">symbol_name</span><span class="plain">;</span>
                                    <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">pos</span><span class="plain"> &gt; 0) &amp;&amp; (</span><span class="identifier">first</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">)) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">", "</span><span class="plain">);</span>
                                    <span class="identifier">pos</span><span class="plain"> += </span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">name</span><span class="plain">) + 2;</span>
                                    <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pos</span><span class="plain"> &gt; 80) { </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">); </span><span class="identifier">pos</span><span class="plain"> = </span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">name</span><span class="plain">) + 2; }</span>
                                    <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">name</span><span class="plain">);</span>
                                    <span class="functiontext">CodeGen::mark</span><span class="plain">(</span><span class="identifier">R2</span><span class="plain">-&gt;</span><span class="identifier">package_name</span><span class="plain">);</span>
                                    <span class="identifier">first</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
                                <span class="plain">}</span>
                            <span class="plain">}</span>
                            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pos</span><span class="plain"> &gt; 0) </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
                        <span class="plain">}</span>
                        <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">from</span><span class="plain">-&gt;</span><span class="identifier">child_package</span><span class="plain">; </span><span class="identifier">R</span><span class="plain">; </span><span class="identifier">R</span><span class="plain"> = </span><span class="identifier">R</span><span class="plain">-&gt;</span><span class="identifier">next_package</span><span class="plain">)</span>
                            <span class="functiontext">CodeGen::unmark</span><span class="plain">(</span><span class="identifier">R</span><span class="plain">-&gt;</span><span class="identifier">package_name</span><span class="plain">);</span>
                    <span class="identifier">OUTDENT</span><span class="plain">;</span>
                <span class="plain">}</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">recurse</span><span class="plain">) {</span>
            <span class="identifier">INDENT</span><span class="plain">;</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">M</span><span class="plain"> = </span><span class="identifier">from</span><span class="plain">-&gt;</span><span class="identifier">child_package</span><span class="plain">; </span><span class="identifier">M</span><span class="plain">; </span><span class="identifier">M</span><span class="plain"> = </span><span class="identifier">M</span><span class="plain">-&gt;</span><span class="identifier">next_package</span><span class="plain">)</span>
                <span class="functiontext">CodeGen::Inventory::print</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">I</span><span class="plain">, </span><span class="identifier">M</span><span class="plain">);</span>
            <span class="identifier">OUTDENT</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>

    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="functiontext">CodeGen::Inventory::read_metadata</span><span class="plain">(</span><span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">key</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">P</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">found</span><span class="plain"> = </span><span class="identifier">Inter::SymbolsTables::symbol_from_name</span><span class="plain">(</span><span class="identifier">Inter::Packages::scope</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">), </span><span class="identifier">key</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">found</span><span class="plain">) &amp;&amp; (</span><span class="identifier">Inter::Symbols::is_defined</span><span class="plain">(</span><span class="identifier">found</span><span class="plain">))) {</span>
            <span class="identifier">inter_frame</span><span class="plain"> </span><span class="identifier">F</span><span class="plain"> = </span><span class="identifier">Inter::Symbols::defining_frame</span><span class="plain">(</span><span class="identifier">found</span><span class="plain">);</span>
            <span class="identifier">inter_t</span><span class="plain"> </span><span class="identifier">val2</span><span class="plain"> = </span><span class="identifier">F</span><span class="plain">.</span><span class="identifier">data</span><span class="plain">[</span><span class="identifier">VAL1_MD_IFLD</span><span class="plain"> + 1];</span>
            <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Inter::get_text</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">-&gt;</span><span class="identifier">stored_in</span><span class="plain">, </span><span class="identifier">val2</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CodeGen::Inventory::create_target is used in 5/ft (<a href="5-ft.html#SP2">&#167;2</a>).</p>

<p class="endnote">The function CodeGen::Inventory::inv appears nowhere else.</p>

<p class="endnote">The function CodeGen::Inventory::print appears nowhere else.</p>

<p class="endnote">The function CodeGen::Inventory::read_metadata appears nowhere else.</p>

<hr class="tocbar">
<ul class="toc"><li><a href="5-fbi.html">Back to 'Final Binary Inter'</a></li><li><a href="5-gi6.html">Continue with 'Generating Inform 6'</a></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

