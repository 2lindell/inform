<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>4/vrb</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '4/gi6' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">codegen</a></li><li><a href="index.html#4">Chapter 4: Inter to Higher-Level Languages</a></li><li><b>Generating Inform 6</b></li></ul><p class="purpose">To generate I6 code from intermediate code.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Target</a></li><li><a href="#SP2">&#167;2. Segmentation</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Target. </b></p>


<pre class="display">
    <span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">inform6_target</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::I6::create_target</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">cgt</span><span class="plain"> = </span><span class="functiontext">CodeGen::Targets::new</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"inform6"</span><span class="plain">);</span>
        <span class="identifier">METHOD_ADD</span><span class="plain">(</span><span class="identifier">cgt</span><span class="plain">, </span><span class="constant">BEGIN_GENERATION_MTID</span><span class="plain">, </span><span class="functiontext">CodeGen::I6::begin_generation</span><span class="plain">);</span>
        <span class="identifier">METHOD_ADD</span><span class="plain">(</span><span class="identifier">cgt</span><span class="plain">, </span><span class="constant">GENERAL_SEGMENT_MTID</span><span class="plain">, </span><span class="functiontext">CodeGen::I6::general_segment</span><span class="plain">);</span>
        <span class="identifier">METHOD_ADD</span><span class="plain">(</span><span class="identifier">cgt</span><span class="plain">, </span><span class="constant">TL_SEGMENT_MTID</span><span class="plain">, </span><span class="functiontext">CodeGen::I6::tl_segment</span><span class="plain">);</span>
        <span class="identifier">METHOD_ADD</span><span class="plain">(</span><span class="identifier">cgt</span><span class="plain">, </span><span class="constant">DEFAULT_SEGMENT_MTID</span><span class="plain">, </span><span class="functiontext">CodeGen::I6::default_segment</span><span class="plain">);</span>
        <span class="identifier">METHOD_ADD</span><span class="plain">(</span><span class="identifier">cgt</span><span class="plain">, </span><span class="constant">CONSTANT_SEGMENT_MTID</span><span class="plain">, </span><span class="functiontext">CodeGen::I6::constant_segment</span><span class="plain">);</span>
        <span class="identifier">METHOD_ADD</span><span class="plain">(</span><span class="identifier">cgt</span><span class="plain">, </span><span class="constant">PROPERTY_SEGMENT_MTID</span><span class="plain">, </span><span class="functiontext">CodeGen::I6::property_segment</span><span class="plain">);</span>
        <span class="identifier">METHOD_ADD</span><span class="plain">(</span><span class="identifier">cgt</span><span class="plain">, </span><span class="constant">DECLARE_PROPERTY_MTID</span><span class="plain">, </span><span class="functiontext">CodeGen::I6::declare_property</span><span class="plain">);</span>
        <span class="identifier">inform6_target</span><span class="plain"> = </span><span class="identifier">cgt</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="functiontext">CodeGen::I6::target</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">inform6_target</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CodeGen::I6::create_target is used in 1/trg (<a href="1-trg.html#SP2">&#167;2</a>).</p>

<p class="endnote">The function CodeGen::I6::target is used in 4/cg (<a href="4-cg.html#SP6">&#167;6</a>).</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. Segmentation. </b></p>


<pre class="definitions">
    <span class="definitionkeyword">enum</span> <span class="constant">pragmatic_matter_I7CGS</span><span class="definitionkeyword"> from </span><span class="constant">0</span>
    <span class="definitionkeyword">enum</span> <span class="constant">attributes_at_eof_I7CGS</span>
    <span class="definitionkeyword">enum</span> <span class="constant">early_matter_I7CGS</span>
    <span class="definitionkeyword">enum</span> <span class="constant">text_literals_code_I7CGS</span>
    <span class="definitionkeyword">enum</span> <span class="constant">summations_at_eof_I7CGS</span>
    <span class="definitionkeyword">enum</span> <span class="constant">arrays_at_eof_I7CGS</span>
    <span class="definitionkeyword">enum</span> <span class="constant">main_matter_I7CGS</span>
    <span class="definitionkeyword">enum</span> <span class="constant">routines_at_eof_I7CGS</span>
    <span class="definitionkeyword">enum</span> <span class="constant">code_at_eof_I7CGS</span>
    <span class="definitionkeyword">enum</span> <span class="constant">verbs_at_eof_I7CGS</span>
</pre>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::I6::begin_generation</span><span class="plain">(</span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">cgt</span><span class="plain">, </span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">cg</span><span class="plain">) {</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">pragmatic_matter_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">attributes_at_eof_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">early_matter_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">text_literals_code_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">summations_at_eof_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">arrays_at_eof_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">main_matter_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">routines_at_eof_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">code_at_eof_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
        <span class="identifier">cg</span><span class="plain">-</span><span class="element">&gt;segments</span><span class="plain">[</span><span class="constant">verbs_at_eof_I7CGS</span><span class="plain">] = </span><span class="functiontext">CodeGen::new_segment</span><span class="plain">();</span>
    <span class="plain">}</span>

    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">CodeGen::I6::general_segment</span><span class="plain">(</span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">cgt</span><span class="plain">, </span><span class="identifier">inter_frame</span><span class="plain"> </span><span class="identifier">P</span><span class="plain">) {</span>
        <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">P</span><span class="plain">.</span><span class="identifier">data</span><span class="plain">[</span><span class="identifier">ID_IFLD</span><span class="plain">]) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="identifier">CONSTANT_IST</span><span class="plain">: {</span>
                <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">con_name</span><span class="plain"> =</span>
                    <span class="identifier">Inter::SymbolsTables::symbol_from_frame_data</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">DEFN_CONST_IFLD</span><span class="plain">);</span>
                <span class="reserved">int</span><span class="plain"> </span><span class="identifier">choice</span><span class="plain"> = </span><span class="constant">early_matter_I7CGS</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Inter::Symbols::read_annotation</span><span class="plain">(</span><span class="identifier">con_name</span><span class="plain">, </span><span class="identifier">LATE_IANN</span><span class="plain">) == 1) </span><span class="identifier">choice</span><span class="plain"> = </span><span class="constant">code_at_eof_I7CGS</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Inter::Symbols::read_annotation</span><span class="plain">(</span><span class="identifier">con_name</span><span class="plain">, </span><span class="identifier">BUFFERARRAY_IANN</span><span class="plain">) == 1) </span><span class="identifier">choice</span><span class="plain"> = </span><span class="constant">arrays_at_eof_I7CGS</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Inter::Symbols::read_annotation</span><span class="plain">(</span><span class="identifier">con_name</span><span class="plain">, </span><span class="identifier">BYTEARRAY_IANN</span><span class="plain">) == 1) </span><span class="identifier">choice</span><span class="plain"> = </span><span class="constant">arrays_at_eof_I7CGS</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Inter::Symbols::read_annotation</span><span class="plain">(</span><span class="identifier">con_name</span><span class="plain">, </span><span class="identifier">STRINGARRAY_IANN</span><span class="plain">) == 1) </span><span class="identifier">choice</span><span class="plain"> = </span><span class="constant">arrays_at_eof_I7CGS</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Inter::Symbols::read_annotation</span><span class="plain">(</span><span class="identifier">con_name</span><span class="plain">, </span><span class="identifier">TABLEARRAY_IANN</span><span class="plain">) == 1) </span><span class="identifier">choice</span><span class="plain"> = </span><span class="constant">arrays_at_eof_I7CGS</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">P</span><span class="plain">.</span><span class="identifier">data</span><span class="plain">[</span><span class="identifier">FORMAT_CONST_IFLD</span><span class="plain">] == </span><span class="identifier">CONSTANT_INDIRECT_LIST</span><span class="plain">) </span><span class="identifier">choice</span><span class="plain"> = </span><span class="constant">arrays_at_eof_I7CGS</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Inter::Symbols::read_annotation</span><span class="plain">(</span><span class="identifier">con_name</span><span class="plain">, </span><span class="identifier">VERBARRAY_IANN</span><span class="plain">) == 1) </span><span class="identifier">choice</span><span class="plain"> = </span><span class="constant">verbs_at_eof_I7CGS</span><span class="plain">;</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Inter::Constant::is_routine</span><span class="plain">(</span><span class="identifier">con_name</span><span class="plain">)) </span><span class="identifier">choice</span><span class="plain"> = </span><span class="constant">routines_at_eof_I7CGS</span><span class="plain">;</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="identifier">choice</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="identifier">RESPONSE_IST</span><span class="plain">:</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="constant">early_matter_I7CGS</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="identifier">PRAGMA_IST</span><span class="plain">:</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="constant">pragmatic_matter_I7CGS</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext">CodeGen::I6::default_segment</span><span class="plain">(</span><span class="identifier">cgt</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">CodeGen::I6::default_segment</span><span class="plain">(</span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">cgt</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="constant">main_matter_I7CGS</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">CodeGen::I6::constant_segment</span><span class="plain">(</span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">cgt</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="constant">early_matter_I7CGS</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">CodeGen::I6::property_segment</span><span class="plain">(</span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">cgt</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="constant">attributes_at_eof_I7CGS</span><span class="plain">;</span>
    <span class="plain">}</span>
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">CodeGen::I6::tl_segment</span><span class="plain">(</span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">cgt</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="constant">text_literals_code_I7CGS</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CodeGen::I6::begin_generation is used in <a href="#SP1">&#167;1</a>.</p>

<p class="endnote">The function CodeGen::I6::general_segment is used in <a href="#SP1">&#167;1</a>.</p>

<p class="endnote">The function CodeGen::I6::default_segment is used in <a href="#SP1">&#167;1</a>.</p>

<p class="endnote">The function CodeGen::I6::constant_segment is used in <a href="#SP1">&#167;1</a>.</p>

<p class="endnote">The function CodeGen::I6::property_segment is used in <a href="#SP1">&#167;1</a>.</p>

<p class="endnote">The function CodeGen::I6::tl_segment is used in <a href="#SP1">&#167;1</a>.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>Because in I6 source code some properties aren't declared before use, it follows
that if not used by any object then they won't ever be created. This is a
problem since it means that I6 code can't refer to them, because it would need
to mention an I6 symbol which doesn't exist. To get around this, we create the
property names which don't exist as constant symbols with the harmless value
0; we do this right at the end of the compiled I6 code. (This is a standard I6
trick called "stubbing", these being "stub definitions".)
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::I6::declare_property</span><span class="plain">(</span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">cgt</span><span class="plain">, </span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">prop_name</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">used</span><span class="plain">) {</span>
        <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">name</span><span class="plain"> = </span><span class="functiontext">CodeGen::name</span><span class="plain">(</span><span class="identifier">prop_name</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">used</span><span class="plain">) {</span>
            <span class="reserved">generated_segment</span><span class="plain"> *</span><span class="identifier">saved</span><span class="plain"> = </span><span class="functiontext">CodeGen::select</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">, </span><span class="constant">attributes_at_eof_I7CGS</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="functiontext">CodeGen::current</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">), </span><span class="string">"Property %S;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">prop_name</span><span class="plain">-&gt;</span><span class="identifier">symbol_name</span><span class="plain">);</span>
            <span class="functiontext">CodeGen::deselect</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">, </span><span class="identifier">saved</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">generated_segment</span><span class="plain"> *</span><span class="identifier">saved</span><span class="plain"> = </span><span class="functiontext">CodeGen::select</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">, </span><span class="constant">code_at_eof_I7CGS</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="functiontext">CodeGen::current</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">), </span><span class="string">"#ifndef %S; Constant %S = 0; #endif;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">name</span><span class="plain">, </span><span class="identifier">name</span><span class="plain">);</span>
            <span class="functiontext">CodeGen::deselect</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">, </span><span class="identifier">saved</span><span class="plain">);</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function CodeGen::I6::declare_property is used in <a href="#SP1">&#167;1</a>.</p>

<hr class="tocbar">
<ul class="toc"><li><a href="4-vrb.html">Back to 'Variables'</a></li><li><i>(This section ends Chapter 4: Inter to Higher-Level Languages.)</i></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

