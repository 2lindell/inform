<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Code Generation</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../index.html">
<img src="../docs-src/Figures/Inform.png" height=72">
</a></h1>
<ul><li><a href="../compiler.html">compiler tools</a></li>
<li><a href="../other.html">other tools</a></li>
<li><a href="../extensions.html">extensions and kits</a></li>
<li><a href="../units.html">unit test tools</a></li>
</ul><h2>Compiler Webs</h2><ul>
<li><a href="../inbuild/index.html">inbuild</a></li>
<li><a href="../inform7/index.html">inform7</a></li>
<li><a href="../inter/index.html">inter</a></li>
</ul><h2>Inbuild Modules</h2><ul>
<li><a href="../supervisor-module/index.html">supervisor</a></li>
</ul><h2>Inform7 Modules</h2><ul>
<li><a href="../core-module/index.html">core</a></li>
<li><a href="../inflections-module/index.html">inflections</a></li>
<li><a href="../linguistics-module/index.html">linguistics</a></li>
<li><a href="../kinds-module/index.html">kinds</a></li>
<li><a href="../if-module/index.html">if</a></li>
<li><a href="../multimedia-module/index.html">multimedia</a></li>
<li><a href="../problems-module/index.html">problems</a></li>
<li><a href="../index-module/index.html">index</a></li>
</ul><h2>Inter Modules</h2><ul>
<li><a href="../bytecode-module/index.html">bytecode</a></li>
<li><a href="../building-module/index.html">building</a></li>
<li><a href="index.html"><span class="selectedlink">codegen</span></a></li>
</ul><h2>Shared Modules</h2><ul>
<li><a href="../arch-module/index.html">arch</a></li>
<li><a href="../syntax-module/index.html">syntax</a></li>
<li><a href="../words-module/index.html">words</a></li>
<li><a href="../html-module/index.html">html</a></li>
<li><a href="../../../inweb/docs/foundation-module/index.html">foundation</a></li>

</ul>
		</nav>
		<main role="main">
		
<!--Weave of 'Code Generation' generated by 7-->
<ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="../compiler.html">Inter Modules</a></li><li><a href="index.html">codegen</a></li><li><a href="index.html#3">Chapter 3: Inter to Final Code</a></li><li><b>Code Generation</b></li></ul><p class="purpose">To generate final code from intermediate code.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Pipeline stage</a></li><li><a href="#SP2">&#167;2. Generations</a></li><li><a href="#SP8">&#167;8. </a></li><li><a href="#SP10">&#167;10. Marking</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Pipeline stage. </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::create_pipeline_stage<button class="popup" onclick="togglePopup('usagePopup100')">...<span class="popuptext" id="usagePopup100">Usage of <b>CodeGen::create_pipeline_stage</b>:<br>Stages - <a href="1-stg.html#SP2">&#167;2</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="functiontext"><a href="1-stg.html#SP1">CodeGen::Stage::new</a></span><span class="plain">(</span><span class="identifier">I</span><span class="string">"generate"</span><span class="plain">, </span><span class="functiontext"><a href="#SP1">CodeGen::run_pipeline_stage</a></span><span class="plain">, </span><span class="constant">TEXT_OUT_STAGE_ARG</span><span class="plain">, </span><span class="identifier">FALSE</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">CodeGen::run_pipeline_stage<button class="popup" onclick="togglePopup('usagePopup101')">...<span class="popuptext" id="usagePopup101">Usage of <b>CodeGen::run_pipeline_stage</b>:<br>none</span></button></span><span class="plain">(</span><span class="reserved">pipeline_step</span><span class="plain"> *</span><span class="identifier">step</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">step</span><span class="plain">-&gt;</span><span class="identifier">target_argument</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"no target specified"</span><span class="plain">);</span>
        <span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">which</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">step</span><span class="plain">-&gt;</span><span class="element">package_argument</span><span class="plain">) &gt; </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="identifier">which</span><span class="plain"> = </span><span class="identifier">Inter::Packages::by_url</span><span class="plain">(</span><span class="identifier">step</span><span class="plain">-&gt;</span><span class="element">repository</span><span class="plain">,</span>
                <span class="identifier">step</span><span class="plain">-&gt;</span><span class="element">package_argument</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">which</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) {</span>
                <span class="identifier">LOG</span><span class="plain">(</span><span class="string">"Arg %S\n"</span><span class="plain">, </span><span class="identifier">step</span><span class="plain">-&gt;</span><span class="element">package_argument</span><span class="plain">);</span>
                <span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"no such package name"</span><span class="plain">);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>

        <span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain"> =</span>
            <span class="functiontext"><a href="#SP2">CodeGen::new_generation</a></span><span class="plain">(</span><span class="identifier">step</span><span class="plain">, </span><span class="identifier">step</span><span class="plain">-&gt;</span><span class="element">repository</span><span class="plain">, </span><span class="identifier">which</span><span class="plain">, </span><span class="identifier">step</span><span class="plain">-&gt;</span><span class="element">target_argument</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext"><a href="4-ft.html#SP3">CodeGen::Targets::begin_generation</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">) == </span><span class="identifier">FALSE</span><span class="plain">) {</span>
            <span class="functiontext"><a href="#SP8">CodeGen::generate</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">);</span>
            <span class="functiontext"><a href="#SP4">CodeGen::write</a></span><span class="plain">(</span><span class="identifier">step</span><span class="plain">-&gt;</span><span class="element">text_out_file</span><span class="plain">, </span><span class="identifier">gen</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">TRUE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. Generations. </b>A "generation" is a single act of translating inter code into final code.
That final code will be a text file written in some other programming
language, though probably a low-level one.
</p>

<p class="inwebparagraph">The "target" of a generation is the final language: for example, Inform 6.
</p>

<p class="inwebparagraph">During a generation, textual output is assembled as a set of "segments".
Different targets may need different segments. This is all to facilitate
rearranging content as necessary to get it to compile in the target language:
for example, one might need to have all constants defined first, then all
arrays, and one could do this by creating two segments, one to accumulate
the constants in, one to accumulate the arrays.
</p>

<p class="inwebparagraph">At any given time, a generation has a "current" segment, to which output
is being written. Ome segment is special: the temporary one, which is used
only when assembling other material, and not for the final output.
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_CG_SEGMENTS</span><span class="plain"> </span><span class="constant">100</span>
    <span class="definitionkeyword">define</span> <span class="constant">TEMP_CG_SEGMENT</span><span class="plain"> </span><span class="constant">99</span>
</pre>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">code_generation</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pipeline_step</span><span class="plain"> *</span><span class="identifier">from_step</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">inter_tree</span><span class="plain"> *</span><span class="identifier">from</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">target</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">just_this_package</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">generated_segment</span><span class="plain"> *</span><span class="identifier">segments</span><span class="plain">[</span><span class="constant">MAX_CG_SEGMENTS</span><span class="plain">];</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">generated_segment</span><span class="plain"> *</span><span class="identifier">current_segment</span><span class="plain">; </span><span class="comment"> an entry in that array, or null</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">temporarily_diverted</span><span class="plain">; </span><span class="comment"> to the temporary segment</span>
        <span class="identifier">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">code_generation</span><span class="plain">;</span>

    <span class="reserved">code_generation</span><span class="plain"> *</span><span class="functiontext">CodeGen::new_generation<button class="popup" onclick="togglePopup('usagePopup102')">...<span class="popuptext" id="usagePopup102">Usage of <b>CodeGen::new_generation</b>:<br><a href="#SP1">&#167;1</a>, Frame Control - <a href="3-fc.html#SP2">&#167;2</a></span></button></span><span class="plain">(</span><span class="reserved">pipeline_step</span><span class="plain"> *</span><span class="identifier">step</span><span class="plain">, </span><span class="identifier">inter_tree</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain">,</span>
        <span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">just</span><span class="plain">, </span><span class="reserved">code_generation_target</span><span class="plain"> *</span><span class="identifier">target</span><span class="plain">) {</span>
        <span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">code_generation</span><span class="plain">);</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">from_step</span><span class="plain"> = </span><span class="identifier">step</span><span class="plain">;</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">from</span><span class="plain"> = </span><span class="identifier">I</span><span class="plain">;</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">target</span><span class="plain"> = </span><span class="identifier">target</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">just</span><span class="plain">) </span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">just_this_package</span><span class="plain"> = </span><span class="identifier">just</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="identifier">just_this_package</span><span class="plain"> = </span><span class="identifier">Site::main_package</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">);</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">current_segment</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">temporarily_diverted</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="constant">MAX_CG_SEGMENTS</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) </span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">segments</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">] = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">gen</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure code_generation is accessed in 3/fc, 3/cal, 3/iap, 3/vrb, 4/ft, 4/fti, 4/fbi, 4/fi, 4/fi6 and here.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>At present, at least, a "segment" is nothing more than a wrapper for a text.
But we abstract it in case it's ever useful for it to be more.
</p>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">generated_segment</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">generated_code</span><span class="plain">;</span>
        <span class="identifier">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">generated_segment</span><span class="plain">;</span>

    <span class="reserved">generated_segment</span><span class="plain"> *</span><span class="functiontext">CodeGen::new_segment<button class="popup" onclick="togglePopup('usagePopup103')">...<span class="popuptext" id="usagePopup103">Usage of <b>CodeGen::new_segment</b>:<br><a href="#SP6">&#167;6</a>, Generating Inform 6 - <a href="4-fi6.html#SP2">&#167;2</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">generated_segment</span><span class="plain"> *</span><span class="identifier">seg</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">generated_segment</span><span class="plain">);</span>
        <span class="identifier">seg</span><span class="plain">-&gt;</span><span class="element">generated_code</span><span class="plain"> = </span><span class="identifier">Str::new</span><span class="plain">();</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">seg</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure generated_segment is private to this section.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>The segments should be numbered in the order they will appear in the final
output, because:
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::write<button class="popup" onclick="togglePopup('usagePopup104')">...<span class="popuptext" id="usagePopup104">Usage of <b>CodeGen::write</b>:<br><a href="#SP1">&#167;1</a></span></button></span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain">) {</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="constant">MAX_CG_SEGMENTS</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="identifier">segments</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">]) &amp;&amp; (</span><span class="identifier">i</span><span class="plain"> != </span><span class="constant">TEMP_CG_SEGMENT</span><span class="plain">))</span>
                <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">segments</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">]-&gt;</span><span class="element">generated_code</span><span class="plain">);</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5.  </b>Here we switch the output, by changing the segment selection. This must
always be done in a way which is then undone, restoring the previous state:
</p>

<pre class="display">
    <span class="reserved">generated_segment</span><span class="plain"> *</span><span class="functiontext">CodeGen::select<button class="popup" onclick="togglePopup('usagePopup105')">...<span class="popuptext" id="usagePopup105">Usage of <b>CodeGen::select</b>:<br>Frame Control - <a href="3-fc.html#SP1">&#167;1</a><br>Constants and Literals - <a href="3-cal.html#SP2">&#167;2</a>, <a href="3-cal.html#SP3">&#167;3</a>, <a href="3-cal.html#SP4">&#167;4</a><br>Instances and Properties - <a href="3-iap.html#SP1">&#167;1</a>, <a href="3-iap.html#SP4_5">&#167;4.5</a>, <a href="3-iap.html#SP4_6">&#167;4.6</a>, <a href="3-iap.html#SP5">&#167;5</a><br>Generating Inform 6 - <a href="4-fi6.html#SP2">&#167;2</a>, <a href="4-fi6.html#SP5">&#167;5</a>, <a href="4-fi6.html#SP6">&#167;6</a></span></button></span><span class="plain">(</span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">) {</span>
        <span class="reserved">generated_segment</span><span class="plain"> *</span><span class="identifier">saved</span><span class="plain"> = </span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">current_segment</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">i</span><span class="plain"> &lt; </span><span class="constant">0</span><span class="plain">) || (</span><span class="identifier">i</span><span class="plain"> &gt;= </span><span class="constant">MAX_CG_SEGMENTS</span><span class="plain">)) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"out of range"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">temporarily_diverted</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"poorly timed selection"</span><span class="plain">);</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">current_segment</span><span class="plain"> = </span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">segments</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">];</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">saved</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::deselect<button class="popup" onclick="togglePopup('usagePopup106')">...<span class="popuptext" id="usagePopup106">Usage of <b>CodeGen::deselect</b>:<br>Frame Control - <a href="3-fc.html#SP1">&#167;1</a><br>Constants and Literals - <a href="3-cal.html#SP2">&#167;2</a>, <a href="3-cal.html#SP3">&#167;3</a>, <a href="3-cal.html#SP4">&#167;4</a><br>Instances and Properties - <a href="3-iap.html#SP1">&#167;1</a>, <a href="3-iap.html#SP4_5">&#167;4.5</a>, <a href="3-iap.html#SP4_6">&#167;4.6</a>, <a href="3-iap.html#SP5">&#167;5</a><br>Generating Inform 6 - <a href="4-fi6.html#SP2">&#167;2</a>, <a href="4-fi6.html#SP5">&#167;5</a>, <a href="4-fi6.html#SP6">&#167;6</a></span></button></span><span class="plain">(</span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain">, </span><span class="reserved">generated_segment</span><span class="plain"> *</span><span class="identifier">saved</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">temporarily_diverted</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"poorly timed deselection"</span><span class="plain">);</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">current_segment</span><span class="plain"> = </span><span class="identifier">saved</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>The procedure for selecting the temporary segment is different, because
we also have to direct it to a given text.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::select_temporary<button class="popup" onclick="togglePopup('usagePopup107')">...<span class="popuptext" id="usagePopup107">Usage of <b>CodeGen::select_temporary</b>:<br>Frame Control - <a href="3-fc.html#SP1">&#167;1</a>, <a href="3-fc.html#SP2">&#167;2</a><br>Instances and Properties - <a href="3-iap.html#SP5_8_4_1_1">&#167;5.8.4.1.1</a></span></button></span><span class="plain">(</span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">segments</span><span class="plain">[</span><span class="constant">TEMP_CG_SEGMENT</span><span class="plain">] == </span><span class="identifier">NULL</span><span class="plain">) {</span>
            <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">segments</span><span class="plain">[</span><span class="constant">TEMP_CG_SEGMENT</span><span class="plain">] = </span><span class="functiontext"><a href="#SP3">CodeGen::new_segment</a></span><span class="plain">();</span>
            <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">segments</span><span class="plain">[</span><span class="constant">TEMP_CG_SEGMENT</span><span class="plain">]-&gt;</span><span class="element">generated_code</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">temporarily_diverted</span><span class="plain">)</span>
            <span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"nested temporary cgs"</span><span class="plain">);</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">temporarily_diverted</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">segments</span><span class="plain">[</span><span class="constant">TEMP_CG_SEGMENT</span><span class="plain">]-&gt;</span><span class="element">generated_code</span><span class="plain"> = </span><span class="identifier">T</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::deselect_temporary<button class="popup" onclick="togglePopup('usagePopup108')">...<span class="popuptext" id="usagePopup108">Usage of <b>CodeGen::deselect_temporary</b>:<br>Frame Control - <a href="3-fc.html#SP1">&#167;1</a>, <a href="3-fc.html#SP2">&#167;2</a><br>Instances and Properties - <a href="3-iap.html#SP5_8_4_1_1">&#167;5.8.4.1.1</a></span></button></span><span class="plain">(</span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain">) {</span>
        <span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">temporarily_diverted</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b>Note that temporary selections take precedence over the regular selection.
</p>

<pre class="display">
    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="functiontext">CodeGen::current<button class="popup" onclick="togglePopup('usagePopup109')">...<span class="popuptext" id="usagePopup109">Usage of <b>CodeGen::current</b>:<br>Frame Control - <a href="3-fc.html#SP2">&#167;2</a>, <a href="3-fc.html#SP3">&#167;3</a><br>Constants and Literals - <a href="3-cal.html#SP2">&#167;2</a>, <a href="3-cal.html#SP3">&#167;3</a>, <a href="3-cal.html#SP4">&#167;4</a><br>Instances and Properties - <a href="3-iap.html#SP1">&#167;1</a>, <a href="3-iap.html#SP4_5">&#167;4.5</a>, <a href="3-iap.html#SP4_6">&#167;4.6</a>, <a href="3-iap.html#SP5">&#167;5</a>, <a href="3-iap.html#SP6">&#167;6</a>, <a href="3-iap.html#SP8">&#167;8</a><br>Generating Inform 6 - <a href="4-fi6.html#SP2">&#167;2</a>, <a href="4-fi6.html#SP3">&#167;3</a>, <a href="4-fi6.html#SP4">&#167;4</a>, <a href="4-fi6.html#SP5">&#167;5</a>, <a href="4-fi6.html#SP6">&#167;6</a></span></button></span><span class="plain">(</span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">temporarily_diverted</span><span class="plain">)</span>
            <span class="reserved">return</span><span class="plain"> </span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">segments</span><span class="plain">[</span><span class="constant">TEMP_CG_SEGMENT</span><span class="plain">]-&gt;</span><span class="element">generated_code</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">current_segment</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">current_segment</span><span class="plain">-&gt;</span><span class="element">generated_code</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8.  </b>Actual generation happens in three phases:
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::generate<button class="popup" onclick="togglePopup('usagePopup110')">...<span class="popuptext" id="usagePopup110">Usage of <b>CodeGen::generate</b>:<br><a href="#SP1">&#167;1</a></span></button></span><span class="plain">(</span><span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain">) {</span>
        &lt;<span class="cwebmacro">Phase one - preparation</span> <span class="cwebmacronumber">8.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Phase two - traverse</span> <span class="cwebmacronumber">8.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Phase three - consolidation</span> <span class="cwebmacronumber">8.3</span>&gt;<span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP8_1"></a><b>&#167;8.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Phase one - preparation</span> <span class="cwebmacronumber">8.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">Inter::Tree::traverse</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">from</span><span class="plain">, </span><span class="functiontext"><a href="#SP10">CodeGen::clear_transients</a></span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">PACKAGE_IST</span><span class="plain">);</span>
        <span class="functiontext"><a href="3-fc.html#SP1">CodeGen::FC::prepare</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">);</span>
        <span class="functiontext"><a href="3-cal.html#SP1">CodeGen::CL::prepare</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">);</span>
        <span class="functiontext"><a href="3-vrb.html#SP1">CodeGen::Var::prepare</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">);</span>
        <span class="functiontext"><a href="3-iap.html#SP1">CodeGen::IP::prepare</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP8_2"></a><b>&#167;8.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Phase two - traverse</span> <span class="cwebmacronumber">8.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">Inter::Tree::traverse_root_only</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">from</span><span class="plain">, </span><span class="functiontext"><a href="#SP9">CodeGen::pragma</a></span><span class="plain">, </span><span class="identifier">gen</span><span class="plain">, </span><span class="identifier">PRAGMA_IST</span><span class="plain">);</span>
        <span class="identifier">Inter::Tree::traverse</span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">-&gt;</span><span class="element">from</span><span class="plain">, </span><span class="functiontext"><a href="3-fc.html#SP1">CodeGen::FC::iterate</a></span><span class="plain">, </span><span class="identifier">gen</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, -</span><span class="identifier">PACKAGE_IST</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP8_3"></a><b>&#167;8.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Phase three - consolidation</span> <span class="cwebmacronumber">8.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="functiontext"><a href="3-cal.html#SP2">CodeGen::CL::responses</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">);</span>
        <span class="functiontext"><a href="3-iap.html#SP1">CodeGen::IP::write_properties</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">);</span>
        <span class="functiontext"><a href="3-cal.html#SP4">CodeGen::CL::sort_literals</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP8">&#167;8</a>.</p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9.  </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::pragma<button class="popup" onclick="togglePopup('usagePopup111')">...<span class="popuptext" id="usagePopup111">Usage of <b>CodeGen::pragma</b>:<br><a href="#SP8_2">&#167;8.2</a></span></button></span><span class="plain">(</span><span class="identifier">inter_tree</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain">, </span><span class="identifier">inter_tree_node</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">state</span><span class="plain">) {</span>
        <span class="reserved">code_generation</span><span class="plain"> *</span><span class="identifier">gen</span><span class="plain"> = (</span><span class="reserved">code_generation</span><span class="plain"> *) </span><span class="identifier">state</span><span class="plain">;</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">target_symbol</span><span class="plain"> = </span><span class="identifier">Inter::SymbolsTables::symbol_from_frame_data</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">TARGET_PRAGMA_IFLD</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">target_symbol</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"bad pragma"</span><span class="plain">);</span>
        <span class="identifier">inter_t</span><span class="plain"> </span><span class="identifier">ID</span><span class="plain"> = </span><span class="identifier">P</span><span class="plain">-&gt;</span><span class="identifier">W</span><span class="plain">.</span><span class="identifier">data</span><span class="plain">[</span><span class="identifier">TEXT_PRAGMA_IFLD</span><span class="plain">];</span>
        <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">S</span><span class="plain"> = </span><span class="identifier">Inter::Node::ID_to_text</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">ID</span><span class="plain">);</span>
        <span class="functiontext"><a href="4-ft.html#SP10">CodeGen::Targets::offer_pragma</a></span><span class="plain">(</span><span class="identifier">gen</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">target_symbol</span><span class="plain">-&gt;</span><span class="identifier">symbol_name</span><span class="plain">, </span><span class="identifier">S</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10. Marking. </b>We use a transient flag on symbols, but abstract that here:
</p>

<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">CodeGen::marked<button class="popup" onclick="togglePopup('usagePopup112')">...<span class="popuptext" id="usagePopup112">Usage of <b>CodeGen::marked</b>:<br>Instances and Properties - <a href="3-iap.html#SP5_8_4">&#167;5.8.4</a></span></button></span><span class="plain">(</span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">symb_name</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">Inter::Symbols::get_flag</span><span class="plain">(</span><span class="identifier">symb_name</span><span class="plain">, </span><span class="identifier">TRAVERSE_MARK_BIT</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::mark<button class="popup" onclick="togglePopup('usagePopup113')">...<span class="popuptext" id="usagePopup113">Usage of <b>CodeGen::mark</b>:<br>Instances and Properties - <a href="3-iap.html#SP5_8_4">&#167;5.8.4</a></span></button></span><span class="plain">(</span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">symb_name</span><span class="plain">) {</span>
        <span class="identifier">Inter::Symbols::set_flag</span><span class="plain">(</span><span class="identifier">symb_name</span><span class="plain">, </span><span class="identifier">TRAVERSE_MARK_BIT</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::unmark<button class="popup" onclick="togglePopup('usagePopup114')">...<span class="popuptext" id="usagePopup114">Usage of <b>CodeGen::unmark</b>:<br>Instances and Properties - <a href="3-iap.html#SP5_8">&#167;5.8</a></span></button></span><span class="plain">(</span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">symb_name</span><span class="plain">) {</span>
        <span class="identifier">Inter::Symbols::clear_flag</span><span class="plain">(</span><span class="identifier">symb_name</span><span class="plain">, </span><span class="identifier">TRAVERSE_MARK_BIT</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">CodeGen::clear_transients<button class="popup" onclick="togglePopup('usagePopup115')">...<span class="popuptext" id="usagePopup115">Usage of <b>CodeGen::clear_transients</b>:<br><a href="#SP8_1">&#167;8.1</a></span></button></span><span class="plain">(</span><span class="identifier">inter_tree</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain">, </span><span class="identifier">inter_tree_node</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">, </span><span class="reserved">void</span><span class="plain"> *</span><span class="identifier">state</span><span class="plain">) {</span>
        <span class="identifier">inter_package</span><span class="plain"> *</span><span class="identifier">pack</span><span class="plain"> = </span><span class="identifier">Inter::Package::defined_by_frame</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">);</span>
        <span class="identifier">inter_symbols_table</span><span class="plain"> *</span><span class="identifier">T</span><span class="plain"> = </span><span class="identifier">Inter::Packages::scope</span><span class="plain">(</span><span class="identifier">pack</span><span class="plain">);</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">T</span><span class="plain">-&gt;</span><span class="identifier">size</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">T</span><span class="plain">-&gt;</span><span class="identifier">symbol_array</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">])</span>
                <span class="identifier">Inter::Symbols::clear_transient_flags</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">-&gt;</span><span class="identifier">symbol_array</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">]);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><i>(This section begins Chapter 3: Inter to Final Code.)</i></li><li><a href="3-fc.html">Continue with 'Frame Control'</a></li></ul><hr class="tocbar">
<!--End of weave-->
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
		</main>
	</body>
</html>

