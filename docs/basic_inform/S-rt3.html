<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>S/rt2</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of 'S/rt3' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">basic_inform Template Library</a></li><li><b>RTP Template</b></li></ul><p class="purpose">To issue run-time problem messages, and to perform some run-time type checking which may issue such messages.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Reporting</a></li><li><a href="#SP2">&#167;2. Low-Level Errors</a></li><li><a href="#SP3">&#167;3. Argument Type Checking Failed</a></li><li><a href="#SP4">&#167;4. Return Type Checking Failed</a></li><li><a href="#SP5">&#167;5. Whether Provides</a></li><li><a href="#SP6">&#167;6. Scan Property Metadata</a></li><li><a href="#SP7">&#167;7. Get Either-Or Property</a></li><li><a href="#SP8">&#167;8. Set Either-Or Property</a></li><li><a href="#SP9">&#167;9. Value Property</a></li><li><a href="#SP10">&#167;10. Write Value Property</a></li><li><a href="#SP11">&#167;11. Printing Property Names</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Reporting. </b>All RTPs are produced by calling the following routine, which takes one
compulsory argument: <code class="display"><span class="extract">n</span></code>, the RTP number. When I7 is being used with the
Inform user interface, it's important that these numbers correspond to the
explanatory web pages stored within the interface application: those in
turn are created by the <code class="display"><span class="extract">inrtps</span></code> utility. The interface knows to display
these pages because it parses the printed output during play to look for
the text layout produced by the following routine: so do not reformat
RTPs without ensuring that corresponding changes have been made to the
Inform user interface applications.
</p>

<p class="inwebparagraph">The arguments <code class="display"><span class="extract">par1</span></code>, <code class="display"><span class="extract">par2</span></code> and <code class="display"><span class="extract">par3</span></code> are optional parameters clarifying the
message; <code class="display"><span class="extract">ln</span></code> is an optional parameter specifying a paragraph number in the
original source text (though in fact I7 does not use this at present).
</p>


<pre class="display">
    <span class="plain">Array RTP_Buffer --&gt; 7;</span>
    <span class="plain">[ RunTimeProblem n par1 par2 par3 ln file;</span>
        <span class="plain">if (RTP_Buffer--&gt;0 == -1) {</span>
            <span class="plain">RTP_Buffer--&gt;0 = n;</span>
            <span class="plain">RTP_Buffer--&gt;1 = par1;</span>
            <span class="plain">RTP_Buffer--&gt;2 = par2;</span>
            <span class="plain">RTP_Buffer--&gt;3 = par3;</span>
            <span class="plain">RTP_Buffer--&gt;4 = ln;</span>
            <span class="plain">RTP_Buffer--&gt;5 = file;</span>
        <span class="plain">}</span>
        <span class="plain">RunTimeProblemShow();</span>
    <span class="plain">];</span>
    <span class="plain">[ ClearRTP;</span>
        <span class="plain">RTP_Buffer--&gt;0 = -1;</span>
        <span class="plain">RTP_Buffer--&gt;6 = false;</span>
    <span class="plain">];</span>
    <span class="plain">[ SuspendRTP;</span>
        <span class="plain">RTP_Buffer--&gt;6 = true;</span>
    <span class="plain">];</span>
    <span class="plain">[ ResumeRTP;</span>
        <span class="plain">RTP_Buffer--&gt;6 = false;</span>
    <span class="plain">];</span>
    <span class="plain">[ RunTimeProblemShow   n par1 par2 par3 ln file i c;</span>
        <span class="plain">if (RTP_Buffer--&gt;0 == -1 or -2) return;</span>
        <span class="plain">if (RTP_Buffer--&gt;6) return;</span>

        <span class="plain">n = RTP_Buffer--&gt;0;</span>
        <span class="plain">par1 = RTP_Buffer--&gt;1;</span>
        <span class="plain">par2 = RTP_Buffer--&gt;2;</span>
        <span class="plain">par3 = RTP_Buffer--&gt;3;</span>
        <span class="plain">ln = RTP_Buffer--&gt;4;</span>
        <span class="plain">file = RTP_Buffer--&gt;5;</span>
        <span class="plain">RTP_Buffer--&gt;0 = -2;</span>

        <span class="plain">new_line;</span>
        <span class="plain">print "*** Run-time problem P", n;</span>
        <span class="plain">if (ln) {</span>
            <span class="plain">print " (at paragraph ", ln, " in ";</span>
            <span class="plain">if (file == 0) print "the source text";</span>
            <span class="plain">else ShowOneExtension(file);</span>
            <span class="plain">print ")";</span>
        <span class="plain">}</span>
        <span class="plain">print ": ";</span>
        <span class="plain">switch(n) {</span>
            <span class="plain">RTP_BACKDROP:</span>
                <span class="plain">print "Tried to move ", (the) par1, " (a backdrop) to ", (the) par2,</span>
                    <span class="plain">", which is not a region.^";</span>
            <span class="plain">RTP_CANTCHANGE:</span>
                <span class="plain">print "Tried to change player to ", (the) par1, ", which is not a person.^";</span>
            <span class="plain">RTP_NOEXIT:</span>
                <span class="plain">print "Tried to change ", (the) par2, " exit of ", (the) par1,</span>
                    <span class="plain">", but it didn't seem to have such an exit to change.^";</span>
            <span class="plain">RTP_EXITDOOR:</span>
                <span class="plain">print "Tried to change ", (the) par2, " exit of ", (the) par1,</span>
                    <span class="plain">", but it led to a door, not a room.^";</span>
            <span class="plain">RTP_IMPREL:</span>
                <span class="plain">print "Tried to access an inappropriate relation for ", (the) par1,</span>
                    <span class="plain">", violating '", (string) RlnGetF(par2, RR_DESCRIPTION), "'.^";</span>
            <span class="plain">RTP_TOOMANYRULEBOOKS:</span>
                <span class="plain">print "Too many rulebooks in simultaneous use.^";</span>
            <span class="plain">RTP_TOOMANYEVENTS:</span>
                <span class="plain">print "Too many timed events are going on at once.^";</span>
            <span class="plain">RTP_BADPROPERTY:</span>
                <span class="plain">print "Tried to access non-existent property for ", (the) par1, ".^";</span>
            <span class="plain">RTP_UNPROVIDED:</span>
                <span class="plain">print "Since ", (the) par1, " is not allowed the property ~",</span>
                        <span class="plain">(string) par2, "~, it is against the rules to try to use it.^";</span>
            <span class="plain">RTP_UNSET:</span>
                <span class="plain">print "Although ", (the) par1, " is allowed to have the property ~",</span>
                    <span class="plain">(string) par2, "~, no value was ever given, so it can't now be used.^";</span>
            <span class="plain">RTP_TOOMANYACTS:</span>
                <span class="plain">print "Too many activities are going on at once.^";</span>
            <span class="plain">RTP_CANTABANDON:</span>
                <span class="plain">print "Tried to abandon an activity which wasn't going on.^";</span>
            <span class="plain">RTP_CANTEND:</span>
                <span class="plain">print "Tried to end an activity which wasn't going on.^";</span>
            <span class="plain">RTP_CANTMOVENOTHING:</span>
                <span class="plain">print "You can't move nothing.^";</span>
            <span class="plain">RTP_CANTREMOVENOTHING:</span>
                <span class="plain">print "You can't remove nothing from play.^";</span>
            <span class="plain">RTP_DIVZERO:</span>
                <span class="plain">print "You can't divide by zero.^";</span>
            <span class="plain">RTP_BADVALUEPROPERTY:</span>
                <span class="plain">print "Tried to access property for a value which didn't fit: ",</span>
                    <span class="plain">"if this were a number it would be ", par1, ".^";</span>
            <span class="plain">RTP_NOTBACKDROP:</span>
                <span class="plain">print "Tried to move ", (the) par1, " (not a backdrop) to ", (the) par2,</span>
                    <span class="plain">", which is a region.^";</span>
            <span class="plain">RTP_TABLE_NOCOL:</span>
                <span class="plain">print "Attempt to look up a non-existent column in the table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_NOCORR:</span>
                <span class="plain">print "Attempt to look up a non-existent correspondence in the table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_NOROW:</span>
                <span class="plain">print "Attempt to look up a non-existent row in the table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_NOENTRY:</span>
                <span class="plain">print "Attempt to look up a non-existent entry at column ", par2,</span>
                    <span class="plain">", row ", par3, " of the table '", (PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_NOTABLE:</span>
                <span class="plain">print "Attempt to blank out a row from a non-existent table (value ",</span>
                    <span class="plain">par1, ").^";</span>
            <span class="plain">RTP_TABLE_NOTABLE2:</span>
                <span class="plain">print "Attempt to access an entry from a non-existent table.^";</span>
            <span class="plain">RTP_TABLE_NOMOREBLANKS:</span>
                <span class="plain">print "Attempt to choose a blank row in a table with none left: table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_NOROWS:</span>
                <span class="plain">print "Attempt to choose a random row in an entirely blank table: table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_CANTRUNTHROUGH:</span>
                <span class="plain">print "Attempt to repeat through a table in a tricky column order: table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_CANTSORT:</span>
                <span class="plain">print "Attempt to sort a table whose ordering must remain fixed: table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_CANTSAVE:</span>
                <span class="plain">print "Attempt to save a table to a file whose data is unstable: table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_WONTFIT:</span>
                <span class="plain">print "File being read has too many rows or columns to fit into table: table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_TABLE_BADFILE:</span>
                <span class="plain">print "File being read is not a previously saved table: table '",</span>
                    <span class="plain">(PrintTableName) par1, "'.^";</span>
            <span class="plain">RTP_NOTINAROOM:</span>
                <span class="plain">print "Attempt to test if the current location is '",</span>
                    <span class="plain">(the) par1, "', which is not a room or region.^";</span>
            <span class="plain">RTP_BADTOPIC:</span>
                <span class="plain">print "Attempt to see if a snippet of text matches something which</span>
                    <span class="plain">is not a topic.^";</span>
            <span class="plain">RTP_ROUTELESS:</span>
                <span class="plain">print "Attempt to find route or count steps through an implicit</span>
                    <span class="plain">relation.^";</span>
            <span class="plain">RTP_PROPOFNOTHING:</span>
                <span class="plain">print "Attempt to use a property of the 'nothing' non-object: property ",</span>
                    <span class="plain">(PrintPropertyName) par2, "^";</span>
            <span class="plain">RTP_DECIDEONWRONGKIND:</span>
                <span class="plain">print "Attempt to 'decide on V' where V is the wrong kind of object.^";</span>
            <span class="plain">RTP_DECIDEONNOTHING:</span>
                <span class="plain">print "Attempt to 'decide on nothing'.^";</span>
            <span class="plain">RTP_LOWLEVELERROR:</span>
                <span class="plain">print "Low level error.^";</span>
            <span class="plain">RTP_DONTIGNORETURNSEQUENCE:</span>
                <span class="plain">print "Attempt to ignore the turn sequence rules.^";</span>
            <span class="plain">RTP_SAYINVALIDSNIPPET:</span>
                <span class="plain">print "Attempt to say a snippet value which is currently invalid: words ",</span>
                    <span class="plain">par1, " to ", par2, ".^";</span>
            <span class="plain">RTP_SPLICEINVALIDSNIPPET:</span>
                <span class="plain">print "Attempt to splice a snippet value which is currently invalid: words ",</span>
                    <span class="plain">par1, " to ", par2, ".^";</span>
            <span class="plain">RTP_INCLUDEINVALIDSNIPPET:</span>
                <span class="plain">print "Attempt to match a snippet value which is currently invalid: words ",</span>
                    <span class="plain">par1, " to ", par2, ".^";</span>
            <span class="plain">RTP_LISTWRITERMEMORY:</span>
                <span class="plain">print "The list-writer has run out of memory.^";</span>
            <span class="plain">RTP_CANTREMOVEPLAYER:</span>
                <span class="plain">print "Attempt to remove the player from play.^";</span>
            <span class="plain">RTP_CANTBEOFFSTAGE:</span>
                <span class="plain">print "Attempt to move the player off-stage.^";</span>
            <span class="plain">RTP_CANTREMOVEDOORS:</span>
                <span class="plain">print "Attempt to remove a door from play.^";</span>
            <span class="plain">RTP_CANTCHANGEOFFSTAGE:</span>
                <span class="plain">print "Attempt to change the player to a person off-stage.^";</span>
            <span class="plain">RTP_MSTACKMEMORY:</span>
                <span class="plain">print "The memory stack is exhausted.^";</span>
            <span class="plain">RTP_TYPECHECK:</span>
                <span class="plain">print "Phrase applied to an incompatible kind of value.^";</span>
            <span class="plain">RTP_FILEIOERROR:</span>
                <span class="plain">print "Error handling external file.^";</span>
            <span class="plain">RTP_HEAPERROR:</span>
                <span class="plain">print "Memory allocation proved impossible.^";</span>
            <span class="plain">RTP_LISTRANGEERROR:</span>
                <span class="plain">print "Attempt to use list item which does not exist.^";</span>
            <span class="plain">RTP_LISTSIZENEGATIVE:</span>
                <span class="plain">print "Attempt to resize list to ", par1, " entries - there must ",</span>
                <span class="plain">"always be 0 or more.^";</span>
            <span class="plain">RTP_REGEXPSYNTAXERROR:</span>
                <span class="plain">print "Syntax error in regular expression.^";</span>
            <span class="plain">RTP_NOGLULXUNICODE:</span>
                <span class="plain">print "This interpreter does not support Unicode.^";</span>
            <span class="plain">RTP_BACKDROPONLY:</span>
                <span class="plain">print "Only backdrops can be moved to multiple places.^";</span>
            <span class="plain">RTP_NOTTHING:</span>
                <span class="plain">print "Tried to move ", (the) par1, " (not a thing) to ", (the) par2,</span>
                    <span class="plain">", but only things can move around.^";</span>
            <span class="plain">RTP_NEGATIVEROOT:</span>
                <span class="plain">print "You can't take the square root of a negative number.^";</span>
            <span class="plain">RTP_CANTITERATE:</span>
                <span class="plain">print "You can't implicitly repeat through the values of this kind: ",</span>
                    <span class="plain">"a problem arising from a description which started out here - ~",</span>
                    <span class="plain">(string) par1, "~.^";</span>
            <span class="plain">RTP_WRONGASSIGNEDKIND:</span>
                <span class="plain">print "Attempt to set a variable to the wrong kind of object: ",</span>
                    <span class="plain">"you wrote '", (string) par2, "', which sets the value to ", (the) par1,</span>
                    <span class="plain">" - but that doesn't have the kind '", (string) par3, "'.^";</span>
            <span class="plain">RTP_RELKINDVIOLATION:</span>
                <span class="plain">print "Tried to change a relation for objects with the wrong kinds: ",</span>
                    <span class="plain">(string) RlnGetF(par3, RR_DESCRIPTION), ", but you tried to ",</span>
                    <span class="plain">"relate (or unrelate) ", (the) par1, " to ", (the) par2, ".^";</span>
            <span class="plain">RTP_CANTMAKEPART:</span>
                <span class="plain">print "Tried to make the player part of something: ",</span>
                    <span class="plain">(the) par1, ".^";</span>
            <span class="plain">RTP_TEXTTOKENTOOHARD:</span>
                <span class="plain">print "This use of '[text]' is too complicated.^";</span>
            <span class="plain">RTP_RELATIONCHANGEIMPOSSIBLE:</span>
                <span class="plain">print "This change of the relation's nature is impossible in play.^";</span>
            <span class="plain">RTP_RELMINIMAL:</span>
                <span class="plain">print "This operation can't be done with the relation '",</span>
                    <span class="plain">(string) RlnGetF(par3, RR_DESCRIPTION), "'.^";</span>
            <span class="plain">RTP_REGIONSNOTADJACENT:</span>
                <span class="plain">print "You can't test whether something is adjacent to a region: ",</span>
                    <span class="plain">"such as, in this case, ", (the) par1, ".^";</span>
        <span class="plain">}</span>
        <span class="plain">RunTimeProblemShowWM(n, par1, par2, par3);</span>
        <span class="plain">print "^";</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. Low-Level Errors. </b>The following is a residue from the old I6 library, and most of its possible
messages can't be seen in I7 use &mdash; for instance I7 has no timers or daemons,
so error 4 is out of the question. But we retain the routine because the
veneer code added by I6 requires it to be present.
</p>


<pre class="display">
    <span class="plain">Constant MAX_TIMERS = 0;</span>
    <span class="plain">[ RunTimeError n p1 p2;</span>
        <span class="plain">#Ifdef DEBUG;</span>
        <span class="plain">print "** Library error ", n, " (", p1, ",", p2, ") **^** ";</span>
        <span class="plain">switch (n) {</span>
        <span class="plain">1:    print "preposition not found (this should not occur)";</span>
        <span class="plain">2:    print "Property value not routine or string: ~", (property) p2, "~ of ~", (name) p1,</span>
                    <span class="plain">"~ (", p1, ")";</span>
        <span class="plain">3:    print "Entry in property list not routine or string: ~", (property) p2, "~ list of ~",</span>
                    <span class="plain">(name) p1, "~ (", p1, ")";</span>
        <span class="plain">4:    print "Too many timers/daemons are active simultaneously.</span>
                    <span class="plain">The limit is the library constant MAX_TIMERS (currently ",</span>
                    <span class="plain">MAX_TIMERS, ") and should be increased";</span>
        <span class="plain">5:    print "Object ~", (name) p1, "~ has no ~time_left~ property";</span>
        <span class="plain">7:    print "The object ~", (name) p1, "~ can only be used as a player object if it has</span>
                    <span class="plain">the ~number~ property";</span>
        <span class="plain">8:    print "Attempt to take random entry from an empty table array";</span>
        <span class="plain">9:    print p1, " is not a valid direction property number";</span>
        <span class="plain">10:   print "The player-object is outside the object tree";</span>
        <span class="plain">11:   print "The room ~", (name) p1, "~ has no ~description~ property";</span>
        <span class="plain">12:   print "Tried to set a non-existent pronoun using SetPronoun";</span>
        <span class="plain">13:   print "A 'topic' token can only be followed by a preposition";</span>
        <span class="plain">default: print "(unexplained)";</span>
        <span class="plain">}</span>
        <span class="plain">print " **^";</span>
        <span class="plain">#Ifnot;</span>
        <span class="plain">print "** Library error ", n, " (", p1, ",", p2, ") **^";</span>
        <span class="plain">#Endif; ! DEBUG</span>
        <span class="plain">RunTimeProblem(RTP_LOWLEVELERROR);</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. Argument Type Checking Failed. </b>This is called when run-time type checking for the argument of a phrase
fails, so that no definition for the phrase can be applied.
</p>


<pre class="display">
    <span class="plain">[ ArgumentTypeFailed line file;</span>
        <span class="plain">RunTimeProblem(RTP_TYPECHECK, 0, 0, 0, line, file);</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Return Type Checking Failed. </b>Similarly, though in a more restricted set of circumstances. NI can usually
prove that the value returned by a phrase matches its supposed kind, but
because of the deliberately weak type-checking within the kind of value
"object" it will allow a broader kind of object to be returned when the
requirement is for a narrower one. In such cases, it checks the result with
the following routine. The value <code class="display"><span class="extract">V</span></code> is a valid "object", but that means
it can be <code class="display"><span class="extract">nothing</span></code>, and we must check that it matches a given I7 kind <code class="display"><span class="extract">K</span></code>
(where <code class="display"><span class="extract">nothing</span></code> is not valid).
</p>


<pre class="display">
    <span class="plain">[ CheckKindReturned V K;</span>
        <span class="plain">if (V ofclass K) return V;</span>
        <span class="plain">if (V == nothing) RunTimeProblem(RTP_DECIDEONNOTHING);</span>
        <span class="plain">else RunTimeProblem(RTP_DECIDEONWRONGKIND);</span>
        <span class="plain">return V;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Whether Provides. </b>This routine defines the phrase "if O provides P": there are three tests
to pass, and if any of the three fail, we return <code class="display"><span class="extract">false</span></code>. (The <code class="display"><span class="extract">issue_rtp</span></code>
flag, causing RTPs to be issued depending on which test fails, is never set
when the routine is simply testing the condition.)
</p>

<p class="inwebparagraph">Firstly, P has to be a property known to I7. Secondly, there has to be
permission either for this individual object to have it, or for its kind to
have it, or its kind's kind, and so on. Thirdly, the object has to actually
have the property in question at an I6 level &mdash; having permission to have
it doesn't mean it actually does have.
</p>


<pre class="display">
    <span class="plain">[ WhetherProvides obj either_or p issue_rtp  off i textual a l;</span>
        <span class="plain">if (metaclass(obj) ~= Object) rfalse;</span>
        <span class="plain">if (p&lt;0) p = ~p;</span>
        <span class="plain">if (either_or) {</span>
            <span class="plain">if (p &lt; FBNA_PROP_NUMBER) off = attributed_property_offsets--&gt;p;</span>
            <span class="plain">else off = valued_property_offsets--&gt;p;</span>
        <span class="plain">} else off = valued_property_offsets--&gt;p;</span>
        <span class="plain">if (off&lt;0) {</span>
            <span class="plain">if (issue_rtp) RunTimeProblem(RTP_BADPROPERTY, obj);</span>
            <span class="plain">rfalse;</span>
        <span class="plain">}</span>
        <span class="plain">textual = property_metadata--&gt;off; off++;</span>

        <span class="plain">if (ScanPropertyMetadata(obj, off)) jump PermissionFound;</span>
        <span class="plain">if (obj provides KD_Count) {</span>
            <span class="plain">l = obj.KD_Count;</span>
            <span class="plain">while (l &gt; 0) {</span>
                <span class="plain">a = l*2;</span>
                <span class="plain">if (ScanPropertyMetadata(KindHierarchy--&gt;a, off)) jump PermissionFound;</span>
                <span class="plain">l = KindHierarchy--&gt;(a+1);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="plain">if (issue_rtp) RunTimeProblem(RTP_UNPROVIDED, obj, textual);</span>
        <span class="plain">rfalse;</span>

        <span class="plain">.PermissionFound;</span>
            <span class="plain">if (either_or) rtrue;</span>
            <span class="plain">if (obj provides p) rtrue;</span>
            <span class="plain">if (issue_rtp) RunTimeProblem(RTP_UNSET, obj, textual);</span>
            <span class="plain">rfalse;</span>
    <span class="plain">];</span>

    <span class="plain">[ PrintPropertyName  p  off textual;</span>
        <span class="plain">if (p&lt;0) p = ~p;</span>
        <span class="plain">off = valued_property_offsets--&gt;p;</span>
        <span class="plain">textual = property_metadata--&gt;off;</span>
        <span class="plain">print (string) textual;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6. Scan Property Metadata. </b>The <code class="display"><span class="extract">property_metadata</span></code> table is a series of zero-terminated lists of objects
(or class objects, representing I7 kinds). Each list corresponds to a single
property; the position in the table is called the "offset" for the property.
The following searches from a given offset.
</p>


<pre class="display">
    <span class="plain">[ ScanPropertyMetadata obj off i;</span>
        <span class="plain">for (i=off: property_metadata--&gt;i &gt;= 0: i++)</span>
            <span class="plain">if (obj == property_metadata--&gt;i) rtrue;</span>
        <span class="plain">rfalse;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7. Get Either-Or Property. </b>If <code class="display"><span class="extract">p</span></code> represents a property, then <code class="display"><span class="extract">~p</span></code> (its bitwise negation) represents its
logical negation. The bitwise negation will change the sign bit; since all
properties are ordinarily positive, we can detect bitwise negation by looking
for negative property numbers. (This could fail on Glulx story files above
1GB in size, but that's about 1000 times the size of the record-sized file
created thus far.)
</p>

<p class="inwebparagraph">FBNA stands for First Boolean Not to be an Attribute, in the I6 sense. Some
either/or (i.e., boolean) properties are stored as I6 attributes, others as
I6 properties whose values are always <code class="display"><span class="extract">true</span></code> or <code class="display"><span class="extract">false</span></code>.
</p>

<p class="inwebparagraph">Note that we allow either/or properties to be read for any object,
regardless of permissions, returning <code class="display"><span class="extract">false</span></code> if the object does not have
the property. This is so that a description such as "open things" can be
applied against any object without run-time errors, even though it is only
normally valid for doors and containers.
</p>


<pre class="display">
    <span class="plain">[ GetEitherOrProperty o p;</span>
        <span class="plain">if (o == nothing) rfalse;</span>
        <span class="plain">if (p&lt;0) p = ~p;</span>
        <span class="plain">if (WhetherProvides(o, true, p, false)) {</span>
            <span class="plain">if (p&lt;FBNA_PROP_NUMBER) { if (o has p) rtrue; rfalse; }</span>
            <span class="plain">if ((o provides p) &amp;&amp; (o.p)) rtrue;</span>
        <span class="plain">}</span>
        <span class="plain">rfalse;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8. Set Either-Or Property. </b>An attempt to write an either/or property which is not provided will,
however, always produce a run-time problem.
</p>


<pre class="display">
    <span class="plain">[ SetEitherOrProperty o p negate adj;</span>
        <span class="plain">if (p&lt;0) { p = ~p; negate = ~negate; }</span>
        <span class="plain">if (adj) {</span>
            <span class="plain">(adj)(o);</span>
        <span class="plain">} else if (WhetherProvides(o, true, p, true)) {</span>
            <span class="plain">if (negate) {</span>
                <span class="plain">if (p&lt;FBNA_PROP_NUMBER) give o ~p; else o.p = false;</span>
            <span class="plain">} else {</span>
                <span class="plain">if (p&lt;FBNA_PROP_NUMBER) give o p; else o.p = true;</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9. Value Property. </b>Some value properties belong to other values (those created in tables), and
these are detected by being properties of a special <code class="display"><span class="extract">VPH_Class</span></code> pseudo-object
<code class="display"><span class="extract">V</span></code> &mdash; an I6 object which is not part of the world model, and not a valid I7
"object" value, but which is used in order that properties belonging to values
are still I6 property numbers. <code class="display"><span class="extract">V.P</span></code> is the table column address for this
property; <code class="display"><span class="extract">obj</span></code> is then a value for the kind of value created by the table, so
it is used as an index into the table column to get the address of the memory
location storing the property value.
</p>

<p class="inwebparagraph">The <code class="display"><span class="extract">door_to</span></code> property, relevant only for doors, is called rather than read:
this enables it to be an I6 routine returning the other side of the door from
the one which the player is on.
</p>


<pre class="display">
    <span class="plain">[ GProperty K V pr obj;</span>
        <span class="plain">if (K == OBJECT_TY) obj = V; else obj = value_property_holders--&gt;K;</span>
        <span class="plain">if (obj == 0) { RunTimeProblem(RTP_PROPOFNOTHING, obj, pr); rfalse; }</span>
        <span class="plain">if (obj provides pr) {</span>
            <span class="plain">if (K == OBJECT_TY) {</span>
                <span class="plain">if (pr == door_to) return obj.pr();</span>
                <span class="plain">if (WhetherProvides(V, false, pr, true)) return obj.pr;</span>
                <span class="plain">rfalse;</span>
            <span class="plain">}</span>
            <span class="plain">if (obj ofclass K0_kind)</span>
                <span class="plain">WhetherProvides(V, false, pr, true); ! to force a run-time problem</span>
            <span class="plain">if ((V &lt; 1) || (V &gt; obj.value_range)) {</span>
                <span class="plain">RunTimeProblem(RTP_BADVALUEPROPERTY); return 0; }</span>
            <span class="plain">return (obj.pr)--&gt;(V+COL_HSIZE);</span>
        <span class="plain">} else {</span>
            <span class="plain">if (obj ofclass K0_kind)</span>
                <span class="plain">WhetherProvides(V, false, pr, true); ! to force a run-time problem</span>
        <span class="plain">}</span>
        <span class="plain">rfalse;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10. Write Value Property. </b>This routine's name must consist of the read-value-property routine's name
with the prefix <code class="display"><span class="extract">Write</span></code>, as that is how a reference to such a property is
converted from an rvalue to an lvalue.
</p>


<pre class="display">
    <span class="plain">[ WriteGProperty K V pr val obj;</span>
        <span class="plain">if (K == OBJECT_TY) obj = V; else obj = value_property_holders--&gt;K;</span>
        <span class="plain">if (obj == 0) { RunTimeProblem(RTP_PROPOFNOTHING, obj, pr); rfalse; }</span>
        <span class="plain">if (K == OBJECT_TY) {</span>
            <span class="plain">if (WhetherProvides(V, false, pr, true)) obj.pr = val;</span>
        <span class="plain">} else {</span>
            <span class="plain">if ((V &lt; 1) || (V &gt; obj.value_range))</span>
                <span class="plain">return RunTimeProblem(RTP_BADVALUEPROPERTY);</span>
            <span class="plain">if (obj provides pr) { (obj.pr)--&gt;(V+COL_HSIZE) = val; }</span>
        <span class="plain">}</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP11"></a><b>&#167;11. Printing Property Names. </b>Inform doesn't print property names prettily; it more or less prints them
only as decimal numbers.
</p>


<pre class="display">
    <span class="plain">[ PROPERTY_TY_Say v;</span>
        <span class="plain">print "property ", v;</span>
    <span class="plain">];</span>
</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><a href="S-rt2.html">Back to 'Relations Template'</a></li><li><a href="S-rt4.html">Continue with 'Rulebooks Template'</a></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

