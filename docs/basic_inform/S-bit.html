<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Booklet Title</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of 'S/bit' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">basic_inform Template Library</a></li><li><b>Basic Inform Template</b></li></ul><p class="purpose">Support for the language alone.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Contents</a></li><li><a href="#SP2">&#167;2. VM-Specific Code</a></li><li><a href="#SP3">&#167;3. More</a></li><li><a href="#SP4">&#167;4. Print Decimal Number</a></li><li><a href="#SP5">&#167;5. Print Text</a></li><li><a href="#SP6">&#167;6. Properties</a></li><li><a href="#SP7">&#167;7. Print Or Run</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Contents. </b></p>


<pre class="display">
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Definitions</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>

    <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">TARGET_ZCODE</span><span class="plain">;</span>
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">BLOCKV_STACK_SIZE</span><span class="plain"> = </span><span class="constant">224</span><span class="plain">;</span>
    <span class="plain">#</span><span class="identifier">ifnot</span><span class="plain">;</span>
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">BLOCKV_STACK_SIZE</span><span class="plain"> = </span><span class="identifier">DynamicMemoryAllocation</span><span class="plain">/4;</span>
    <span class="plain">#</span><span class="identifier">endif</span><span class="plain">;</span>

    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">blockv_stack</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="identifier">BLOCKV_STACK_SIZE</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">I7SFRAME</span><span class="plain">;</span>

    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">TEXT_TY_RE_Err</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">prior_named_noun</span><span class="plain">; </span><span class="comment">! for adaptive text generation</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">prior_named_list</span><span class="plain">; </span><span class="comment">! ditto: length of list of items</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">prior_named_list_gender</span><span class="plain">; </span><span class="comment">! ditto: common gender of list of items, or -1</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">story_tense</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! ditto: present tense</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">story_viewpoint</span><span class="plain"> = </span><span class="constant">2</span><span class="plain">; </span><span class="comment">! ditto: second person singular</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__p</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__pc</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">; </span><span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__pc_save</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__n</span><span class="plain">; </span><span class="identifier">Global</span><span class="plain"> </span><span class="identifier">say__comp</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">los_rv</span><span class="plain"> = </span><span class="reserved">false</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">parameter_object</span><span class="plain">; </span><span class="comment">! = I7 "parameter-object" = I7 "container in question"</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">parameter_value</span><span class="plain">; </span><span class="comment">! not typesafe in I7</span>
    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">deferred_calling_list</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="constant">27</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">property_to_be_totalled</span><span class="plain">; </span><span class="comment">! used to implement "total P of..."</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">property_loop_sign</span><span class="plain">; </span><span class="comment">! $+1$ for increasing order, $-1$ for decreasing</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">suppress_scope_loops</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">temporary_value</span><span class="plain">; </span><span class="comment">! can be used anywhere side-effects can't occur</span>
    <span class="comment">! [13]</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_fg</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! foreground colour</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_bg</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! background colour</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_fgstatus</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! foreground colour of statusline</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_bgstatus</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">; </span><span class="comment">! background colour of statusline</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">clr_on</span><span class="plain">; </span><span class="comment">! has colour been enabled by the player?</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">statuswin_current</span><span class="plain">; </span><span class="comment">! if writing to top window</span>

    <span class="comment">! [14]</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">statuswin_cursize</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">statuswin_size</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>

    <span class="comment">! [16]</span>
    <span class="comment">! Global debug_flag = 0;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">debug_rules</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">debug_rule_nesting</span><span class="plain">;</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">reason_the_action_failed</span><span class="plain">; </span><span class="comment">! = I7 "reason the action failed"</span>

    <span class="comment">! [3]</span>
    <span class="identifier">Global</span><span class="plain"> </span><span class="identifier">standard_interpreter</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>

    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">LocalParking</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="constant">64</span><span class="plain">;</span>

</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. VM-Specific Code. </b>These sections of code contain different definitions of the same routines,
and in some cases the same arrays, to handle low-level functions in the
virtual machine &mdash; saving the game, performing UNDO, parsing typed text into
dictionary word addresses and so on.
</p>


<pre class="display">
    <span class="plain">#</span><span class="identifier">Ifdef</span><span class="plain"> </span><span class="identifier">TARGET_GLULX</span><span class="plain">;</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Glulx</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">#</span><span class="identifier">Endif</span><span class="plain">;</span>

    <span class="plain">#</span><span class="identifier">Ifdef</span><span class="plain"> </span><span class="identifier">TARGET_ZCODE</span><span class="plain">;</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">ZMachine</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">#</span><span class="identifier">Endif</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. More. </b></p>


<pre class="display">
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Paragraphing</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Mathematics</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">FileIO</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Sort</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Tables</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">MStack</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Rulebooks</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Flex</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">BlockValues</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Text</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">RegExp</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Lists</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Combinations</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">RelationKind</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Relations</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">RTP</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>
    <span class="plain">{-</span><span class="identifier">segment</span><span class="plain">:</span><span class="identifier">Utilities</span><span class="plain">.</span><span class="identifier">i6t</span><span class="plain">}</span>

    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">Protect_I7_Arrays</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="constant">16339</span><span class="plain"> </span><span class="constant">12345</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Print Decimal Number. </b><code class="display"><span class="extract">DecimalNumber</span></code> is a trivial function which just prints a number, in decimal
digits. It is left over from the I6 library's support routines for Glulx,
where it was intended as a stub to pass to the Glulx <code class="display"><span class="extract">Glulx_PrintAnything</span></code> routine
(which I7 does not use). In I7, however, it's also used as the default
printing routine for new kinds of value.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">DecimalNumber</span><span class="plain"> </span><span class="identifier">num</span><span class="plain">; </span><span class="reserved">print</span><span class="plain"> </span><span class="identifier">num</span><span class="plain">; ];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Print Text. </b>The routine for printing an I7 "text" value, which might be text with or
without substitutions.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">PrintI6Text</span><span class="plain"> </span><span class="identifier">x</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">x</span><span class="plain"> </span><span class="reserved">ofclass</span><span class="plain"> </span><span class="identifier">String</span><span class="plain">) </span><span class="reserved">print</span><span class="plain"> (</span><span class="reserved">string</span><span class="plain">) </span><span class="identifier">x</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">x</span><span class="plain"> </span><span class="reserved">ofclass</span><span class="plain"> </span><span class="identifier">Routine</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> (</span><span class="identifier">x</span><span class="plain">)();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">x</span><span class="plain"> == </span><span class="identifier">EMPTY_TEXT_PACKED</span><span class="plain">) </span><span class="reserved">rfalse</span><span class="plain">;</span>
        <span class="reserved">rtrue</span><span class="plain">;</span>
    <span class="plain">];</span>
    <span class="plain">[ </span><span class="identifier">I7_String</span><span class="plain"> </span><span class="identifier">x</span><span class="plain">; </span><span class="identifier">TEXT_TY_Say</span><span class="plain">(</span><span class="identifier">x</span><span class="plain">); ]; </span><span class="comment">! An alternative name now used only by extensions</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6. Properties. </b>Some either/or properties are compiled to I6 attributes, which must be
predeclared, so we do that first. (All other properties can simply be
used without declaration.)
</p>

<p class="inwebparagraph">What then follows is a table of property metadata: in particular, specifying
which properties can be used with which I6 classes or objects. Policing
this at run-time costs a little speed, but traps many errors of programming,
and keeps everything typesafe. It is the price we pay for the relatively
lenient compile-time checking of I7's "object" kind of value. To make
it as efficient as possible, we calculate offsets into the metadata: this
has to be done (once) at run-time, with the routine compiled.
</p>


<pre class="display">
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">attributed_property_offsets_SIZE</span><span class="plain"> </span><span class="constant">48</span><span class="plain">;</span>
    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">attributed_property_offsets</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="identifier">attributed_property_offsets_SIZE</span><span class="plain">;</span>
    <span class="reserved">Constant</span><span class="plain"> </span><span class="identifier">valued_property_offsets_SIZE</span><span class="plain"> (100 + </span><span class="identifier">CCOUNT_PROPERTY</span><span class="plain"> + </span><span class="identifier">INDIV_PROP_START</span><span class="plain">-48);</span>
    <span class="reserved">Array</span><span class="plain"> </span><span class="identifier">valued_property_offsets</span><span class="plain"> </span><span class="constant">--</span><span class="plain">&gt; </span><span class="identifier">valued_property_offsets_SIZE</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7. Print Or Run. </b>This utility remains from the old I6 library: it essentially treats a
property as textual and prints it where possible. Where the <code class="display"><span class="extract">no_break</span></code>
flag is set, we expect the text to form only a small part of a paragraph,
and it's inappropriate to break here: for instance, for printing the
"printed name" of an object. Where the flag is clear, however, the text
is expected to form its own paragraph.
</p>

<p class="inwebparagraph">Where <code class="display"><span class="extract">PrintOrRun</span></code> is used in breaking mode, which is only for a very few
properties in I7 (indeed at present only <code class="display"><span class="extract">initial</span></code> and <code class="display"><span class="extract">description</span></code>),
the routine called is given the chance to decide whether to print or not.
It should return <code class="display"><span class="extract">true</span></code> or <code class="display"><span class="extract">false</span></code> according to whether it did so; this
allows us to divide the paragraph or not accordingly.
</p>


<pre class="display">
    <span class="plain">[ </span><span class="identifier">PrintOrRun</span><span class="plain"> </span><span class="identifier">obj</span><span class="plain"> </span><span class="identifier">prop</span><span class="plain"> </span><span class="identifier">no_break</span><span class="plain">  </span><span class="identifier">pv</span><span class="plain"> </span><span class="identifier">st</span><span class="plain"> </span><span class="identifier">routine_return_value</span><span class="plain">;</span>
        <span class="plain">@</span><span class="identifier">push</span><span class="plain"> </span><span class="identifier">self</span><span class="plain">; </span><span class="identifier">self</span><span class="plain"> = </span><span class="identifier">obj</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">prop</span><span class="plain"> == </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="reserved">print</span><span class="plain"> (</span><span class="identifier">name</span><span class="plain">) </span><span class="identifier">prop</span><span class="plain">; </span><span class="identifier">routine_return_value</span><span class="plain"> = </span><span class="reserved">true</span><span class="plain">;</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">routine_return_value</span><span class="plain"> = </span><span class="identifier">TEXT_TY_Say</span><span class="plain">(</span><span class="identifier">obj</span><span class="plain">.</span><span class="identifier">prop</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="plain">@</span><span class="identifier">pull</span><span class="plain"> </span><span class="identifier">self</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">routine_return_value</span><span class="plain">) {</span>
            <span class="identifier">say__p</span><span class="plain"> = </span><span class="constant">1</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no_break</span><span class="plain"> == </span><span class="reserved">false</span><span class="plain">) {</span>
                <span class="reserved">new_line</span><span class="plain">;</span>
                <span class="identifier">DivideParagraphPoint</span><span class="plain">();</span>
            <span class="plain">}</span>
        <span class="plain">}</span>

        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">routine_return_value</span><span class="plain">;</span>
    <span class="plain">];</span>

    <span class="plain">[ </span><span class="identifier">DA_Number</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">; </span><span class="reserved">print</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">; ];</span>
    <span class="plain">[ </span><span class="identifier">DA_TruthState</span><span class="plain"> </span><span class="identifier">n</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">n</span><span class="plain">==0) </span><span class="reserved">print</span><span class="plain"> </span><span class="string">"false"</span><span class="plain">; </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">print</span><span class="plain"> </span><span class="string">"true"</span><span class="plain">; ];</span>

</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><i>(This section begins Sections.)</i></li><li><a href="S-bt.html">Continue with 'BlockValues Template'</a></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

