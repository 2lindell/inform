<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Booklet Title</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of 'S/bit' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">basic_inform Template Library</a></li><li><b>Basic Inform Template</b></li></ul><p class="purpose">Support for the language alone.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Contents</a></li><li><a href="#SP2">&#167;2. VM-Specific Code</a></li><li><a href="#SP3">&#167;3. More</a></li><li><a href="#SP4">&#167;4. Print Decimal Number</a></li><li><a href="#SP5">&#167;5. Print Text</a></li><li><a href="#SP6">&#167;6. Properties</a></li><li><a href="#SP7">&#167;7. Print Or Run</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Contents. </b></p>


<pre class="display">
    <span class="plain">{-segment:Definitions.i6t}</span>

    <span class="plain">#ifdef TARGET_ZCODE;</span>
    <span class="plain">Constant BLOCKV_STACK_SIZE = 224;</span>
    <span class="plain">#ifnot;</span>
    <span class="plain">Constant BLOCKV_STACK_SIZE = DynamicMemoryAllocation/4;</span>
    <span class="plain">#endif;</span>

    <span class="plain">Array blockv_stack --&gt; BLOCKV_STACK_SIZE;</span>
    <span class="plain">Global I7SFRAME;</span>

    <span class="plain">Global TEXT_TY_RE_Err = 0;</span>
    <span class="plain">Global prior_named_noun; ! for adaptive text generation</span>
    <span class="plain">Global prior_named_list; ! ditto: length of list of items</span>
    <span class="plain">Global prior_named_list_gender; ! ditto: common gender of list of items, or -1</span>
    <span class="plain">Global story_tense = 1; ! ditto: present tense</span>
    <span class="plain">Global story_viewpoint = 2; ! ditto: second person singular</span>
    <span class="plain">Global say__p = 1; Global say__pc = 0; Global say__pc_save = 0;</span>
    <span class="plain">Global say__n; Global say__comp;</span>
    <span class="plain">Global los_rv = false;</span>
    <span class="plain">Global parameter_object; ! = I7 "parameter-object" = I7 "container in question"</span>
    <span class="plain">Global parameter_value; ! not typesafe in I7</span>
    <span class="plain">Array deferred_calling_list --&gt; 27;</span>
    <span class="plain">Global property_to_be_totalled; ! used to implement "total P of..."</span>
    <span class="plain">Global property_loop_sign; ! $+1$ for increasing order, $-1$ for decreasing</span>
    <span class="plain">Global suppress_scope_loops;</span>
    <span class="plain">Global temporary_value; ! can be used anywhere side-effects can't occur</span>
    <span class="plain">! [13]</span>
    <span class="plain">Global clr_fg = 1; ! foreground colour</span>
    <span class="plain">Global clr_bg = 1; ! background colour</span>
    <span class="plain">Global clr_fgstatus = 1; ! foreground colour of statusline</span>
    <span class="plain">Global clr_bgstatus = 1; ! background colour of statusline</span>
    <span class="plain">Global clr_on; ! has colour been enabled by the player?</span>
    <span class="plain">Global statuswin_current; ! if writing to top window</span>

    <span class="plain">! [14]</span>
    <span class="plain">Global statuswin_cursize = 0;</span>
    <span class="plain">Global statuswin_size = 1;</span>

    <span class="plain">! [16]</span>
    <span class="plain">! Global debug_flag = 0;</span>
    <span class="plain">Global debug_rules = 0;</span>
    <span class="plain">Global debug_rule_nesting;</span>
    <span class="plain">Global reason_the_action_failed; ! = I7 "reason the action failed"</span>

    <span class="plain">! [3]</span>
    <span class="plain">Global standard_interpreter = 0;</span>

    <span class="plain">Array LocalParking --&gt; 64;</span>

</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. VM-Specific Code. </b>These sections of code contain different definitions of the same routines,
and in some cases the same arrays, to handle low-level functions in the
virtual machine &mdash; saving the game, performing UNDO, parsing typed text into
dictionary word addresses and so on.
</p>


<pre class="display">
    <span class="plain">#Ifdef TARGET_GLULX;</span>
    <span class="plain">{-segment:Glulx.i6t}</span>
    <span class="plain">#Endif;</span>

    <span class="plain">#Ifdef TARGET_ZCODE;</span>
    <span class="plain">{-segment:ZMachine.i6t}</span>
    <span class="plain">#Endif;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. More. </b></p>


<pre class="display">
    <span class="plain">{-segment:Paragraphing.i6t}</span>
    <span class="plain">{-segment:Mathematics.i6t}</span>
    <span class="plain">{-segment:FileIO.i6t}</span>
    <span class="plain">{-segment:Sort.i6t}</span>
    <span class="plain">{-segment:Tables.i6t}</span>
    <span class="plain">{-segment:MStack.i6t}</span>
    <span class="plain">{-segment:Rulebooks.i6t}</span>
    <span class="plain">{-segment:Flex.i6t}</span>
    <span class="plain">{-segment:BlockValues.i6t}</span>
    <span class="plain">{-segment:Text.i6t}</span>
    <span class="plain">{-segment:RegExp.i6t}</span>
    <span class="plain">{-segment:Lists.i6t}</span>
    <span class="plain">{-segment:Combinations.i6t}</span>
    <span class="plain">{-segment:RelationKind.i6t}</span>
    <span class="plain">{-segment:Relations.i6t}</span>
    <span class="plain">{-segment:RTP.i6t}</span>
    <span class="plain">{-segment:Utilities.i6t}</span>

    <span class="plain">Array Protect_I7_Arrays --&gt; 16339 12345;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4. Print Decimal Number. </b><code class="display"><span class="extract">DecimalNumber</span></code> is a trivial function which just prints a number, in decimal
digits. It is left over from the I6 library's support routines for Glulx,
where it was intended as a stub to pass to the Glulx <code class="display"><span class="extract">Glulx_PrintAnything</span></code> routine
(which I7 does not use). In I7, however, it's also used as the default
printing routine for new kinds of value.
</p>


<pre class="display">
    <span class="plain">[ DecimalNumber num; print num; ];</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Print Text. </b>The routine for printing an I7 "text" value, which might be text with or
without substitutions.
</p>


<pre class="display">
    <span class="plain">[ PrintI6Text x;</span>
        <span class="plain">if (x ofclass String) print (string) x;</span>
        <span class="plain">if (x ofclass Routine) return (x)();</span>
        <span class="plain">if (x == EMPTY_TEXT_PACKED) rfalse;</span>
        <span class="plain">rtrue;</span>
    <span class="plain">];</span>
    <span class="plain">[ I7_String x; TEXT_TY_Say(x); ]; ! An alternative name now used only by extensions</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6. Properties. </b>Some either/or properties are compiled to I6 attributes, which must be
predeclared, so we do that first. (All other properties can simply be
used without declaration.)
</p>

<p class="inwebparagraph">What then follows is a table of property metadata: in particular, specifying
which properties can be used with which I6 classes or objects. Policing
this at run-time costs a little speed, but traps many errors of programming,
and keeps everything typesafe. It is the price we pay for the relatively
lenient compile-time checking of I7's "object" kind of value. To make
it as efficient as possible, we calculate offsets into the metadata: this
has to be done (once) at run-time, with the routine compiled.
</p>


<pre class="display">
    <span class="plain">Constant attributed_property_offsets_SIZE 48;</span>
    <span class="plain">Array attributed_property_offsets --&gt; attributed_property_offsets_SIZE;</span>
    <span class="plain">Constant valued_property_offsets_SIZE (100 + CCOUNT_PROPERTY + INDIV_PROP_START-48);</span>
    <span class="plain">Array valued_property_offsets --&gt; valued_property_offsets_SIZE;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7. Print Or Run. </b>This utility remains from the old I6 library: it essentially treats a
property as textual and prints it where possible. Where the <code class="display"><span class="extract">no_break</span></code>
flag is set, we expect the text to form only a small part of a paragraph,
and it's inappropriate to break here: for instance, for printing the
"printed name" of an object. Where the flag is clear, however, the text
is expected to form its own paragraph.
</p>

<p class="inwebparagraph">Where <code class="display"><span class="extract">PrintOrRun</span></code> is used in breaking mode, which is only for a very few
properties in I7 (indeed at present only <code class="display"><span class="extract">initial</span></code> and <code class="display"><span class="extract">description</span></code>),
the routine called is given the chance to decide whether to print or not.
It should return <code class="display"><span class="extract">true</span></code> or <code class="display"><span class="extract">false</span></code> according to whether it did so; this
allows us to divide the paragraph or not accordingly.
</p>


<pre class="display">
    <span class="plain">[ PrintOrRun obj prop no_break  pv st routine_return_value;</span>
        <span class="plain">@push self; self = obj;</span>
        <span class="plain">if (prop == 0) {</span>
            <span class="plain">print (name) prop; routine_return_value = true;</span>
        <span class="plain">} else {</span>
            <span class="plain">routine_return_value = TEXT_TY_Say(obj.prop);</span>
        <span class="plain">}</span>
        <span class="plain">@pull self;</span>
        <span class="plain">if (routine_return_value) {</span>
            <span class="plain">say__p = 1;</span>
            <span class="plain">if (no_break == false) {</span>
                <span class="plain">new_line;</span>
                <span class="plain">DivideParagraphPoint();</span>
            <span class="plain">}</span>
        <span class="plain">}</span>

        <span class="plain">return routine_return_value;</span>
    <span class="plain">];</span>

    <span class="plain">[ DA_Number n; print n; ];</span>
    <span class="plain">[ DA_TruthState n; if (n==0) print "false"; else print "true"; ];</span>

</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><i>(This section begins Sections.)</i></li><li><a href="S-bt.html">Continue with 'BlockValues Template'</a></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

