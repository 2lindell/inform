<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>3/em</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '3/sc' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">if</a></li><li><a href="index.html#3">Chapter 3: Space and Time</a></li><li><b>Showme Command</b></li></ul><p class="purpose">A plugin to provide some support for the SHOWME testing command.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Initialising</a></li><li><a href="#SP2">&#167;2. Support for the SHOWME command</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Initialising. </b>This doesn't in fact do anything, except to provide one service when it's
plugged in.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">PL::Showme::start</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function PL::Showme::start appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2. Support for the SHOWME command. </b>And here is the one service. We must compile I6 code which looks at the
object in the local variable <code class="display"><span class="extract">t_0</span></code> and prints out useful diagnostic data
about its current state. We get to use a local variable <code class="display"><span class="extract">na</span></code>, which stands
for "number of attributes", though that's really I6-speak: what we mean
is "number of either-or properties in the semicolon-separated list we
are currently printing out".
</p>

<p class="inwebparagraph">We will show either/or properties first, on their own line, and then value
properties.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">PL::Showme::compile_SHOWME_details</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Plugins::Manage::plugged_in</span><span class="plain">(</span><span class="identifier">showme_plugin</span><span class="plain">) == </span><span class="identifier">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="identifier">packaging_state</span><span class="plain"> </span><span class="identifier">save</span><span class="plain"> = </span><span class="identifier">Routines::begin</span><span class="plain">(</span><span class="identifier">Hierarchy::find</span><span class="plain">(</span><span class="identifier">SHOWMEDETAILS_HL</span><span class="plain">));</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">t_0_s</span><span class="plain"> = </span><span class="identifier">LocalVariables::add_named_call_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"t_0"</span><span class="plain">);</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">na_s</span><span class="plain"> = </span><span class="identifier">LocalVariables::add_named_call_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"na"</span><span class="plain">);</span>
        <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">IFDEBUG_BIP</span><span class="plain">));</span>
        <span class="identifier">Emit::down</span><span class="plain">();</span>
            <span class="identifier">Emit::code</span><span class="plain">();</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                <span class="functiontext">PL::Showme::compile_SHOWME_type</span><span class="plain">(</span><span class="identifier">FALSE</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
                <span class="functiontext">PL::Showme::compile_SHOWME_type</span><span class="plain">(</span><span class="identifier">TRUE</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
        <span class="identifier">Emit::up</span><span class="plain">();</span>
        <span class="identifier">Routines::end</span><span class="plain">(</span><span class="identifier">save</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">PL::Showme::compile_SHOWME_type</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">val</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">na_s</span><span class="plain">) {</span>
        <span class="identifier">kind</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_BASE_KINDS</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Kinds::Compare::le</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">K_object</span><span class="plain">))</span>
                <span class="functiontext">PL::Showme::compile_SHOWME_type_subj</span><span class="plain">(</span><span class="identifier">val</span><span class="plain">, </span><span class="identifier">Kinds::Knowledge::as_subject</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">), </span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
        <span class="identifier">instance</span><span class="plain"> *</span><span class="identifier">I</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER_OBJECT_INSTANCES</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">)</span>
            <span class="functiontext">PL::Showme::compile_SHOWME_type_subj</span><span class="plain">(</span><span class="identifier">val</span><span class="plain">, </span><span class="identifier">Instances::as_subject</span><span class="plain">(</span><span class="identifier">I</span><span class="plain">), </span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">PL::Showme::compile_SHOWME_type_subj</span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">val</span><span class="plain">, </span><span class="identifier">inference_subject</span><span class="plain"> *</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">na_s</span><span class="plain">) {</span>
        &lt;<span class="cwebmacro">Skip if this object's definition has nothing to offer SHOWME</span> <span class="cwebmacronumber">2.1</span>&gt;<span class="character">;</span>

        <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
        <span class="identifier">Emit::down</span><span class="plain">();</span>
            <span class="identifier">InferenceSubjects::emit_element_of_condition</span><span class="plain">(</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">);</span>
            <span class="identifier">Emit::code</span><span class="plain">();</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                &lt;<span class="cwebmacro">Divide up the sublists of either/or properties in a SHOWME</span> <span class="cwebmacronumber">2.2</span>&gt;<span class="plain">;</span>
                &lt;<span class="cwebmacro">Compile code which shows properties inherited from this object's definition</span> <span class="cwebmacronumber">2.3</span>&gt;<span class="character">;</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
        <span class="identifier">Emit::up</span><span class="plain">();</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function PL::Showme::compile_SHOWME_details appears nowhere else.</p>

<p class="endnote">The function PL::Showme::compile_SHOWME_type appears nowhere else.</p>

<p class="endnote">The function PL::Showme::compile_SHOWME_type_subj appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP2_1"></a><b>&#167;2.1.  </b>This simply avoids compiling redundant empty <code class="display"><span class="extract">if</span></code> statements.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Skip if this object's definition has nothing to offer SHOWME</span> <span class="cwebmacronumber">2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">todo</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="identifier">property</span><span class="plain"> *</span><span class="identifier">prn</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">property</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Properties::is_value_property</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">) == </span><span class="identifier">val</span><span class="plain">)</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">PL::Showme::is_property_worth_SHOWME</span><span class="plain">(</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">))</span>
                    <span class="identifier">todo</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">todo</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP2">&#167;2</a>.</p>

<p class="inwebparagraph"><a id="SP2_2"></a><b>&#167;2.2.  </b>In the code running at this point, <code class="display"><span class="extract">na</span></code> holds the number of either/or
properties listed since the last time it was zeroed. If it's positive, we
need either a semicolon or a line break. If we're about to work on another
definition contributing either/or properties, the former; otherwise the
latter. Thus we end up with printed output such as
</p>

<p class="inwebparagraph"></p>


<pre class="display">
        <span class="plain">unlit, inedible, portable; male</span>
</pre>

<p class="inwebparagraph">where the first sublist of three either/ors comes from "thing", and the
second of just one from "person".
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Divide up the sublists of either/or properties in a SHOWME</span> <span class="cwebmacronumber">2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">divider</span><span class="plain"> = </span><span class="identifier">I</span><span class="string">"; "</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">val</span><span class="plain">) </span><span class="identifier">divider</span><span class="plain"> = </span><span class="identifier">I</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">;</span>
        <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
        <span class="identifier">Emit::down</span><span class="plain">();</span>
            <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">GT_BIP</span><span class="plain">));</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                <span class="identifier">Emit::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
                <span class="identifier">Emit::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
            <span class="identifier">Emit::code</span><span class="plain">();</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
                <span class="identifier">Emit::down</span><span class="plain">();</span>
                    <span class="identifier">Emit::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
                    <span class="identifier">Emit::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
                <span class="identifier">Emit::up</span><span class="plain">();</span>
                <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">PRINT_BIP</span><span class="plain">));</span>
                <span class="identifier">Emit::down</span><span class="plain">();</span>
                    <span class="identifier">Emit::val_text</span><span class="plain">(</span><span class="identifier">divider</span><span class="plain">);</span>
                <span class="identifier">Emit::up</span><span class="plain">();</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
        <span class="identifier">Emit::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP2">&#167;2</a>.</p>

<p class="inwebparagraph"><a id="SP2_3"></a><b>&#167;2.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Compile code which shows properties inherited from this object's definition</span> <span class="cwebmacronumber">2.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">property</span><span class="plain"> *</span><span class="identifier">prn</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">property</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Properties::is_value_property</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">) == </span><span class="identifier">val</span><span class="plain">)</span>
                <span class="functiontext">PL::Showme::compile_property_SHOWME</span><span class="plain">(</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP2">&#167;2</a>.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>We actually use the same routine for both testing and compiling:
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">PL::Showme::is_property_worth_SHOWME</span><span class="plain">(</span><span class="identifier">inference_subject</span><span class="plain"> *</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">property</span><span class="plain"> *</span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">na_s</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="functiontext">PL::Showme::SHOWME_primitive</span><span class="plain">(</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">FALSE</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">PL::Showme::compile_property_SHOWME</span><span class="plain">(</span><span class="identifier">inference_subject</span><span class="plain"> *</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">property</span><span class="plain"> *</span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">na_s</span><span class="plain">) {</span>
        <span class="functiontext">PL::Showme::SHOWME_primitive</span><span class="plain">(</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">TRUE</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function PL::Showme::is_property_worth_SHOWME is used in <a href="#SP2_1">&#167;2.1</a>.</p>

<p class="endnote">The function PL::Showme::compile_property_SHOWME is used in <a href="#SP2_3">&#167;2.3</a>.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>So here goes.
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">PL::Showme::SHOWME_primitive</span><span class="plain">(</span><span class="identifier">inference_subject</span><span class="plain"> *</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">property</span><span class="plain"> *</span><span class="identifier">prn</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">comp</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">na_s</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Properties::is_shown_in_index</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">) == </span><span class="identifier">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Properties::can_be_compiled</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">) == </span><span class="identifier">FALSE</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">FALSE</span><span class="plain">;</span>

        <span class="identifier">inference_subject</span><span class="plain"> *</span><span class="identifier">parent</span><span class="plain"> = </span><span class="identifier">InferenceSubjects::narrowest_broader_subject</span><span class="plain">(</span><span class="identifier">subj</span><span class="plain">);</span>

        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">World::Permissions::find</span><span class="plain">(</span><span class="identifier">subj</span><span class="plain">, </span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">FALSE</span><span class="plain">)) &amp;&amp;</span>
            <span class="plain">(</span><span class="identifier">World::Permissions::find</span><span class="plain">(</span><span class="identifier">parent</span><span class="plain">, </span><span class="identifier">prn</span><span class="plain">, </span><span class="identifier">TRUE</span><span class="plain">) == </span><span class="identifier">FALSE</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">comp</span><span class="plain">) {</span>
                <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Properties::is_value_property</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">))</span>
                    &lt;<span class="cwebmacro">Compile the SHOWME printing code for a value property</span> <span class="cwebmacronumber">4.1</span>&gt;
                <span class="reserved">else</span>
                    &lt;<span class="cwebmacro">Compile the SHOWME printing code for an either/or property</span> <span class="cwebmacronumber">4.2</span>&gt;<span class="plain">;</span>
            <span class="plain">}</span>
            <span class="reserved">return</span><span class="plain"> </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">FALSE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function PL::Showme::SHOWME_primitive is used in <a href="#SP3">&#167;3</a>.</p>

<p class="inwebparagraph"><a id="SP4_1"></a><b>&#167;4.1.  </b>In general we print the property value even if it's boringly equal to the
default value for the property's kind. For instance, we would print a "number"
property even if its value is 0. But we make two exceptions:
</p>

<p class="inwebparagraph"></p>

<ul class="items"><li>(a) We don't print "nothing" for an object property. The reason for this is
pragmatic: the "matching key" property in the Standard Rules rather
awkwardly has "thing" as its domain, even though it's only meaningful for
lockable things. This has to be true because it's used as the left domain of
a relation, and relation domains have to be kinds, not unions of kinds. But
that means that, for example, the player has a "matching key" property,
which is never likely to be used. We don't want to print this.
</li></ul>
<ul class="items"><li>(b) We don't print a 0 value for a property used to store a relation whose
relevant domain is enumerative. For instance, if P holds a colour to which
an object is related, then P can validly be 0 at run-time (meaning: there's
no relation to any colour) even though this is not typesafe because 0 is
not a valid colour. Because of this, we can't print 0 using the printing
routine for colours; and the best thing is to print nothing at all.
</li></ul>

<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Compile the SHOWME printing code for a value property</span> <span class="cwebmacronumber">4.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">kind</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain"> = </span><span class="identifier">Properties::Valued::kind</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">K</span><span class="plain">) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">require_nonzero</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">Properties::Valued::is_used_for_non_typesafe_relation</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">)) ||</span>
                <span class="plain">(</span><span class="identifier">Kinds::Compare::le</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">K_object</span><span class="plain">)))</span>
                <span class="identifier">require_nonzero</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">require_nonzero</span><span class="plain">) {</span>
                <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
                <span class="identifier">Emit::down</span><span class="plain">();</span>
                    <span class="identifier">inter_name</span><span class="plain"> *</span><span class="identifier">iname</span><span class="plain"> = </span><span class="identifier">Hierarchy::find</span><span class="plain">(</span><span class="identifier">GPROPERTY_HL</span><span class="plain">);</span>
                    <span class="identifier">Emit::inv_call_iname</span><span class="plain">(</span><span class="identifier">iname</span><span class="plain">);</span>
                    <span class="identifier">Emit::down</span><span class="plain">();</span>
                        <span class="identifier">Kinds::RunTime::emit_weak_id_as_val</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">);</span>
                        <span class="identifier">Emit::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">);</span>
                        <span class="identifier">Emit::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">Properties::iname</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">));</span>
                    <span class="identifier">Emit::up</span><span class="plain">();</span>
                    <span class="identifier">Emit::code</span><span class="plain">();</span>
                    <span class="identifier">Emit::down</span><span class="plain">();</span>
            <span class="plain">}</span>
            &lt;<span class="cwebmacro">Compile the SHOWME printing of the value of a value property</span> <span class="cwebmacronumber">4.1.1</span>&gt;<span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">require_nonzero</span><span class="plain">) {</span>
                    <span class="identifier">Emit::up</span><span class="plain">();</span>
                <span class="identifier">Emit::up</span><span class="plain">();</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_1_1"></a><b>&#167;4.1.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Compile the SHOWME printing of the value of a value property</span> <span class="cwebmacronumber">4.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>
        <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="string">"%+W: "</span><span class="plain">, </span><span class="identifier">prn</span><span class="plain">-</span><span class="element">&gt;name</span><span class="plain">);</span>
        <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">PRINT_BIP</span><span class="plain">));</span>
        <span class="identifier">Emit::down</span><span class="plain">();</span>
            <span class="identifier">Emit::val_text</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>
        <span class="identifier">Emit::up</span><span class="plain">();</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Kinds::Compare::eq</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">K_text</span><span class="plain">)) {</span>
            <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">IFELSE_BIP</span><span class="plain">));</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">EQ_BIP</span><span class="plain">));</span>
                <span class="identifier">Emit::down</span><span class="plain">();</span>
                    <span class="identifier">Emit::inv_call_iname</span><span class="plain">(</span><span class="identifier">Hierarchy::find</span><span class="plain">(</span><span class="identifier">TEXT_TY_COMPARE_HL</span><span class="plain">));</span>
                    <span class="identifier">Emit::down</span><span class="plain">();</span>
                        <span class="identifier">Emit::inv_call_iname</span><span class="plain">(</span><span class="identifier">Hierarchy::find</span><span class="plain">(</span><span class="identifier">GPROPERTY_HL</span><span class="plain">));</span>
                        <span class="identifier">Emit::down</span><span class="plain">();</span>
                            <span class="identifier">Kinds::RunTime::emit_weak_id_as_val</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">);</span>
                            <span class="identifier">Emit::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">);</span>
                            <span class="identifier">Emit::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">Properties::iname</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">));</span>
                        <span class="identifier">Emit::up</span><span class="plain">();</span>
                        <span class="identifier">Emit::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">Hierarchy::find</span><span class="plain">(</span><span class="identifier">EMPTY_TEXT_VALUE_HL</span><span class="plain">));</span>
                    <span class="identifier">Emit::up</span><span class="plain">();</span>
                    <span class="identifier">Emit::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
                <span class="identifier">Emit::up</span><span class="plain">();</span>
                <span class="identifier">Emit::code</span><span class="plain">();</span>
                <span class="identifier">Emit::down</span><span class="plain">();</span>
                    <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">PRINT_BIP</span><span class="plain">));</span>
                    <span class="identifier">Emit::down</span><span class="plain">();</span>
                        <span class="identifier">Emit::val_text</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"none"</span><span class="plain">);</span>
                    <span class="identifier">Emit::up</span><span class="plain">();</span>
                <span class="identifier">Emit::up</span><span class="plain">();</span>
                <span class="identifier">Emit::code</span><span class="plain">();</span>
                <span class="identifier">Emit::down</span><span class="plain">();</span>
                    <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">PRINTCHAR_BIP</span><span class="plain">));</span>
                    <span class="identifier">Emit::down</span><span class="plain">();</span>
                        <span class="identifier">Emit::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, </span><span class="character">'\</span><span class="plain">"</span><span class="character">'</span><span class="plain">);</span>
                    <span class="identifier">Emit::up</span><span class="plain">();</span>
                    &lt;<span class="cwebmacro">Compile the SHOWME of the actual value</span> <span class="cwebmacronumber">4.1.1.1</span>&gt;<span class="plain">;</span>
                    <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">PRINTCHAR_BIP</span><span class="plain">));</span>
                    <span class="identifier">Emit::down</span><span class="plain">();</span>
                        <span class="identifier">Emit::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, </span><span class="character">'\</span><span class="plain">"</span><span class="character">'</span><span class="plain">);</span>
                    <span class="identifier">Emit::up</span><span class="plain">();</span>
                <span class="identifier">Emit::up</span><span class="plain">();</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            &lt;<span class="cwebmacro">Compile the SHOWME of the actual value</span> <span class="cwebmacronumber">4.1.1.1</span>&gt;<span class="plain">;</span>
        <span class="plain">}</span>

        <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">PRINT_BIP</span><span class="plain">));</span>
        <span class="identifier">Emit::down</span><span class="plain">();</span>
            <span class="identifier">Emit::val_text</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
        <span class="identifier">Emit::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4_1">&#167;4.1</a>.</p>

<p class="inwebparagraph"><a id="SP4_1_1_1"></a><b>&#167;4.1.1.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Compile the SHOWME of the actual value</span> <span class="cwebmacronumber">4.1.1.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">INDIRECT1V_BIP</span><span class="plain">));</span>
        <span class="identifier">Emit::down</span><span class="plain">();</span>
            <span class="identifier">Emit::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">Kinds::Behaviour::get_iname</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">));</span>
            <span class="identifier">Emit::inv_call_iname</span><span class="plain">(</span><span class="identifier">Hierarchy::find</span><span class="plain">(</span><span class="identifier">GPROPERTY_HL</span><span class="plain">));</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                <span class="identifier">Kinds::RunTime::emit_weak_id_as_val</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">);</span>
                <span class="identifier">Emit::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">);</span>
                <span class="identifier">Emit::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">Properties::iname</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">));</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
        <span class="identifier">Emit::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4_1_1">&#167;4.1.1</a> (twice).</p>

<p class="inwebparagraph"><a id="SP4_2"></a><b>&#167;4.2.  </b>The I6 template code is allowed to bar certain either/or properties using
<code class="display"><span class="extract">AllowInShowme</span></code>; it typically uses this to block distracting temporary-workspace
properties like "marked for listing" whose values have no significance
turn by turn.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Compile the SHOWME printing code for an either/or property</span> <span class="cwebmacronumber">4.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">property</span><span class="plain"> *</span><span class="identifier">allow</span><span class="plain"> = </span><span class="identifier">prn</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Properties::EitherOr::stored_in_negation</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">))</span>
            <span class="identifier">allow</span><span class="plain"> = </span><span class="identifier">Properties::EitherOr::get_negation</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">);</span>

        <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
        <span class="identifier">Emit::down</span><span class="plain">();</span>
            <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">AND_BIP</span><span class="plain">));</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">this_is_a_release_compile</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">) || (</span><span class="identifier">this_is_a_debug_compile</span><span class="plain">)) {</span>
                    <span class="identifier">Emit::inv_call_iname</span><span class="plain">(</span><span class="identifier">Hierarchy::find</span><span class="plain">(</span><span class="identifier">ALLOWINSHOWME_HL</span><span class="plain">));</span>
                    <span class="identifier">Emit::down</span><span class="plain">();</span>
                        <span class="identifier">Emit::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">Properties::iname</span><span class="plain">(</span><span class="identifier">prn</span><span class="plain">));</span>
                    <span class="identifier">Emit::up</span><span class="plain">();</span>
                <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                    <span class="identifier">Emit::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
                <span class="plain">}</span>
                <span class="identifier">Properties::Emit::emit_has_property</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">t_0_s</span><span class="plain">, </span><span class="identifier">prn</span><span class="plain">);</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
            <span class="identifier">Emit::code</span><span class="plain">();</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                &lt;<span class="cwebmacro">Compile the comma as needed</span> <span class="cwebmacronumber">4.2.1</span>&gt;<span class="plain">;</span>
                <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>
                <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">, </span><span class="string">"%+W"</span><span class="plain">, </span><span class="identifier">prn</span><span class="plain">-</span><span class="element">&gt;name</span><span class="plain">);</span>
                <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">PRINT_BIP</span><span class="plain">));</span>
                <span class="identifier">Emit::down</span><span class="plain">();</span>
                    <span class="identifier">Emit::val_text</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>
                <span class="identifier">Emit::up</span><span class="plain">();</span>
                <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">T</span><span class="plain">);</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
        <span class="identifier">Emit::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4_2_1"></a><b>&#167;4.2.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Compile the comma as needed</span> <span class="cwebmacronumber">4.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
        <span class="identifier">Emit::down</span><span class="plain">();</span>
            <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">GT_BIP</span><span class="plain">));</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">POSTINCREMENT_BIP</span><span class="plain">));</span>
                <span class="identifier">Emit::down</span><span class="plain">();</span>
                    <span class="identifier">Emit::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">na_s</span><span class="plain">);</span>
                <span class="identifier">Emit::up</span><span class="plain">();</span>
                <span class="identifier">Emit::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
            <span class="identifier">Emit::code</span><span class="plain">();</span>
            <span class="identifier">Emit::down</span><span class="plain">();</span>
                <span class="identifier">Emit::inv_primitive</span><span class="plain">(</span><span class="identifier">Emit::opcode</span><span class="plain">(</span><span class="identifier">PRINT_BIP</span><span class="plain">));</span>
                <span class="identifier">Emit::down</span><span class="plain">();</span>
                    <span class="identifier">Emit::val_text</span><span class="plain">(</span><span class="identifier">I</span><span class="string">", "</span><span class="plain">);</span>
                <span class="identifier">Emit::up</span><span class="plain">();</span>
            <span class="identifier">Emit::up</span><span class="plain">();</span>
        <span class="identifier">Emit::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP4_2">&#167;4.2</a>.</p>

<hr class="tocbar">
<ul class="toc"><li><a href="3-em.html">Back to 'EPS Map'</a></li><li><a href="3-scn.html">Continue with 'Scenes'</a></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

