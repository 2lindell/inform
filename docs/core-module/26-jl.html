<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Jump Labels</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../index.html">
<img src="../docs-src/Figures/Inform.png" height=72">
</a></h1>
<ul><li><a href="../compiler.html">compiler tools</a></li>
<li><a href="../other.html">other tools</a></li>
<li><a href="../extensions.html">extensions and kits</a></li>
<li><a href="../units.html">unit test tools</a></li>
</ul><h2>Compiler Webs</h2><ul>
<li><a href="../inbuild/index.html">inbuild</a></li>
<li><a href="../inform7/index.html">inform7</a></li>
<li><a href="../inter/index.html">inter</a></li>
</ul><h2>Inbuild Modules</h2><ul>
<li><a href="../supervisor-module/index.html">supervisor</a></li>
</ul><h2>Inform7 Modules</h2><ul>
<li><a href="index.html"><span class="selectedlink">core</span></a></li>
<li><a href="../inflections-module/index.html">inflections</a></li>
<li><a href="../linguistics-module/index.html">linguistics</a></li>
<li><a href="../kinds-module/index.html">kinds</a></li>
<li><a href="../if-module/index.html">if</a></li>
<li><a href="../multimedia-module/index.html">multimedia</a></li>
<li><a href="../problems-module/index.html">problems</a></li>
<li><a href="../index-module/index.html">index</a></li>
</ul><h2>Inter Modules</h2><ul>
<li><a href="../bytecode-module/index.html">bytecode</a></li>
<li><a href="../building-module/index.html">building</a></li>
<li><a href="../codegen-module/index.html">codegen</a></li>
</ul><h2>Shared Modules</h2><ul>
<li><a href="../arch-module/index.html">arch</a></li>
<li><a href="../syntax-module/index.html">syntax</a></li>
<li><a href="../words-module/index.html">words</a></li>
<li><a href="../html-module/index.html">html</a></li>
<li><a href="../../../inweb/docs/foundation-module/index.html">foundation</a></li>

</ul>
		</nav>
		<main role="main">
		
<!--Weave of 'Jump Labels' generated by 7-->
<ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="../compiler.html">Inform7 Modules</a></li><li><a href="index.html">core</a></li><li><a href="index.html#26">Chapter 26: Compilation Utilities</a></li><li><b>Jump Labels</b></li></ul><p class="purpose">I7 is has no Dijkstra-like conscience about compiling code which is full of |jump| statements, and these require labels to jump to. This section provides those labels, and other related unique-ID-number counters.</p>

<ul class="toc"><li><a href="26-jl.html#SP1">&#167;1. Definitions</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Definitions. </b></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>For clarity we give each label in the compiled code its own unique name
(even though this is not strictly necessary since I6 labels have only local
scope to their routines), and this means allowing for sets of labels with
a unique ID number providing guaranteed-previously-unused new labels in
every set.
</p>

<p class="inwebparagraph">So: each set of labels is identified with a name, and the labels written take
the form <code class="display"><span class="extract">L_NameNumber</span></code>. For instance, <code class="display"><span class="extract">L_Marble17</span></code> is the 18th label in
namespace <code class="display"><span class="extract">Marble</span></code>. Every label namespace's name must differ from every
other. It is legal for a namespace's name to be the empty string, which
generates labels <code class="display"><span class="extract">L_0</span></code>, <code class="display"><span class="extract">L_1</span></code>, ...
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">MAX_NAMESPACE_PREFIX_LENGTH</span><span class="plain"> </span><span class="constant">20</span><span class="plain"> </span><span class="comment"> when <code class="display"><span class="extract">L_</span></code> and a number are added, we are within 31 chars</span>
</pre>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">label_namespace</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">label_prefix</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">label_counter</span><span class="plain">; </span><span class="comment"> next free ID number for this label namespace</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">allocate_storage</span><span class="plain">; </span><span class="comment"> number of words of memory to reserve for each label</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">inter_name</span><span class="plain"> *</span><span class="identifier">label_storage_iname</span><span class="plain">;</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">compilation_module</span><span class="plain"> *</span><span class="identifier">module</span><span class="plain">;</span>
        <span class="identifier">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">label_namespace</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure label_namespace is private to this section.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>The creator for new label namespaces. Note that, by default, a label namespace
reserves no memory.
</p>

<pre class="display">
    <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="functiontext">JumpLabels::new_namespace<button class="popup" onclick="togglePopup('usagePopup2061')">...<span class="popuptext" id="usagePopup2061">Usage of <b>JumpLabels::new_namespace</b>:<br><a href="26-jl.html#SP4">&#167;4</a></span></button></span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">name</span><span class="plain">, </span><span class="identifier">compilation_module</span><span class="plain"> *</span><span class="identifier">cm</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::len</span><span class="plain">(</span><span class="identifier">name</span><span class="plain">) &gt; </span><span class="constant">MAX_NAMESPACE_PREFIX_LENGTH</span><span class="plain">) {</span>
            <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="constant">CORE_MODULE</span>
            <span class="identifier">Problems::Issue::sentence_problem</span><span class="plain">(</span><span class="functiontext"><a href="1-wtc.html#SP5">Task::syntax_tree</a></span><span class="plain">(), </span><span class="identifier">_p_</span><span class="plain">(</span><span class="identifier">PM_LabelNamespaceTooLong</span><span class="plain">),</span>
                <span class="string">"a label namespace prefix is too long"</span><span class="plain">,</span>
                <span class="string">"and should be shortened to a few alphabetic characters."</span><span class="plain">);</span>
            <span class="plain">#</span><span class="identifier">endif</span>
            <span class="plain">#</span><span class="identifier">ifndef</span><span class="plain"> </span><span class="constant">CORE_MODULE</span>
            <span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"namespace prefix too long"</span><span class="plain">);</span>
            <span class="plain">#</span><span class="identifier">endif</span>
        <span class="plain">}</span>
        <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="identifier">lns</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">label_namespace</span><span class="plain">);</span>
        <span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_prefix</span><span class="plain"> = </span><span class="identifier">Str::duplicate</span><span class="plain">(</span><span class="identifier">name</span><span class="plain">);</span>
        <span class="identifier">package_request</span><span class="plain"> *</span><span class="identifier">PR2</span><span class="plain"> = </span><span class="functiontext"><a href="27-hr.html#SP4">Hierarchy::synoptic_package</a></span><span class="plain">(</span><span class="constant">LABEL_STORAGES_HAP</span><span class="plain">);</span>
        <span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_storage_iname</span><span class="plain"> = </span><span class="functiontext"><a href="27-hr.html#SP4">Hierarchy::make_iname_in</a></span><span class="plain">(</span><span class="constant">LABEL_ASSOCIATED_STORAGE_HL</span><span class="plain">, </span><span class="identifier">PR2</span><span class="plain">);</span>

        <span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_counter</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">allocate_storage</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">module</span><span class="plain"> = </span><span class="identifier">cm</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">lns</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>The rest of Inform tends not to store pointers to namespaces: instead it
must access them by searching on the name. This is inefficient, but there are
few namespaces and it happens fairly seldom, so there is no point in
optimising.
</p>

<pre class="display">
    <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="functiontext">JumpLabels::namespace_by_prefix<button class="popup" onclick="togglePopup('usagePopup2062')">...<span class="popuptext" id="usagePopup2062">Usage of <b>JumpLabels::namespace_by_prefix</b>:<br>none</span></button></span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">name</span><span class="plain">, </span><span class="identifier">compilation_module</span><span class="plain"> *</span><span class="identifier">cm</span><span class="plain">) {</span>
        <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="identifier">lns</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">lns</span><span class="plain">, </span><span class="reserved">label_namespace</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="identifier">module</span><span class="plain"> == </span><span class="identifier">cm</span><span class="plain">) &amp;&amp; (</span><span class="identifier">Str::eq</span><span class="plain">(</span><span class="identifier">name</span><span class="plain">, </span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_prefix</span><span class="plain">)))</span>
                <span class="reserved">return</span><span class="plain"> </span><span class="identifier">lns</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="functiontext">JumpLabels::read_or_create_namespace<button class="popup" onclick="togglePopup('usagePopup2063')">...<span class="popuptext" id="usagePopup2063">Usage of <b>JumpLabels::read_or_create_namespace</b>:<br><a href="26-jl.html#SP5">&#167;5</a>, <a href="26-jl.html#SP6">&#167;6</a></span></button></span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">name</span><span class="plain">) {</span>
        <span class="identifier">compilation_module</span><span class="plain"> *</span><span class="identifier">cm</span><span class="plain"> = </span><span class="functiontext"><a href="27-cm.html#SP6">Modules::current</a></span><span class="plain">();</span>
        <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="identifier">lns</span><span class="plain"> = </span><span class="functiontext"><a href="26-jl.html#SP4">JumpLabels::namespace_by_prefix</a></span><span class="plain">(</span><span class="identifier">name</span><span class="plain">, </span><span class="identifier">cm</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">lns</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">lns</span><span class="plain"> = </span><span class="functiontext"><a href="26-jl.html#SP3">JumpLabels::new_namespace</a></span><span class="plain">(</span><span class="identifier">name</span><span class="plain">, </span><span class="identifier">cm</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">lns</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5.  </b>The rest of Inform is allowed only to call for a label in a given namespace,
advancing the counter or not as it pleases; or to call for the current
counter value.
</p>

<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">JumpLabels::read_counter<button class="popup" onclick="togglePopup('usagePopup2064')">...<span class="popuptext" id="usagePopup2064">Usage of <b>JumpLabels::read_counter</b>:<br>Compile Invocations Inline - <a href="25-cii.html#SP3_4_2">&#167;3.4.2</a>, <a href="25-cii.html#SP3_4_4">&#167;3.4.4</a>, <a href="25-cii.html#SP3_4_5">&#167;3.4.5</a><br>Compile Phrases - <a href="25-cp.html#SP5_4_3">&#167;5.4.3</a></span></button></span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">namespace</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">advance_flag</span><span class="plain">) {</span>
        <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="identifier">lns</span><span class="plain"> = </span><span class="functiontext"><a href="26-jl.html#SP4">JumpLabels::read_or_create_namespace</a></span><span class="plain">(</span><span class="identifier">namespace</span><span class="plain">);</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain"> = </span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_counter</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">advance_flag</span><span class="plain"> == </span><span class="identifier">TRUE</span><span class="plain">) </span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_counter</span><span class="plain">++;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">advance_flag</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">) {</span>
            <span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_counter</span><span class="plain">--;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_counter</span><span class="plain"> &lt; </span><span class="constant">0</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"label counter negative"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">c</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">JumpLabels::write<button class="popup" onclick="togglePopup('usagePopup2065')">...<span class="popuptext" id="usagePopup2065">Usage of <b>JumpLabels::write</b>:<br>Compile Invocations Inline - <a href="25-cii.html#SP3_4_1">&#167;3.4.1</a><br>Compile Phrases - <a href="25-cp.html#SP5_4_3">&#167;5.4.3</a></span></button></span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">namespace</span><span class="plain">) {</span>
        <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="identifier">lns</span><span class="plain"> = </span><span class="functiontext"><a href="26-jl.html#SP4">JumpLabels::read_or_create_namespace</a></span><span class="plain">(</span><span class="identifier">namespace</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"L_%S%d"</span><span class="plain">, </span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_prefix</span><span class="plain">, </span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_counter</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="identifier">inter_name</span><span class="plain"> *</span><span class="functiontext">JumpLabels::storage<button class="popup" onclick="togglePopup('usagePopup2066')">...<span class="popuptext" id="usagePopup2066">Usage of <b>JumpLabels::storage</b>:<br>Compile Invocations Inline - <a href="25-cii.html#SP3_4_3">&#167;3.4.3</a></span></button></span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">namespace</span><span class="plain">) {</span>
        <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="identifier">lns</span><span class="plain"> = </span><span class="functiontext"><a href="26-jl.html#SP4">JumpLabels::read_or_create_namespace</a></span><span class="plain">(</span><span class="identifier">namespace</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_storage_iname</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>It is possible to mark a namespace as requiring 1 or more words of storage.
If so, the namespace <code class="display"><span class="extract">Whatsit</span></code> makes a word array called <code class="display"><span class="extract">I7_ST_Whatsit</span></code>
which contains enough words for each label actually allocated to have that
many words of storage. (And we add 2 words, to provide a safety margin, and
because in the event of a namespace for which no labels are created, I6
would otherwise throw an error at being asked to make an array with the
specification <code class="display"><span class="extract">--&gt; 0</span></code>.)
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">JumpLabels::allocate_counter<button class="popup" onclick="togglePopup('usagePopup2067')">...<span class="popuptext" id="usagePopup2067">Usage of <b>JumpLabels::allocate_counter</b>:<br>Compile Invocations Inline - <a href="25-cii.html#SP3_4_6">&#167;3.4.6</a></span></button></span><span class="plain">(</span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">namespace</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">multiplier</span><span class="plain">) {</span>
        <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="identifier">lns</span><span class="plain"> = </span><span class="functiontext"><a href="26-jl.html#SP4">JumpLabels::read_or_create_namespace</a></span><span class="plain">(</span><span class="identifier">namespace</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">multiplier</span><span class="plain"> &gt; </span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">allocate_storage</span><span class="plain">) </span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">allocate_storage</span><span class="plain"> = </span><span class="identifier">multiplier</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">JumpLabels::compile_necessary_storage<button class="popup" onclick="togglePopup('usagePopup2068')">...<span class="popuptext" id="usagePopup2068">Usage of <b>JumpLabels::compile_necessary_storage</b>:<br>How To Compile - <a href="1-htc.html#SP2_8">&#167;2.8</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">label_namespace</span><span class="plain"> *</span><span class="identifier">lns</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">lns</span><span class="plain">, </span><span class="reserved">label_namespace</span><span class="plain">)</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">allocate_storage</span><span class="plain"> &gt; </span><span class="constant">0</span><span class="plain">) {</span>
                <span class="identifier">packaging_state</span><span class="plain"> </span><span class="identifier">save</span><span class="plain"> = </span><span class="functiontext"><a href="27-em.html#SP3">Emit::named_array_begin</a></span><span class="plain">(</span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_storage_iname</span><span class="plain">, </span><span class="identifier">K_value</span><span class="plain">);</span>
                <span class="reserved">int</span><span class="plain"> </span><span class="identifier">N</span><span class="plain"> = (</span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">allocate_storage</span><span class="plain">)*(</span><span class="identifier">lns</span><span class="plain">-&gt;</span><span class="element">label_counter</span><span class="plain">) + </span><span class="constant">2</span><span class="plain">;</span>
                <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">i</span><span class="plain">&lt;</span><span class="identifier">N</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) </span><span class="functiontext"><a href="27-em.html#SP3">Emit::array_numeric_entry</a></span><span class="plain">(0);</span>
                <span class="functiontext"><a href="27-em.html#SP3">Emit::array_end</a></span><span class="plain">(</span><span class="identifier">save</span><span class="plain">);</span>
            <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><a href="26-lt.html">Back to 'List Together'</a></li><li><a href="26-ct.html">Continue with 'Compiled Text'</a></li></ul><hr class="tocbar">
<!--End of weave-->
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
		</main>
	</body>
</html>

