<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Stack Frames</title>
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="../inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body>
		<nav role="navigation">
		<h1><a href="../index.html">
<img src="../docs-src/Figures/Inform.png" height=72">
</a></h1>
<ul><li><a href="../compiler.html">compiler tools</a></li>
<li><a href="../other.html">other tools</a></li>
<li><a href="../extensions.html">extensions and kits</a></li>
<li><a href="../units.html">unit test tools</a></li>
</ul><h2>Compiler Webs</h2><ul>
<li><a href="../inbuild/index.html">inbuild</a></li>
<li><a href="../inform7/index.html">inform7</a></li>
<li><a href="../inter/index.html">inter</a></li>
</ul><h2>Inbuild Modules</h2><ul>
<li><a href="../supervisor-module/index.html">supervisor</a></li>
</ul><h2>Inform7 Modules</h2><ul>
<li><a href="index.html"><span class="selectedlink">core</span></a></li>
<li><a href="../inflections-module/index.html">inflections</a></li>
<li><a href="../linguistics-module/index.html">linguistics</a></li>
<li><a href="../kinds-module/index.html">kinds</a></li>
<li><a href="../if-module/index.html">if</a></li>
<li><a href="../multimedia-module/index.html">multimedia</a></li>
<li><a href="../problems-module/index.html">problems</a></li>
<li><a href="../index-module/index.html">index</a></li>
</ul><h2>Inter Modules</h2><ul>
<li><a href="../bytecode-module/index.html">bytecode</a></li>
<li><a href="../building-module/index.html">building</a></li>
<li><a href="../codegen-module/index.html">codegen</a></li>
</ul><h2>Shared Modules</h2><ul>
<li><a href="../arch-module/index.html">arch</a></li>
<li><a href="../syntax-module/index.html">syntax</a></li>
<li><a href="../words-module/index.html">words</a></li>
<li><a href="../html-module/index.html">html</a></li>
<li><a href="../../../inweb/docs/foundation-module/index.html">foundation</a></li>

</ul>
		</nav>
		<main role="main">
		
<!--Weave of 'Stack Frames' generated by 7-->
<ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="../compiler.html">Inform7 Modules</a></li><li><a href="index.html">core</a></li><li><a href="index.html#24">Chapter 24: Compilation Context</a></li><li><b>Stack Frames</b></li></ul><p class="purpose">When Inform compiles phrase invocations, or implied forms of these such as text substitutions, it does so in the context of a "stack frame". This provides for local "let" values, manages loop blocks, and in general looks after any information shared between a whole sequence of invocations.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Definitions</a></li><li><a href="#SP5">&#167;5. Creation</a></li><li><a href="#SP8">&#167;8. The current stack frame</a></li><li><a href="#SP9">&#167;9. Kinds</a></li><li><a href="#SP11">&#167;11. Stacked variables</a></li><li><a href="#SP12">&#167;12. Past tense</a></li><li><a href="#SP13">&#167;13. Logging</a></li><li><a href="#SP14">&#167;14. Formal parameter allocation</a></li><li><a href="#SP15">&#167;15. Pointer value allocation</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Definitions. </b></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>As we've seen, each phrase has its own stack frame, which is a structure
inside the <code class="display"><span class="extract">phrase</span></code> structure. But they can also exist independently, for
other occasions when compilation occurs. They keep track of which variables
are visible, and also of the current values of the kind variables A to Z,
if any, and the consequent return kind.
</p>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ph_stack_frame</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">locals_slate</span><span class="plain"> </span><span class="identifier">local_value_variables</span><span class="plain">; </span><span class="comment"> those in scope here</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">stacked_variable_owner_list</span><span class="plain"> *</span><span class="identifier">local_stvol</span><span class="plain">; </span><span class="comment"> those in scope here</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pointer_allocation</span><span class="plain"> *</span><span class="identifier">allocated_pointers</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_formal_parameters_needed</span><span class="plain">; </span><span class="comment"> usually 0, unless there are ambiguities</span>

        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain"> *</span><span class="identifier">kind_returned</span><span class="plain">; </span><span class="comment"> or <code class="display"><span class="extract">NULL</span></code> for no return value</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">kind</span><span class="plain"> **</span><span class="identifier">local_kind_variables</span><span class="plain">; </span><span class="comment"> points to an array indexed 1 to 26</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">determines_past_conditions</span><span class="plain">; </span><span class="comment"> or rather, in the present, but for future use</span>
    <span class="plain">} </span><span class="reserved">ph_stack_frame</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure ph_stack_frame is accessed in 24/lv, 26/rt and here.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>Stack frames are often made fleetingly and then thrown away, but sometimes
we need to make one and keep it around. For this, we have the ability to box
up a stack frame: by allocating an instance of the following structure, we
can have a permanently valid pointer to a unique new PHSF.
</p>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ph_stack_frame_box</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">ph_stack_frame</span><span class="plain"> </span><span class="identifier">boxed_phsf</span><span class="plain">;</span>
        <span class="identifier">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">ph_stack_frame_box</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure ph_stack_frame_box is private to this section.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>Within each stack frame is a linked list of notes about pointer values
for which memory allocation and deallocation will be needed:
</p>

<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pointer_allocation</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">heap_allocation</span><span class="plain"> </span><span class="identifier">allocation</span><span class="plain">; </span><span class="comment"> needed to compile a function call returning a pointer to a new value</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">local_reference_code</span><span class="plain">; </span><span class="comment"> an I6 lvalue for the storage holding the pointer</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">escaped_local_reference_code</span><span class="plain">; </span><span class="comment"> the same, but suitable for schema use</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">schema_for_promotion</span><span class="plain">; </span><span class="comment"> an I6 schema for promoting this value</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">offset_index</span><span class="plain">; </span><span class="comment"> start of small block wrt current stack frame</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">offset_past</span><span class="plain">; </span><span class="comment"> just past the end of the small block</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="reserved">pointer_allocation</span><span class="plain"> *</span><span class="identifier">next_in_frame</span><span class="plain">; </span><span class="comment"> within the linked list</span>
        <span class="identifier">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">pointer_allocation</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure pointer_allocation is accessed in 26/rt and here.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. Creation. </b>A completely black stack frame...
</p>

<pre class="display">
    <span class="reserved">ph_stack_frame</span><span class="plain"> </span><span class="functiontext">Frames::new<button class="popup" onclick="togglePopup('usagePopup1939')">...<span class="popuptext" id="usagePopup1939">Usage of <b>Frames::new</b>:<br><a href="#SP6">&#167;6</a>, Text Substitutions - <a href="17-ts.html#SP5">&#167;5</a><br>Phrases - <a href="22-ph.html#SP6_5">&#167;6.5</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">ph_stack_frame</span><span class="plain"> </span><span class="identifier">phsf</span><span class="plain">;</span>
        <span class="identifier">phsf</span><span class="plain">.</span><span class="element">local_value_variables</span><span class="plain"> = </span><span class="functiontext"><a href="24-lv.html#SP5">LocalVariables::blank_slate</a></span><span class="plain">();</span>
        <span class="identifier">phsf</span><span class="plain">.</span><span class="element">local_kind_variables</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">phsf</span><span class="plain">.</span><span class="element">local_stvol</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">phsf</span><span class="plain">.</span><span class="element">determines_past_conditions</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="identifier">phsf</span><span class="plain">.</span><span class="element">allocated_pointers</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">phsf</span><span class="plain">.</span><span class="element">kind_returned</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">phsf</span><span class="plain">.</span><span class="element">no_formal_parameters_needed</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">phsf</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>...can be useful all by itself. The following is used to make a temporary
stack frame suitable for "nonphrasal" compilation, that is, for when Inform
wants to compile an I6 routine for some purpose other than to define a phrase.
</p>

<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">nonphrasal_stack_frame_is_current</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
    <span class="reserved">ph_stack_frame</span><span class="plain"> </span><span class="identifier">nonphrasal_stack_frame</span><span class="plain">;</span>

    <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="functiontext">Frames::new_nonphrasal<button class="popup" onclick="togglePopup('usagePopup1940')">...<span class="popuptext" id="usagePopup1940">Usage of <b>Frames::new_nonphrasal</b>:<br>Routines - <a href="26-rt.html#SP3_1">&#167;3.1</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">nonphrasal_stack_frame_is_current</span><span class="plain">)</span>
            <span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"can't nest nonphrasal stack frames"</span><span class="plain">);</span>
        <span class="identifier">nonphrasal_stack_frame</span><span class="plain"> = </span><span class="functiontext"><a href="#SP5">Frames::new</a></span><span class="plain">();</span>
        <span class="identifier">nonphrasal_stack_frame_is_current</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="functiontext"><a href="#SP8">Frames::make_current</a></span><span class="plain">(&amp;</span><span class="identifier">nonphrasal_stack_frame</span><span class="plain">);</span>
        <span class="reserved">return</span><span class="plain"> &amp;</span><span class="identifier">nonphrasal_stack_frame</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::remove_nonphrase_stack_frame<button class="popup" onclick="togglePopup('usagePopup1941')">...<span class="popuptext" id="usagePopup1941">Usage of <b>Frames::remove_nonphrase_stack_frame</b>:<br>Phrase Usage - <a href="22-pu.html#SP21_1_1">&#167;21.1.1</a><br>Routines - <a href="26-rt.html#SP4">&#167;4</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">nonphrasal_stack_frame</span><span class="plain"> = </span><span class="functiontext"><a href="#SP5">Frames::new</a></span><span class="plain">(); </span><span class="comment"> to prevent accidental lucky misuse</span>
        <span class="identifier">nonphrasal_stack_frame_is_current</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="functiontext"><a href="#SP8">Frames::remove_current</a></span><span class="plain">();</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b>Another way to get hold of a PHSF is to request a boxed one, as noted above:
</p>

<pre class="display">
    <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="functiontext">Frames::boxed_frame<button class="popup" onclick="togglePopup('usagePopup1942')">...<span class="popuptext" id="usagePopup1942">Usage of <b>Frames::boxed_frame</b>:<br>Text Substitutions - <a href="17-ts.html#SP5">&#167;5</a>, <a href="17-ts.html#SP8">&#167;8</a><br>Responses - <a href="17-rs.html#SP5">&#167;5</a>, <a href="17-rs.html#SP12_1_1">&#167;12.1.1</a></span></button></span><span class="plain">(</span><span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">ph_stack_frame_box</span><span class="plain"> *</span><span class="identifier">phsfb</span><span class="plain">;</span>
        <span class="identifier">phsfb</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">ph_stack_frame_box</span><span class="plain">);</span>
        <span class="identifier">phsfb</span><span class="plain">-&gt;</span><span class="element">boxed_phsf</span><span class="plain"> = *</span><span class="identifier">phsf</span><span class="plain">;</span>
        <span class="functiontext"><a href="24-lv.html#SP6">LocalVariables::deep_copy_locals_slate</a></span><span class="plain">(&amp;(</span><span class="identifier">phsfb</span><span class="plain">-&gt;</span><span class="element">boxed_phsf</span><span class="plain">.</span><span class="element">local_value_variables</span><span class="plain">),</span>
            <span class="plain">&amp;(</span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_value_variables</span><span class="plain">));</span>
        <span class="reserved">return</span><span class="plain"> &amp;(</span><span class="identifier">phsfb</span><span class="plain">-&gt;</span><span class="element">boxed_phsf</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8. The current stack frame. </b>At any given time, a single stack frame is valid for local variable names
and phrase option names used as conditions. It will be the nonphrasal one
if that's active, and otherwise must be set as needed.
</p>

<pre class="display">
    <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">current_frame</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>

    <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="functiontext">Frames::current_stack_frame<button class="popup" onclick="togglePopup('usagePopup1943')">...<span class="popuptext" id="usagePopup1943">Usage of <b>Frames::current_stack_frame</b>:<br><a href="#SP9">&#167;9</a>, <a href="#SP10">&#167;10</a>, <a href="#SP11">&#167;11</a>, <a href="#SP12">&#167;12</a>, <a href="#SP14">&#167;14</a>, <a href="#SP15">&#167;15</a>, Adjective Meanings - <a href="4-am.html#SP33_2">&#167;33.2</a>, <a href="4-am.html#SP33_2_1">&#167;33.2.1</a><br>Relations - <a href="6-rlt.html#SP30">&#167;30</a><br>Constants and Descriptions - <a href="10-cad.html#SP19_2">&#167;19.2</a><br>Type Expressions and Values - <a href="10-teav.html#SP15">&#167;15</a>, <a href="10-teav.html#SP16">&#167;16</a><br>Measurement Adjectives - <a href="15-ma.html#SP13">&#167;13</a><br>Text Substitutions - <a href="17-ts.html#SP5">&#167;5</a>, <a href="17-ts.html#SP8">&#167;8</a>, <a href="17-ts.html#SP9">&#167;9</a>, <a href="17-ts.html#SP11">&#167;11</a><br>Responses - <a href="17-rs.html#SP12_1_1">&#167;12.1.1</a><br>Equations - <a href="20-eq.html#SP47_3">&#167;47.3</a><br>Phrase Usage - <a href="22-pu.html#SP21_1_1">&#167;21.1.1</a><br>Local Variables - <a href="24-lv.html#SP10">&#167;10</a>, <a href="24-lv.html#SP11">&#167;11</a>, <a href="24-lv.html#SP20">&#167;20</a>, <a href="24-lv.html#SP21">&#167;21</a>, <a href="24-lv.html#SP22">&#167;22</a>, <a href="24-lv.html#SP23">&#167;23</a>, <a href="24-lv.html#SP26">&#167;26</a>, <a href="24-lv.html#SP27">&#167;27</a>, <a href="24-lv.html#SP30">&#167;30</a>, <a href="24-lv.html#SP31">&#167;31</a>, <a href="24-lv.html#SP33">&#167;33</a>, <a href="24-lv.html#SP33_3">&#167;33.3</a>, <a href="24-lv.html#SP41">&#167;41</a>, <a href="24-lv.html#SP42">&#167;42</a><br>Phrase Blocks - <a href="24-pb.html#SP8">&#167;8</a>, <a href="24-pb.html#SP18">&#167;18</a>, <a href="24-pb.html#SP19">&#167;19</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">current_frame</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::make_current<button class="popup" onclick="togglePopup('usagePopup1944')">...<span class="popuptext" id="usagePopup1944">Usage of <b>Frames::make_current</b>:<br><a href="#SP6">&#167;6</a>, Construction Sequence - <a href="22-cs.html#SP7">&#167;7</a><br>Phrase Runtime Context Data - <a href="22-prcd.html#SP9">&#167;9</a><br>Compile Phrases - <a href="25-cp.html#SP3_2">&#167;3.2</a><br>Routines - <a href="26-rt.html#SP3_1">&#167;3.1</a></span></button></span><span class="plain">(</span><span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"can't select null stack frame"</span><span class="plain">);</span>
        <span class="identifier">current_frame</span><span class="plain"> = </span><span class="identifier">phsf</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::remove_current<button class="popup" onclick="togglePopup('usagePopup1945')">...<span class="popuptext" id="usagePopup1945">Usage of <b>Frames::remove_current</b>:<br><a href="#SP6">&#167;6</a>, Construction Sequence - <a href="22-cs.html#SP7">&#167;7</a><br>Routines - <a href="26-rt.html#SP4">&#167;4</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">current_frame</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP9"></a><b>&#167;9. Kinds. </b>The kind of value we expect to return from within this stack frame, if any.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::set_kind_returned<button class="popup" onclick="togglePopup('usagePopup1946')">...<span class="popuptext" id="usagePopup1946">Usage of <b>Frames::set_kind_returned</b>:<br>Phrase Type Data - <a href="22-ptd.html#SP20">&#167;20</a></span></button></span><span class="plain">(</span><span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain">, </span><span class="identifier">kind</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">) {</span>
        <span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">kind_returned</span><span class="plain"> = </span><span class="identifier">K</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="identifier">kind</span><span class="plain"> *</span><span class="functiontext">Frames::get_kind_returned<button class="popup" onclick="togglePopup('usagePopup1947')">...<span class="popuptext" id="usagePopup1947">Usage of <b>Frames::get_kind_returned</b>:<br>Compile Invocations Inline - <a href="25-cii.html#SP3_1_1_4_7_1">&#167;3.1.1.4.7.1</a>, <a href="25-cii.html#SP7">&#167;7</a><br>Compile Phrases - <a href="25-cp.html#SP3_3_1">&#167;3.3.1</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain"> = </span><span class="functiontext"><a href="#SP8">Frames::current_stack_frame</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">kind_returned</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP10"></a><b>&#167;10.  </b>And the values of the kind variables A to Z:
</p>


<pre class="definitions">
    <span class="definitionkeyword">define</span> <span class="constant">KIND_VARIABLE_FROM_CONTEXT</span><span class="plain"> </span><span class="functiontext"><a href="#SP10">Frames::get_kind_variable</a></span>
</pre>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::set_kind_variables<button class="popup" onclick="togglePopup('usagePopup1948')">...<span class="popuptext" id="usagePopup1948">Usage of <b>Frames::set_kind_variables</b>:<br>Compile Phrases - <a href="25-cp.html#SP3_2">&#167;3.2</a></span></button></span><span class="plain">(</span><span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain">, </span><span class="identifier">kind</span><span class="plain"> **</span><span class="identifier">vars</span><span class="plain">) {</span>
        <span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_kind_variables</span><span class="plain"> = </span><span class="identifier">vars</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="identifier">kind</span><span class="plain"> *</span><span class="functiontext">Frames::get_kind_variable<button class="popup" onclick="togglePopup('usagePopup1949')">...<span class="popuptext" id="usagePopup1949">Usage of <b>Frames::get_kind_variable</b>:<br>Compile Invocations Inline - <a href="25-cii.html#SP3_1_1_1">&#167;3.1.1.1</a></span></button></span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">N</span><span class="plain">) {</span>
        <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain"> = </span><span class="functiontext"><a href="#SP8">Frames::current_stack_frame</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">phsf</span><span class="plain">) &amp;&amp; (</span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_kind_variables</span><span class="plain">))</span>
            <span class="reserved">return</span><span class="plain"> </span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_kind_variables</span><span class="plain">[</span><span class="identifier">N</span><span class="plain">];</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="identifier">kind</span><span class="plain"> **</span><span class="functiontext">Frames::temporarily_set_kvs<button class="popup" onclick="togglePopup('usagePopup1950')">...<span class="popuptext" id="usagePopup1950">Usage of <b>Frames::temporarily_set_kvs</b>:<br>Compile Invocations Inline - <a href="25-cii.html#SP3_1_1">&#167;3.1.1</a>, <a href="25-cii.html#SP7">&#167;7</a></span></button></span><span class="plain">(</span><span class="identifier">kind</span><span class="plain"> **</span><span class="identifier">vars</span><span class="plain">) {</span>
        <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain"> = </span><span class="functiontext"><a href="#SP8">Frames::current_stack_frame</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="identifier">kind</span><span class="plain"> **</span><span class="identifier">prev</span><span class="plain"> = </span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_kind_variables</span><span class="plain">;</span>
        <span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_kind_variables</span><span class="plain"> = </span><span class="identifier">vars</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">prev</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP11"></a><b>&#167;11. Stacked variables. </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::set_stvol<button class="popup" onclick="togglePopup('usagePopup1951')">...<span class="popuptext" id="usagePopup1951">Usage of <b>Frames::set_stvol</b>:<br>Phrase Usage - <a href="22-pu.html#SP21_1_1">&#167;21.1.1</a><br>Phrase Runtime Context Data - <a href="22-prcd.html#SP9">&#167;9</a><br>Compile Phrases - <a href="25-cp.html#SP3_2">&#167;3.2</a></span></button></span><span class="plain">(</span><span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain">, </span><span class="reserved">stacked_variable_owner_list</span><span class="plain"> *</span><span class="identifier">stvol</span><span class="plain">) {</span>
        <span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_stvol</span><span class="plain"> = </span><span class="identifier">stvol</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">stacked_variable_owner_list</span><span class="plain"> *</span><span class="functiontext">Frames::get_stvol<button class="popup" onclick="togglePopup('usagePopup1952')">...<span class="popuptext" id="usagePopup1952">Usage of <b>Frames::get_stvol</b>:<br>Type Expressions and Values - <a href="10-teav.html#SP16">&#167;16</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain"> = </span><span class="functiontext"><a href="#SP8">Frames::current_stack_frame</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_stvol</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">NULL</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP12"></a><b>&#167;12. Past tense. </b>All we do here is to make a note if anything compiled in this context makes
reference to the past.
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::determines_the_past<button class="popup" onclick="togglePopup('usagePopup1953')">...<span class="popuptext" id="usagePopup1953">Usage of <b>Frames::determines_the_past</b>:<br>Chronology - <a href="24-ch.html#SP7">&#167;7</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain"> = </span><span class="functiontext"><a href="#SP8">Frames::current_stack_frame</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span>
            <span class="string">"tried to determine past where no stack frame exists"</span><span class="plain">);</span>
        <span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">determines_past_conditions</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">LOCAL_VARIABLES</span><span class="plain">, </span><span class="string">"Stack frame determines past\n"</span><span class="plain">);</span>
    <span class="plain">}</span>

    <span class="reserved">int</span><span class="plain"> </span><span class="functiontext">Frames::used_for_past_tense<button class="popup" onclick="togglePopup('usagePopup1954')">...<span class="popuptext" id="usagePopup1954">Usage of <b>Frames::used_for_past_tense</b>:<br>Compile Atoms - <a href="12-ca.html#SP5_1_2">&#167;5.1.2</a></span></button></span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain"> = </span><span class="functiontext"><a href="#SP8">Frames::current_stack_frame</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="identifier">determines_past_conditions</span><span class="plain">) </span><span class="reserved">return</span><span class="plain"> </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">FALSE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP13"></a><b>&#167;13. Logging. </b></p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::log<button class="popup" onclick="togglePopup('usagePopup1955')">...<span class="popuptext" id="usagePopup1955">Usage of <b>Frames::log</b>:<br>Text Substitutions - <a href="17-ts.html#SP9">&#167;9</a></span></button></span><span class="plain">(</span><span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain">) {</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) { </span><span class="identifier">LOG</span><span class="plain">(</span><span class="string">"&lt;null stack frame&gt;\n"</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">; }</span>
        <span class="identifier">LOG</span><span class="plain">(</span><span class="string">"Stack frame at %08x: it:%s, dpc:%s\n"</span><span class="plain">,</span>
            <span class="identifier">phsf</span><span class="plain">,</span>
            <span class="plain">(</span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_value_variables</span><span class="plain">.</span><span class="element">it_variable_exists</span><span class="plain">)?</span><span class="string">"yes"</span><span class="plain">:</span><span class="string">"no"</span><span class="plain">,</span>
            <span class="plain">(</span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">determines_past_conditions</span><span class="plain">)?</span><span class="string">"yes"</span><span class="plain">:</span><span class="string">"no"</span><span class="plain">);</span>
        <span class="reserved">local_variable</span><span class="plain"> *</span><span class="identifier">lvar</span><span class="plain">;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">lvar</span><span class="plain"> = </span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">local_value_variables</span><span class="plain">.</span><span class="element">local_variable_allocation</span><span class="plain">; </span><span class="identifier">lvar</span><span class="plain">; </span><span class="identifier">lvar</span><span class="plain"> = </span><span class="identifier">lvar</span><span class="plain">-&gt;</span><span class="element">next</span><span class="plain">) {</span>
            <span class="reserved">switch</span><span class="plain"> (</span><span class="identifier">lvar</span><span class="plain">-&gt;</span><span class="element">lv_purpose</span><span class="plain">) {</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="identifier">LET_VALUE_LV:</span><span class="plain"> </span><span class="identifier">LOG</span><span class="plain">(</span><span class="string">"Let/loop value: "</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="identifier">TOKEN_CALL_PARAMETER_LV:</span><span class="plain"> </span><span class="identifier">LOG</span><span class="plain">(</span><span class="string">"Call value: "</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="reserved">case</span><span class="plain"> </span><span class="identifier">INTERNAL_USE_LV:</span><span class="plain"> </span><span class="identifier">LOG</span><span class="plain">(</span><span class="string">"Internal use: "</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
                <span class="identifier">default:</span><span class="plain"> </span><span class="identifier">LOG</span><span class="plain">(</span><span class="string">"Other: "</span><span class="plain">); </span><span class="reserved">break</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="identifier">LOG</span><span class="plain">(</span><span class="string">"%~L: "</span><span class="plain">, </span><span class="identifier">lvar</span><span class="plain">);</span>
            <span class="functiontext"><a href="24-lv.html#SP35">LocalVariables::log</a></span><span class="plain">(</span><span class="identifier">lvar</span><span class="plain">); </span><span class="identifier">LOG</span><span class="plain">(</span><span class="string">"\n"</span><span class="plain">);</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP14"></a><b>&#167;14. Formal parameter allocation. </b>Some stack frames need access to additional variables to handle run-time
invocation ambiguities, and this is how they're requested:
</p>

<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::need_at_least_this_many_formals<button class="popup" onclick="togglePopup('usagePopup1956')">...<span class="popuptext" id="usagePopup1956">Usage of <b>Frames::need_at_least_this_many_formals</b>:<br>Compile Invocations - <a href="25-ci.html#SP3_2">&#167;3.2</a></span></button></span><span class="plain">(</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">N</span><span class="plain">) {</span>
        <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain"> = </span><span class="functiontext"><a href="#SP8">Frames::current_stack_frame</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)</span>
            <span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"requested formal parameters outside all stack frames"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">N</span><span class="plain"> &gt; </span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">no_formal_parameters_needed</span><span class="plain">)</span>
            <span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">no_formal_parameters_needed</span><span class="plain"> = </span><span class="identifier">N</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP15"></a><b>&#167;15. Pointer value allocation. </b>Values such as lists, which have to stored in whole blocks rather than single
words of memory, are sometimes called pointer values because all we can
immediately handle is a pointer to the block. When these arise in the
compilation of a routine, we have to make a note of this, because special
code will be needed to allocate and deallocate the memory storing the block.
The following is the routine called to make this note.
</p>

<pre class="display">
    <span class="reserved">pointer_allocation</span><span class="plain"> *</span><span class="functiontext">Frames::add_allocation<button class="popup" onclick="togglePopup('usagePopup1957')">...<span class="popuptext" id="usagePopup1957">Usage of <b>Frames::add_allocation</b>:<br>Runtime Support for Kinds - <a href="13-rsfk.html#SP6">&#167;6</a></span></button></span><span class="plain">(</span><span class="identifier">kind</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">, </span><span class="reserved">char</span><span class="plain"> *</span><span class="identifier">proto</span><span class="plain">) {</span>
        <span class="reserved">ph_stack_frame</span><span class="plain"> *</span><span class="identifier">phsf</span><span class="plain"> = </span><span class="functiontext"><a href="#SP8">Frames::current_stack_frame</a></span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">phsf</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) {</span>
            <span class="identifier">LOG</span><span class="plain">(</span><span class="string">"Tried to allocate: $u\n"</span><span class="plain">, </span><span class="identifier">K</span><span class="plain">);</span>
            <span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"tried to allocate block kind outside all stack frames"</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">pointer_allocation</span><span class="plain"> *</span><span class="identifier">pall</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">pointer_allocation</span><span class="plain">);</span>
        <span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">next_in_frame</span><span class="plain"> = </span><span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">allocated_pointers</span><span class="plain">;</span>
        <span class="identifier">phsf</span><span class="plain">-&gt;</span><span class="element">allocated_pointers</span><span class="plain"> = </span><span class="identifier">pall</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="identifier">next_in_frame</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">offset_index</span><span class="plain"> = </span><span class="constant">0</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="identifier">offset_index</span><span class="plain"> = </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">next_in_frame</span><span class="plain">-&gt;</span><span class="element">offset_past</span><span class="plain">;</span>
        <span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">offset_past</span><span class="plain"> = </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">offset_index</span><span class="plain"> + </span><span class="identifier">Kinds::Behaviour::get_small_block_size</span><span class="plain">(</span><span class="identifier">K</span><span class="plain">);</span>

        &lt;<span class="cwebmacro">Work out heap allocation code for this pointer value</span> <span class="cwebmacronumber">15.1</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Work out local reference code for this pointer value</span> <span class="cwebmacronumber">15.2</span>&gt;<span class="plain">;</span>
        &lt;<span class="cwebmacro">Work out promotion schema for this pointer value</span> <span class="cwebmacronumber">15.3</span>&gt;<span class="plain">;</span>

        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">pall</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::compile_allocation<button class="popup" onclick="togglePopup('usagePopup1958')">...<span class="popuptext" id="usagePopup1958">Usage of <b>Frames::compile_allocation</b>:<br>Runtime Support for Kinds - <a href="13-rsfk.html#SP7">&#167;7</a></span></button></span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="identifier">kind</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">) {</span>
        <span class="reserved">pointer_allocation</span><span class="plain"> *</span><span class="identifier">pall</span><span class="plain"> = </span><span class="functiontext"><a href="#SP15">Frames::add_allocation</a></span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="functiontext"><a href="#SP16">Frames::pall_get_local_reference</a></span><span class="plain">(</span><span class="identifier">pall</span><span class="plain">));</span>
    <span class="plain">}</span>

    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Frames::emit_allocation<button class="popup" onclick="togglePopup('usagePopup1959')">...<span class="popuptext" id="usagePopup1959">Usage of <b>Frames::emit_allocation</b>:<br>Deciding to Defer - <a href="12-dtd.html#SP16">&#167;16</a>, <a href="12-dtd.html#SP17">&#167;17</a><br>Runtime Support for Kinds - <a href="13-rsfk.html#SP7">&#167;7</a><br>Compiling from Specifications - <a href="14-cfs.html#SP7">&#167;7</a><br>Text Substitutions - <a href="17-ts.html#SP8">&#167;8</a><br>Compile Invocations As Calls - <a href="25-ciac.html#SP2_1">&#167;2.1</a><br>Compile Invocations Inline - <a href="25-cii.html#SP1_2_1">&#167;1.2.1</a>, <a href="25-cii.html#SP3_2_1">&#167;3.2.1</a></span></button></span><span class="plain">(</span><span class="identifier">kind</span><span class="plain"> *</span><span class="identifier">K</span><span class="plain">) {</span>
        <span class="reserved">pointer_allocation</span><span class="plain"> *</span><span class="identifier">pall</span><span class="plain"> = </span><span class="functiontext"><a href="#SP15">Frames::add_allocation</a></span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">);</span>
        <span class="reserved">i6_schema</span><span class="plain"> *</span><span class="identifier">all_sch</span><span class="plain"> = </span><span class="functiontext"><a href="12-is.html#SP4">Calculus::Schemas::new</a></span><span class="plain">(</span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">escaped_local_reference_code</span><span class="plain">);</span>
        <span class="functiontext"><a href="12-is.html#SP6">Calculus::Schemas::emit_expand_from_terms</a></span><span class="plain">(</span><span class="identifier">all_sch</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">NULL</span><span class="plain">, </span><span class="identifier">FALSE</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="inwebparagraph"><a id="SP15_1"></a><b>&#167;15.1.  </b>The following works out a call to <code class="display"><span class="extract">BlkValueCreate</span></code> which will return a
default value of the given kind.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Work out heap allocation code for this pointer value</span> <span class="cwebmacronumber">15.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">allocation</span><span class="plain"> = </span><span class="functiontext"><a href="13-rsfk.html#SP19">Kinds::RunTime::make_heap_allocation</a></span><span class="plain">(</span><span class="identifier">K</span><span class="plain">, </span><span class="constant">0</span><span class="plain">, </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">offset_index</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP15">&#167;15</a>.</p>

<p class="inwebparagraph"><a id="SP15_2"></a><b>&#167;15.2.  </b>This is the storage used to hold the pointer. For each frame, we have
a subarray of short blocks, indexed by the offset.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Work out local reference code for this pointer value</span> <span class="cwebmacronumber">15.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">local_reference_code</span><span class="plain"> = </span><span class="identifier">Str::new</span><span class="plain">();</span>
        <span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">escaped_local_reference_code</span><span class="plain"> = </span><span class="identifier">Str::new</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="identifier">offset_index</span><span class="plain"> == </span><span class="constant">0</span><span class="plain">) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">local_reference_code</span><span class="plain">, </span><span class="string">"I7SFRAME"</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">escaped_local_reference_code</span><span class="plain">, </span><span class="string">"I7SFRAME"</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">offset_index</span><span class="plain"> == </span><span class="constant">1</span><span class="plain">) {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">local_reference_code</span><span class="plain">, </span><span class="string">"(I7SFRAME+WORDSIZE)"</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">escaped_local_reference_code</span><span class="plain">, </span><span class="string">"(I7SFRAME+WORDSIZE)"</span><span class="plain">);</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">local_reference_code</span><span class="plain">, </span><span class="string">"(I7SFRAME+WORDSIZE*%d)"</span><span class="plain">, </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">offset_index</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">escaped_local_reference_code</span><span class="plain">, </span><span class="string">"(I7SFRAME+WORDSIZE**%d)"</span><span class="plain">, </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">offset_index</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP15">&#167;15</a>.</p>

<p class="inwebparagraph"><a id="SP15_3"></a><b>&#167;15.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Work out promotion schema for this pointer value</span> <span class="cwebmacronumber">15.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">schema_for_promotion</span><span class="plain"> = </span><span class="identifier">Str::new</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">proto</span><span class="plain">) {</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">=0; </span><span class="identifier">proto</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">]; </span><span class="identifier">i</span><span class="plain">++) {</span>
                <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">proto</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">] == </span><span class="character">'*'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">proto</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">+1] == </span><span class="character">'#'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">proto</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">+2] == </span><span class="character">'#'</span><span class="plain">)) {</span>
                    <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">schema_for_promotion</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">escaped_local_reference_code</span><span class="plain">);</span>
                    <span class="identifier">i</span><span class="plain">+=2;</span>
                    <span class="reserved">continue</span><span class="plain">;</span>
                <span class="plain">}</span>
                <span class="identifier">PUT_TO</span><span class="plain">(</span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">schema_for_promotion</span><span class="plain">, </span><span class="identifier">proto</span><span class="plain">[</span><span class="identifier">i</span><span class="plain">]);</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP15">&#167;15</a>.</p>

<p class="inwebparagraph"><a id="SP16"></a><b>&#167;16.  </b></p>

<pre class="display">
    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="functiontext">Frames::pall_get_local_reference<button class="popup" onclick="togglePopup('usagePopup1960')">...<span class="popuptext" id="usagePopup1960">Usage of <b>Frames::pall_get_local_reference</b>:<br><a href="#SP15">&#167;15</a></span></button></span><span class="plain">(</span><span class="reserved">pointer_allocation</span><span class="plain"> *</span><span class="identifier">pall</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">local_reference_code</span><span class="plain">;</span>
    <span class="plain">}</span>

    <span class="identifier">text_stream</span><span class="plain"> *</span><span class="functiontext">Frames::pall_get_expanded_schema<button class="popup" onclick="togglePopup('usagePopup1961')">...<span class="popuptext" id="usagePopup1961">Usage of <b>Frames::pall_get_expanded_schema</b>:<br>Runtime Support for Kinds - <a href="13-rsfk.html#SP6">&#167;6</a></span></button></span><span class="plain">(</span><span class="reserved">pointer_allocation</span><span class="plain"> *</span><span class="identifier">pall</span><span class="plain">) {</span>
        <span class="reserved">return</span><span class="plain"> </span><span class="identifier">pall</span><span class="plain">-&gt;</span><span class="element">schema_for_promotion</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<hr class="tocbar">
<ul class="toc"><li><a href="24-pb.html">Back to 'Phrase Blocks'</a></li><li><a href="24-ch.html">Continue with 'Chronology'</a></li></ul><hr class="tocbar">
<!--End of weave-->
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
		</main>
	</body>
</html>

