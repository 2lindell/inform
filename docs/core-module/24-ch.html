<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>24/sf</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '24/ch' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">core</a></li><li><a href="index.html#24">Chapter 24: Compilation Context</a></li><li><b>Chronology</b></li></ul><p class="purpose">To keep track of the state of things so that it will be possible in future to ask questions concerning the past.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Definitions</a></li><li><a href="#SP3">&#167;3. Compiling chronology</a></li><li><a href="#SP5">&#167;5. The periodic monitoring</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Definitions. </b></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>Some conditions stored in SPs, and also some actions stored in APs, are
evaluated in the past tense, and to do this we need to lodge them into
storage: the following simple structures are used for this.
</p>


<pre class="display">
    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">past_tense_condition_record</span><span class="plain"> {</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">parse_node</span><span class="plain"> *</span><span class="identifier">condition</span><span class="plain">; </span>    <span class="comment">condition to be evaluated</span>
        <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">IF_MODULE</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">action_pattern</span><span class="plain"> *</span><span class="identifier">ap_to_test</span><span class="plain">; </span>    <span class="comment">condition to be evaluated</span>
        <span class="plain">#</span><span class="identifier">endif</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">parse_node</span><span class="plain"> *</span><span class="identifier">where_ptc_tested</span><span class="plain">; </span>    <span class="comment">sentence in which condition is found</span>
        <span class="identifier">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">past_tense_condition_record</span><span class="plain">;</span>

    <span class="reserved">typedef</span><span class="plain"> </span><span class="reserved">struct</span><span class="plain"> </span><span class="reserved">past_tense_action_record</span><span class="plain"> {</span>
        <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">IF_MODULE</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">action_pattern</span><span class="plain"> </span><span class="identifier">historic_action</span><span class="plain">; </span>    <span class="comment">action pattern to be matched</span>
        <span class="plain">#</span><span class="identifier">endif</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">parse_node</span><span class="plain"> *</span><span class="identifier">where_pta_tested</span><span class="plain">; </span>    <span class="comment">sentence in which AP is found</span>
        <span class="reserved">struct</span><span class="plain"> </span><span class="identifier">inter_name</span><span class="plain"> *</span><span class="identifier">pta_iname</span><span class="plain">;</span>
        <span class="identifier">MEMORY_MANAGEMENT</span>
    <span class="plain">} </span><span class="reserved">past_tense_action_record</span><span class="plain">;</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The structure past_tense_condition_record is private to this section.</p>

<p class="endnote">The structure past_tense_action_record is private to this section.</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3. Compiling chronology. </b>First, the here and now.
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">no_past_tenses</span><span class="plain"> = 0, </span><span class="identifier">no_past_actions</span><span class="plain"> = 0;</span>
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">too_late_for_past_tenses</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>

    <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">IF_MODULE</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Chronology::ap_compile_forced_to_present</span><span class="plain">(</span><span class="identifier">action_pattern</span><span class="plain"> </span><span class="identifier">ap</span><span class="plain">) {</span>
        <span class="identifier">PL::Actions::Patterns::convert_to_present_tense</span><span class="plain">(&amp;</span><span class="identifier">ap</span><span class="plain">); </span>    <span class="comment">prevent recursion</span>
        <span class="identifier">PL::Actions::Patterns::emit_pattern_match</span><span class="plain">(</span><span class="identifier">ap</span><span class="plain">, </span><span class="identifier">FALSE</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="plain">#</span><span class="identifier">endif</span>

    <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">IF_MODULE</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Chronology::compile_past_action_pattern</span><span class="plain">(</span><span class="identifier">value_holster</span><span class="plain"> *</span><span class="identifier">VH</span><span class="plain">, </span><span class="identifier">time_period</span><span class="plain"> </span><span class="identifier">duration</span><span class="plain">, </span><span class="identifier">action_pattern</span><span class="plain"> </span><span class="identifier">ap</span><span class="plain">) {</span>
        <span class="reserved">char</span><span class="plain"> *</span><span class="identifier">op</span><span class="plain"> = </span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">inform6_operator</span><span class="plain">;</span>
        <span class="identifier">package_request</span><span class="plain"> *</span><span class="identifier">PR</span><span class="plain"> = </span><span class="functiontext">Hierarchy::local_package</span><span class="plain">(</span><span class="constant">PAST_ACTION_PATTERNS_HAP</span><span class="plain">);</span>
        <span class="identifier">inter_name</span><span class="plain"> *</span><span class="identifier">pta_routine</span><span class="plain"> = </span><span class="functiontext">Hierarchy::make_iname_in</span><span class="plain">(</span><span class="constant">PAP_FN_HL</span><span class="plain">, </span><span class="identifier">PR</span><span class="plain">);</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TIME_PERIODS</span><span class="plain">,</span>
            <span class="string">"Chronology::compile_past_action_pattern on: $A\</span><span class="plain">n</span><span class="string">at: $t\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, &amp;</span><span class="identifier">ap</span><span class="plain">, &amp;</span><span class="identifier">duration</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">PL::Actions::Patterns::makes_callings</span><span class="plain">(&amp;</span><span class="identifier">ap</span><span class="plain">)) {</span>
            <span class="identifier">Problems::Issue::sentence_problem</span><span class="plain">(</span><span class="identifier">_p_</span><span class="plain">(</span><span class="identifier">PM_PTAPMakesCallings</span><span class="plain">),</span>
                <span class="string">"a description of an action cannot both refer to past history "</span>
                <span class="string">"and also use '(called ...)'"</span><span class="plain">,</span>
                <span class="string">"because that would require Inform in general to remember "</span>
                <span class="string">"too much information about past events."</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">too_late_for_past_tenses</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"too late for a PAP"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">op</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">op</span><span class="plain"> = </span><span class="string">"=="</span><span class="plain">;</span>

        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">AND_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">INDIRECT0_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">pta_routine</span><span class="plain">);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">L</span><span class="plain"> = </span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">length</span><span class="plain">; </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">L</span><span class="plain"> &lt; 0) </span><span class="identifier">L</span><span class="plain"> = 0;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">until</span><span class="plain"> &gt;= 0) {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">units</span><span class="plain"> == </span><span class="identifier">TIMES_UNIT</span><span class="plain">) {</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">AND_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LE_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">L</span><span class="plain">);</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">TIMESACTIONHASHAPPENED_HL</span><span class="plain">));</span>
                            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_actions</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">AND_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">GE_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">until</span><span class="plain">);</span>
                            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                            <span class="identifier">Produce::down</span><span class="plain">();</span>
                                <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">TIMESACTIONHASHAPPENED_HL</span><span class="plain">));</span>
                                <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_actions</span><span class="plain">);</span>
                            <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUPBYTE_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">ACTIONCURRENTLYHAPPENINGFLAG_HL</span><span class="plain">));</span>
                            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_actions</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">AND_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LE_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">L</span><span class="plain">);</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">TURNSACTIONHASBEENHAPPENING_HL</span><span class="plain">));</span>
                            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_actions</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">GE_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">until</span><span class="plain">);</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">TURNSACTIONHASBEENHAPPENING_HL</span><span class="plain">));</span>
                            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_actions</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="plain">}</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">units</span><span class="plain"> == </span><span class="identifier">TIMES_UNIT</span><span class="plain">) {</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">AND_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    &lt;<span class="cwebmacro">Emit the op</span> <span class="cwebmacronumber">3.1</span>&gt;<span class="plain">;</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">TIMESACTIONHASHAPPENED_HL</span><span class="plain">));</span>
                            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_actions</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">L</span><span class="plain">);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUPBYTE_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">ACTIONCURRENTLYHAPPENINGFLAG_HL</span><span class="plain">));</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_actions</span><span class="plain">);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                &lt;<span class="cwebmacro">Emit the op</span> <span class="cwebmacronumber">3.1</span>&gt;<span class="plain">;</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">TURNSACTIONHASBEENHAPPENING_HL</span><span class="plain">));</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_actions</span><span class="plain">);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">L</span><span class="plain">);</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="plain">}</span>
        <span class="plain">}</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>

        <span class="reserved">past_tense_action_record</span><span class="plain"> *</span><span class="identifier">pta</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">past_tense_action_record</span><span class="plain">);</span>
        <span class="identifier">pta</span><span class="plain">-</span><span class="element">&gt;where_pta_tested</span><span class="plain"> = </span><span class="identifier">current_sentence</span><span class="plain">;</span>
        <span class="identifier">pta</span><span class="plain">-</span><span class="element">&gt;historic_action</span><span class="plain"> = </span><span class="identifier">ap</span><span class="plain">;</span>
        <span class="identifier">pta</span><span class="plain">-</span><span class="element">&gt;pta_iname</span><span class="plain"> = </span><span class="identifier">pta_routine</span><span class="plain">;</span>
        <span class="identifier">no_past_actions</span><span class="plain">++;</span>
    <span class="plain">}</span>
    <span class="plain">#</span><span class="identifier">endif</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Chronology::ap_compile_forced_to_present is used in <a href="#SP6">&#167;6</a>.</p>

<p class="endnote">The function Chronology::compile_past_action_pattern appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP3_1"></a><b>&#167;3.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Emit the op</span> <span class="cwebmacronumber">3.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">strcmp</span><span class="plain">(</span><span class="identifier">op</span><span class="plain">, </span><span class="string">"=="</span><span class="plain">) == 0) </span><span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">EQ_BIP</span><span class="plain">));</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">strcmp</span><span class="plain">(</span><span class="identifier">op</span><span class="plain">, </span><span class="string">"~="</span><span class="plain">) == 0) </span><span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">NE_BIP</span><span class="plain">));</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">strcmp</span><span class="plain">(</span><span class="identifier">op</span><span class="plain">, </span><span class="string">"&gt;"</span><span class="plain">) == 0) </span><span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">GT_BIP</span><span class="plain">));</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">strcmp</span><span class="plain">(</span><span class="identifier">op</span><span class="plain">, </span><span class="string">"&gt;="</span><span class="plain">) == 0) </span><span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">GE_BIP</span><span class="plain">));</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">strcmp</span><span class="plain">(</span><span class="identifier">op</span><span class="plain">, </span><span class="string">"&lt;"</span><span class="plain">) == 0) </span><span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LT_BIP</span><span class="plain">));</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">strcmp</span><span class="plain">(</span><span class="identifier">op</span><span class="plain">, </span><span class="string">"&lt;="</span><span class="plain">) == 0) </span><span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LE_BIP</span><span class="plain">));</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"can't find operator"</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP3">&#167;3</a> (twice), <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Chronology::compile_past_tense_condition</span><span class="plain">(</span><span class="identifier">value_holster</span><span class="plain"> *</span><span class="identifier">VH</span><span class="plain">, </span><span class="identifier">parse_node</span><span class="plain"> *</span><span class="identifier">spec</span><span class="plain">) {</span>
        <span class="identifier">time_period</span><span class="plain"> </span><span class="identifier">duration</span><span class="plain"> = *(</span><span class="identifier">ParseTree::get_condition_tense</span><span class="plain">(</span><span class="identifier">spec</span><span class="plain">));</span>
        <span class="identifier">spec</span><span class="plain"> = </span><span class="identifier">spec</span><span class="plain">-</span><span class="element">&gt;down</span><span class="plain">;</span>

        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TIME_PERIODS</span><span class="plain">,</span>
            <span class="string">"Chronology::compile_past_tense_condition on:\</span><span class="plain">n</span><span class="string">$T\</span><span class="plain">n</span><span class="string">at: $t\</span><span class="plain">n</span><span class="string">NPT: %d\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                <span class="identifier">spec</span><span class="plain">, &amp;</span><span class="identifier">duration</span><span class="plain">, </span><span class="identifier">no_past_tenses</span><span class="plain">);</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">pasturise</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>

        <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">IF_MODULE</span>
        <span class="identifier">action_pattern</span><span class="plain"> *</span><span class="identifier">ap</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ParseTree::is</span><span class="plain">(</span><span class="identifier">spec</span><span class="plain">, </span><span class="constant">TEST_VALUE_NT</span><span class="plain">)) </span><span class="identifier">ap</span><span class="plain"> = </span><span class="functiontext">Rvalues::to_action_pattern</span><span class="plain">(</span><span class="identifier">spec</span><span class="plain">-</span><span class="element">&gt;down</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">ap</span><span class="plain">) &amp;&amp; (</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">tense</span><span class="plain"> != </span><span class="identifier">IS_TENSE</span><span class="plain">)) {</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">units</span><span class="plain"> == </span><span class="identifier">TIMES_UNIT</span><span class="plain">) &amp;&amp; (</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">length</span><span class="plain"> &gt;= 2)) {</span>
                <span class="identifier">Problems::Issue::sentence_problem</span><span class="plain">(</span><span class="identifier">_p_</span><span class="plain">(</span><span class="identifier">PM_NoMoreRonNewcombMoment</span><span class="plain">),</span>
                    <span class="string">"a condition like 'we have X', where X is an action, has either "</span>
                    <span class="string">"happened for one spell or never happened at all"</span><span class="plain">,</span>
                    <span class="string">"so it can't make sense to ask if it has happened two or more "</span>
                    <span class="string">"times. For instance, at the start of play 'we have jumped' is "</span>
                    <span class="string">"false, but once the player types JUMP, 'we have jumped' will "</span>
                    <span class="string">"then be true for the rest of time. 'We have jumped for the "</span>
                    <span class="string">"second time' doesn't mean the jumping happened twice, it "</span>
                    <span class="string">"means the having-jumped has happened twice, which is "</span>
                    <span class="string">"impossible."</span><span class="plain">);</span>
                <span class="reserved">return</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">length</span><span class="plain"> == -1) &amp;&amp; (</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">until</span><span class="plain"> == -1)) {</span>
                <span class="identifier">PL::Actions::Patterns::emit_past_tense</span><span class="plain">(</span><span class="identifier">ap</span><span class="plain">);</span>
                <span class="reserved">return</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="identifier">pasturise</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
            <span class="identifier">duration</span><span class="plain">.</span><span class="identifier">tense</span><span class="plain"> = </span><span class="identifier">IS_TENSE</span><span class="plain">;</span>
        <span class="plain">}</span>
        <span class="plain">#</span><span class="identifier">endif</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">turns_flag</span><span class="plain"> = 0,</span>
            <span class="identifier">perfect_flag</span><span class="plain"> = ((</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">tense</span><span class="plain">)/2)%2,</span>
            <span class="identifier">past_flag</span><span class="plain"> = (</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">tense</span><span class="plain">)%2;</span>
        <span class="reserved">char</span><span class="plain"> *</span><span class="identifier">op</span><span class="plain"> = </span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">inform6_operator</span><span class="plain">;</span>
        <span class="reserved">past_tense_condition_record</span><span class="plain"> *</span><span class="identifier">ptc</span><span class="plain">;</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">too_late_for_past_tenses</span><span class="plain">) </span><span class="identifier">internal_error</span><span class="plain">(</span><span class="string">"too late for a PTC"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">units</span><span class="plain"> == </span><span class="identifier">TURNS_UNIT</span><span class="plain">) </span><span class="identifier">turns_flag</span><span class="plain"> = 1;</span>

        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">past_flag</span><span class="plain"> == 0) &amp;&amp; (</span><span class="identifier">perfect_flag</span><span class="plain"> == 0) &amp;&amp; (</span><span class="identifier">op</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">)) </span><span class="identifier">op</span><span class="plain"> = </span><span class="string">"=="</span><span class="plain">;</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">op</span><span class="plain"> == </span><span class="identifier">NULL</span><span class="plain">) </span><span class="identifier">op</span><span class="plain"> = </span><span class="string">"&gt;="</span><span class="plain">;</span>

        <span class="identifier">parse_node</span><span class="plain"> *</span><span class="identifier">cond</span><span class="plain"> = </span><span class="identifier">spec</span><span class="plain">;</span>

        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">output_wanted</span><span class="plain"> = 1 + </span><span class="identifier">turns_flag</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">operate</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Occurrence::is_valid</span><span class="plain">(&amp;</span><span class="identifier">duration</span><span class="plain">))</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">inform6_operator</span><span class="plain"> != </span><span class="identifier">NULL</span><span class="plain">) || (</span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">length</span><span class="plain"> &gt;= 0))</span>
                <span class="identifier">operate</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">operate</span><span class="plain">) {</span>
            &lt;<span class="cwebmacro">Emit the op</span> <span class="cwebmacronumber">3.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
        <span class="plain">}</span>
        <span class="identifier">Produce::inv_call_iname</span><span class="plain">(</span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">TESTSINGLEPASTSTATE_HL</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">past_flag</span><span class="plain">);</span>
            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_tenses</span><span class="plain">);</span>
            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) (</span><span class="identifier">output_wanted</span><span class="plain"> + 4*</span><span class="identifier">perfect_flag</span><span class="plain">));</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">operate</span><span class="plain">) {</span>
            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">duration</span><span class="plain">.</span><span class="identifier">length</span><span class="plain">);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="plain">}</span>

        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">no_past_tenses</span><span class="plain"> &gt;= 1024) { </span>    <span class="comment">limit imposed by the Z-machine implementation</span>
            <span class="identifier">Problems::Issue::limit_problem</span><span class="plain">(</span><span class="identifier">_p_</span><span class="plain">(</span><span class="identifier">Untestable</span><span class="plain">), </span>    <span class="comment">well, not conveniently</span>
                <span class="string">"conditions written in the past tense"</span><span class="plain">, 1024);</span>
            <span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>

        <span class="identifier">ptc</span><span class="plain"> = </span><span class="identifier">CREATE</span><span class="plain">(</span><span class="reserved">past_tense_condition_record</span><span class="plain">);</span>
        <span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;where_ptc_tested</span><span class="plain"> = </span><span class="identifier">current_sentence</span><span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">pasturise</span><span class="plain">) {</span>
            <span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;condition</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">IF_MODULE</span>
            <span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;ap_to_test</span><span class="plain"> = </span><span class="identifier">ap</span><span class="plain">;</span>
            <span class="plain">#</span><span class="identifier">endif</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;condition</span><span class="plain"> = </span><span class="identifier">cond</span><span class="plain">;</span>
            <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">IF_MODULE</span>
            <span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;ap_to_test</span><span class="plain"> = </span><span class="identifier">NULL</span><span class="plain">;</span>
            <span class="plain">#</span><span class="identifier">endif</span>
        <span class="plain">}</span>
        <span class="identifier">no_past_tenses</span><span class="plain">++;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Chronology::compile_past_tense_condition is used in 14/cn (<a href="14-cn.html#SP16">&#167;16</a>).</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5. The periodic monitoring. </b>As can be seen from the above routines, we depend on the array <code class="display"><span class="extract">TrackedActions</span></code>,
on a routine called <code class="display"><span class="extract">TestSinglePastState</span></code> and on magical things happening at
run-time at the start of every action. Once these are defined, it's too
late to create any further past tense references, so:
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Chronology::allow_no_further_past_tenses</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">too_late_for_past_tenses</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Chronology::allow_no_further_past_tenses is used in 1/mr (<a href="1-mr.html#SP4_14">&#167;4.14</a>).</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>The <code class="display"><span class="extract">{-A}</span></code> ("past actions") escape.
A series of <code class="display"><span class="extract">if</span></code> statements checking whether each past-tense action is now
true, and updating the relevant array entries accordingly.
</p>

<p class="inwebparagraph">This looks straightforward, but a tricky point arises from the fact that a
turn is not the same thing as a slot for an action. Usually they correspond,
but not always. So if the action for a turn is taking, and that causes
a further action of opening a box, say, what do we say about the number
of turns for which the taking and opening actions have been happening?
</p>

<p class="inwebparagraph">In <code class="display"><span class="extract">adjust</span></code> mode, we are at the start or end of a "try" action which
arises mid-turn. As can be seen, adjust mode is allowed only to change
the record of how many turns an action has been happening &mdash; from 0 to 1,
and otherwise making no change, if the action is the one being tried;
or else back to 0 if it isn't. In particular, an action implicitly
tried does not affect the "times" count.
</p>

<p class="inwebparagraph">This is a delicate business. The better way to solve this would be to
stack a local copy of these arrays each time an action starts, and restore
it (with updates) each time it finishes. But there is just no storage
available in the Z-machine to contemplate this with equanimity, so we
compromise. Historically, it's been a fertile source of tricky bugs.
The test case <code class="display"><span class="extract">ActionInterrupted</span></code> should be checked if this code is
ever tampered with.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Chronology::past_actions_i6_routines</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
    <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">IF_MODULE</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">once_only</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="reserved">past_tense_action_record</span><span class="plain"> *</span><span class="identifier">pta</span><span class="plain">;</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">pta</span><span class="plain">, </span><span class="reserved">past_tense_action_record</span><span class="plain">) {</span>
            <span class="identifier">current_sentence</span><span class="plain"> = </span><span class="identifier">pta</span><span class="plain">-</span><span class="element">&gt;where_pta_tested</span><span class="plain">; </span>    <span class="comment">ensure problems reported correctly</span>
            <span class="identifier">packaging_state</span><span class="plain"> </span><span class="identifier">save</span><span class="plain"> = </span><span class="functiontext">Routines::begin</span><span class="plain">(</span><span class="identifier">pta</span><span class="plain">-</span><span class="element">&gt;pta_iname</span><span class="plain">);</span>

            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="functiontext">Chronology::ap_compile_forced_to_present</span><span class="plain">(</span><span class="identifier">pta</span><span class="plain">-</span><span class="element">&gt;historic_action</span><span class="plain">);</span>
                <span class="identifier">Produce::code</span><span class="plain">();</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::rtrue</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="identifier">Produce::rfalse</span><span class="plain">();</span>

            <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">LocalVariables::are_we_using_table_lookup</span><span class="plain">()) &amp;&amp; (</span><span class="identifier">once_only</span><span class="plain">)) {</span>
                <span class="identifier">once_only</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
                <span class="identifier">Problems::Issue::sentence_problem</span><span class="plain">(</span><span class="identifier">_p_</span><span class="plain">(</span><span class="identifier">PM_PastTableLookup</span><span class="plain">),</span>
                    <span class="string">"it's not safe to look up table entries in a way referring "</span>
                    <span class="string">"to past history"</span><span class="plain">,</span>
                    <span class="string">"because it leads to dangerous ambiguities. For instance, "</span>
                    <span class="string">"does 'taking an item listed in the Table of Treasure "</span>
                    <span class="string">"for the first time' mean that this is the first time taking "</span>
                    <span class="string">"any of the things in the table, or only the first time "</span>
                    <span class="string">"this one? And so on."</span><span class="plain">);</span>
            <span class="plain">}</span>

            <span class="functiontext">Routines::end</span><span class="plain">(</span><span class="identifier">save</span><span class="plain">);</span>
        <span class="plain">}</span>
        <span class="identifier">inter_name</span><span class="plain"> *</span><span class="identifier">iname</span><span class="plain"> = </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">PASTACTIONSI6ROUTINES_HL</span><span class="plain">);</span>
        <span class="identifier">packaging_state</span><span class="plain"> </span><span class="identifier">save</span><span class="plain"> = </span><span class="functiontext">Emit::named_array_begin</span><span class="plain">(</span><span class="identifier">iname</span><span class="plain">, </span><span class="identifier">K_value</span><span class="plain">);</span>
        <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">pta</span><span class="plain">, </span><span class="reserved">past_tense_action_record</span><span class="plain">)</span>
            <span class="functiontext">Emit::array_iname_entry</span><span class="plain">(</span><span class="identifier">pta</span><span class="plain">-</span><span class="element">&gt;pta_iname</span><span class="plain">);</span>
        <span class="functiontext">Emit::array_numeric_entry</span><span class="plain">(0);</span>
        <span class="functiontext">Emit::array_numeric_entry</span><span class="plain">(0);</span>
        <span class="functiontext">Emit::array_end</span><span class="plain">(</span><span class="identifier">save</span><span class="plain">);</span>
    <span class="plain">#</span><span class="identifier">endif</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Chronology::past_actions_i6_routines is used in 1/mr (<a href="1-mr.html#SP4_14">&#167;4.14</a>).</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7.  </b></p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Chronology::past_tenses_i6_escape</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">once_only</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
        <span class="reserved">past_tense_condition_record</span><span class="plain"> *</span><span class="identifier">ptc</span><span class="plain">;</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TIME_PERIODS</span><span class="plain">,</span>
            <span class="string">"Creating %d past tense conditions in TestSinglePastState\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                <span class="identifier">NUMBER_CREATED</span><span class="plain">(</span><span class="reserved">past_tense_condition_record</span><span class="plain">));</span>

        <span class="identifier">packaging_state</span><span class="plain"> </span><span class="identifier">save</span><span class="plain"> = </span><span class="functiontext">Routines::begin</span><span class="plain">(</span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">TESTSINGLEPASTSTATE_HL</span><span class="plain">));</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">past_flag_s</span><span class="plain"> = </span><span class="functiontext">LocalVariables::add_named_call_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"past_flag"</span><span class="plain">);</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">pt_s</span><span class="plain"> = </span><span class="functiontext">LocalVariables::add_named_call_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"pt"</span><span class="plain">);</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">turn_end_s</span><span class="plain"> = </span><span class="functiontext">LocalVariables::add_named_call_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"turn_end"</span><span class="plain">);</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">wanted_s</span><span class="plain"> = </span><span class="functiontext">LocalVariables::add_named_call_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"wanted"</span><span class="plain">);</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">old_s</span><span class="plain"> = </span><span class="functiontext">LocalVariables::add_internal_local_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"old"</span><span class="plain">);</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">new_s</span><span class="plain"> = </span><span class="functiontext">LocalVariables::add_internal_local_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"new"</span><span class="plain">);</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">trips_s</span><span class="plain"> = </span><span class="functiontext">LocalVariables::add_internal_local_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"trips"</span><span class="plain">);</span>
        <span class="identifier">inter_symbol</span><span class="plain"> *</span><span class="identifier">consecutives_s</span><span class="plain"> = </span><span class="functiontext">LocalVariables::add_internal_local_as_symbol</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"consecutives"</span><span class="plain">);</span>
        <span class="functiontext">Frames::determines_the_past</span><span class="plain">();</span>

        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IFELSE_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">past_flag_s</span><span class="plain">);</span>
            <span class="identifier">Produce::code</span><span class="plain">();</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                &lt;<span class="cwebmacro">Unpack the past</span> <span class="cwebmacronumber">7.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="identifier">Produce::code</span><span class="plain">();</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                &lt;<span class="cwebmacro">Unpack the present</span> <span class="cwebmacronumber">7.2</span>&gt;<span class="plain">;</span>
                &lt;<span class="cwebmacro">Swizzle</span> <span class="cwebmacronumber">7.4</span>&gt;<span class="plain">;</span>
                &lt;<span class="cwebmacro">Repack the present</span> <span class="cwebmacronumber">7.3</span>&gt;<span class="plain">;</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>

        &lt;<span class="cwebmacro">Answer the question posed</span> <span class="cwebmacronumber">7.5</span>&gt;<span class="plain">;</span>

        <span class="functiontext">Routines::end</span><span class="plain">(</span><span class="identifier">save</span><span class="plain">);</span>
        <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TIME_PERIODS</span><span class="plain">, </span><span class="string">"Creation of past tense conditions complete\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Chronology::past_tenses_i6_escape is used in 1/mr (<a href="1-mr.html#SP4_14">&#167;4.14</a>).</p>

<p class="inwebparagraph"><a id="SP7_1"></a><b>&#167;7.1.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Unpack the past</span> <span class="cwebmacronumber">7.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">BITWISEAND_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">PAST_CHRONOLOGICAL_RECORD_HL</span><span class="plain">));</span>
                    <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">pt_s</span><span class="plain">);</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 1);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">trips_s</span><span class="plain">);</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">DIVIDE_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">BITWISEAND_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">PAST_CHRONOLOGICAL_RECORD_HL</span><span class="plain">));</span>
                        <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">pt_s</span><span class="plain">);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0</span><span class="identifier">xFE</span><span class="plain">);</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 2);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">consecutives_s</span><span class="plain">);</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">DIVIDE_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">BITWISEAND_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">PAST_CHRONOLOGICAL_RECORD_HL</span><span class="plain">));</span>
                        <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">pt_s</span><span class="plain">);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0</span><span class="identifier">xFF00</span><span class="plain">);</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0</span><span class="identifier">x100</span><span class="plain">);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_2"></a><b>&#167;7.2.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Unpack the present</span> <span class="cwebmacronumber">7.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">old_s</span><span class="plain">);</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">BITWISEAND_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">PRESENT_CHRONOLOGICAL_RECORD_HL</span><span class="plain">));</span>
                    <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">pt_s</span><span class="plain">);</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 1);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">trips_s</span><span class="plain">);</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">DIVIDE_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">BITWISEAND_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">PRESENT_CHRONOLOGICAL_RECORD_HL</span><span class="plain">));</span>
                        <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">pt_s</span><span class="plain">);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0</span><span class="identifier">xFE</span><span class="plain">);</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 2);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">consecutives_s</span><span class="plain">);</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">DIVIDE_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">BITWISEAND_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUP_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">PRESENT_CHRONOLOGICAL_RECORD_HL</span><span class="plain">));</span>
                        <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">pt_s</span><span class="plain">);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0</span><span class="identifier">xFF00</span><span class="plain">);</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0</span><span class="identifier">x100</span><span class="plain">);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_3"></a><b>&#167;7.3.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Repack the present</span> <span class="cwebmacronumber">7.3</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">LOOKUPREF_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::val_iname</span><span class="plain">(</span><span class="identifier">K_object</span><span class="plain">, </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">PRESENT_CHRONOLOGICAL_RECORD_HL</span><span class="plain">));</span>
                <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">pt_s</span><span class="plain">);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">PLUS_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">PLUS_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">TIMES_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">trips_s</span><span class="plain">);</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0</span><span class="identifier">x02</span><span class="plain">);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">TIMES_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">consecutives_s</span><span class="plain">);</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0</span><span class="identifier">x100</span><span class="plain">);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_4"></a><b>&#167;7.4.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Swizzle</span> <span class="cwebmacronumber">7.4</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">SWITCH_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">pt_s</span><span class="plain">);</span>
            <span class="identifier">Produce::code</span><span class="plain">();</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">LOOP_OVER</span><span class="plain">(</span><span class="identifier">ptc</span><span class="plain">, </span><span class="reserved">past_tense_condition_record</span><span class="plain">) {</span>
                    <span class="identifier">current_sentence</span><span class="plain"> = </span><span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;where_ptc_tested</span><span class="plain">; </span>    <span class="comment">ensure problems reported correctly</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">CASE_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) (</span><span class="identifier">ptc</span><span class="plain">-&gt;</span><span class="identifier">allocation_id</span><span class="plain">));</span>
                        <span class="identifier">Produce::code</span><span class="plain">();</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="constant">BEGIN_COMPILATION_MODE</span><span class="plain">;</span>
                            <span class="identifier">COMPILATION_MODE_EXIT</span><span class="plain">(</span><span class="constant">DEREFERENCE_POINTERS_CMODE</span><span class="plain">);</span>
                            &lt;<span class="cwebmacro">Compile code to set the new state of the condition, as measured in the present</span> <span class="cwebmacronumber">7.4.1</span>&gt;<span class="plain">;</span>
                            <span class="constant">END_COMPILATION_MODE</span><span class="plain">;</span>
                            <span class="reserved">if</span><span class="plain"> ((</span><span class="functiontext">LocalVariables::are_we_using_table_lookup</span><span class="plain">()) &amp;&amp; (</span><span class="identifier">once_only</span><span class="plain">)) {</span>
                                <span class="identifier">once_only</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
                                <span class="identifier">Problems::Issue::sentence_problem</span><span class="plain">(</span><span class="identifier">_p_</span><span class="plain">(</span><span class="identifier">PM_PastTableEntries</span><span class="plain">),</span>
                                    <span class="string">"it's not safe to look up table entries in a way referring "</span>
                                    <span class="string">"to past history"</span><span class="plain">,</span>
                                    <span class="string">"because it leads to dangerous ambiguities. For instance, "</span>
                                    <span class="string">"does 'taking an item listed in the Table of Treasure "</span>
                                    <span class="string">"for the first time' mean that this is the first time taking "</span>
                                    <span class="string">"any of the things in the table, or only the first time "</span>
                                    <span class="string">"this one? And so on."</span><span class="plain">);</span>
                            <span class="plain">}</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="plain">}</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">DEFAULT_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::code</span><span class="plain">();</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">PRINT_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_text</span><span class="plain">(</span><span class="identifier">I</span><span class="string">"*** No such past tense condition ***\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
                            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>

        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IFELSE_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
            <span class="identifier">Produce::code</span><span class="plain">();</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">EQ_BIP</span><span class="plain">));</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">old_s</span><span class="plain">);</span>
                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_truth_state</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::code</span><span class="plain">();</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">POSTINCREMENT_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">trips_s</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">GT_BIP</span><span class="plain">));</span>
                            <span class="identifier">Produce::down</span><span class="plain">();</span>
                                <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">trips_s</span><span class="plain">);</span>
                                <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 127);</span>
                            <span class="identifier">Produce::up</span><span class="plain">();</span>
                            <span class="identifier">Produce::code</span><span class="plain">();</span>
                            <span class="identifier">Produce::down</span><span class="plain">();</span>
                                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
                                <span class="identifier">Produce::down</span><span class="plain">();</span>
                                    <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">trips_s</span><span class="plain">);</span>
                                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 127);</span>
                                <span class="identifier">Produce::up</span><span class="plain">();</span>
                            <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>

                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">turn_end_s</span><span class="plain">);</span>
                    <span class="identifier">Produce::code</span><span class="plain">();</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">POSTINCREMENT_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">consecutives_s</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">GT_BIP</span><span class="plain">));</span>
                            <span class="identifier">Produce::down</span><span class="plain">();</span>
                                <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">consecutives_s</span><span class="plain">);</span>
                                <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 127);</span>
                            <span class="identifier">Produce::up</span><span class="plain">();</span>
                            <span class="identifier">Produce::code</span><span class="plain">();</span>
                            <span class="identifier">Produce::down</span><span class="plain">();</span>
                                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
                                <span class="identifier">Produce::down</span><span class="plain">();</span>
                                    <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">consecutives_s</span><span class="plain">);</span>
                                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 127);</span>
                                <span class="identifier">Produce::up</span><span class="plain">();</span>
                            <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>

            <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="identifier">Produce::code</span><span class="plain">();</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">consecutives_s</span><span class="plain">);</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP7_4_1"></a><b>&#167;7.4.1.  </b>The following goes through the dance of writing to a temporary stream in
order to ensure that the compilation happens in a memory stream, rather than
a file stream, thus allowing rewinding:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Compile code to set the new state of the condition, as measured in the present</span> <span class="cwebmacronumber">7.4.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;condition</span><span class="plain">) {</span>
            <span class="identifier">parse_node</span><span class="plain"> *</span><span class="identifier">spec</span><span class="plain"> = </span><span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;condition</span><span class="plain">;</span>
            <span class="identifier">LOGIF</span><span class="plain">(</span><span class="identifier">TIME_PERIODS</span><span class="plain">, </span><span class="string">"Number %d: proposition $D\</span><span class="plain">n</span><span class="string">"</span><span class="plain">,</span>
                <span class="identifier">ptc</span><span class="plain">-&gt;</span><span class="identifier">allocation_id</span><span class="plain">, </span><span class="functiontext">Specifications::to_proposition</span><span class="plain">(</span><span class="identifier">spec</span><span class="plain">));</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="functiontext">Calculus::Propositions::contains_callings</span><span class="plain">(</span><span class="functiontext">Specifications::to_proposition</span><span class="plain">(</span><span class="identifier">spec</span><span class="plain">))) {</span>
                <span class="identifier">Problems::Issue::sentence_problem</span><span class="plain">(</span><span class="identifier">_p_</span><span class="plain">(</span><span class="identifier">PM_PastCallings</span><span class="plain">),</span>
                    <span class="string">"it's not safe to use '(called ...)' in a way referring "</span>
                    <span class="string">"to past history"</span><span class="plain">,</span>
                    <span class="string">"because this would make a temporary value to hold the "</span>
                    <span class="string">"quantity in question, but at a different time from when "</span>
                    <span class="string">"it would be needed."</span><span class="plain">);</span>
            <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
                    <span class="functiontext">Specifications::Compiler::emit_as_val</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">spec</span><span class="plain">);</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="plain">}</span>
        <span class="plain">} </span><span class="reserved">else</span><span class="plain"> {</span>
            <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">IF_MODULE</span>
            <span class="identifier">LOG</span><span class="plain">(</span><span class="string">"Picked up past $A\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;ap_to_test</span><span class="plain">);</span>
            <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">STORE_BIP</span><span class="plain">));</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::ref_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
                <span class="identifier">PL::Actions::Patterns::emit_past_tense</span><span class="plain">(</span><span class="identifier">ptc</span><span class="plain">-</span><span class="element">&gt;ap_to_test</span><span class="plain">);</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="plain">#</span><span class="identifier">endif</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7_4">&#167;7.4</a>.</p>

<p class="inwebparagraph"><a id="SP7_5"></a><b>&#167;7.5.  </b><code class="display">
&lt;<span class="cwebmacrodefn">Answer the question posed</span> <span class="cwebmacronumber">7.5</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">SWITCH_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">wanted_s</span><span class="plain">);</span>
            <span class="identifier">Produce::code</span><span class="plain">();</span>
            <span class="identifier">Produce::down</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">CASE_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
                    <span class="identifier">Produce::code</span><span class="plain">();</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
                            <span class="identifier">Produce::code</span><span class="plain">();</span>
                            <span class="identifier">Produce::down</span><span class="plain">();</span>
                                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">RETURN_BIP</span><span class="plain">));</span>
                                <span class="identifier">Produce::down</span><span class="plain">();</span>
                                    <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
                                <span class="identifier">Produce::up</span><span class="plain">();</span>
                            <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">CASE_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 1);</span>
                    <span class="identifier">Produce::code</span><span class="plain">();</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
                            <span class="identifier">Produce::code</span><span class="plain">();</span>
                            <span class="identifier">Produce::down</span><span class="plain">();</span>
                                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">RETURN_BIP</span><span class="plain">));</span>
                                <span class="identifier">Produce::down</span><span class="plain">();</span>
                                    <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">trips_s</span><span class="plain">);</span>
                                <span class="identifier">Produce::up</span><span class="plain">();</span>
                            <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">CASE_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 2);</span>
                    <span class="identifier">Produce::code</span><span class="plain">();</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">IF_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
                            <span class="identifier">Produce::code</span><span class="plain">();</span>
                            <span class="identifier">Produce::down</span><span class="plain">();</span>
                                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">RETURN_BIP</span><span class="plain">));</span>
                                <span class="identifier">Produce::down</span><span class="plain">();</span>
                                    <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">PLUS_BIP</span><span class="plain">)); </span>    <span class="comment">Plus one because we count the current turn</span>
                                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                                        <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">consecutives_s</span><span class="plain">);</span>
                                        <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 1);</span>
                                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                                <span class="identifier">Produce::up</span><span class="plain">();</span>
                            <span class="identifier">Produce::up</span><span class="plain">();</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">CASE_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 4);</span>
                    <span class="identifier">Produce::code</span><span class="plain">();</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">RETURN_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">new_s</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">CASE_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 5);</span>
                    <span class="identifier">Produce::code</span><span class="plain">();</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">RETURN_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">trips_s</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">CASE_BIP</span><span class="plain">));</span>
                <span class="identifier">Produce::down</span><span class="plain">();</span>
                    <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 6);</span>
                    <span class="identifier">Produce::code</span><span class="plain">();</span>
                    <span class="identifier">Produce::down</span><span class="plain">();</span>
                        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">RETURN_BIP</span><span class="plain">));</span>
                        <span class="identifier">Produce::down</span><span class="plain">();</span>
                            <span class="identifier">Produce::val_symbol</span><span class="plain">(</span><span class="identifier">K_value</span><span class="plain">, </span><span class="identifier">consecutives_s</span><span class="plain">);</span>
                        <span class="identifier">Produce::up</span><span class="plain">();</span>
                    <span class="identifier">Produce::up</span><span class="plain">();</span>
                <span class="identifier">Produce::up</span><span class="plain">();</span>
            <span class="identifier">Produce::up</span><span class="plain">();</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>

        <span class="identifier">Produce::inv_primitive</span><span class="plain">(</span><span class="identifier">Produce::opcode</span><span class="plain">(</span><span class="identifier">RETURN_BIP</span><span class="plain">));</span>
        <span class="identifier">Produce::down</span><span class="plain">();</span>
            <span class="identifier">Produce::val</span><span class="plain">(</span><span class="identifier">K_number</span><span class="plain">, </span><span class="identifier">LITERAL_IVAL</span><span class="plain">, 0);</span>
        <span class="identifier">Produce::up</span><span class="plain">();</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP7">&#167;7</a>.</p>

<p class="inwebparagraph"><a id="SP8"></a><b>&#167;8.  </b>The <code class="display"><span class="extract">{-E}</span></code> ("extents") escape.
Sizes for the arrays. We need to do these after compiling the code in the
escapes above, because they might continue to spawn each other as they
compile: e.g. a past tense action pattern might itself refer to a condition
in the still more remote past, as in the case of "After switching on the
lunar clock when the lunar clock has been switched on for more than five
times".
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">Chronology::chronology_extents_i6_escape</span><span class="plain">(</span><span class="reserved">void</span><span class="plain">) {</span>
        <span class="identifier">inter_name</span><span class="plain"> *</span><span class="identifier">iname1</span><span class="plain"> = </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">NO_PAST_TENSE_CONDS_HL</span><span class="plain">);</span>
        <span class="functiontext">Hierarchy::make_available</span><span class="plain">(</span><span class="identifier">Produce::tree</span><span class="plain">(), </span><span class="identifier">iname1</span><span class="plain">);</span>
        <span class="functiontext">Emit::named_numeric_constant</span><span class="plain">(</span><span class="identifier">iname1</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_tenses</span><span class="plain">);</span>

        <span class="identifier">inter_name</span><span class="plain"> *</span><span class="identifier">iname2</span><span class="plain"> = </span><span class="functiontext">Hierarchy::find</span><span class="plain">(</span><span class="constant">NO_PAST_TENSE_ACTIONS_HL</span><span class="plain">);</span>
        <span class="functiontext">Hierarchy::make_available</span><span class="plain">(</span><span class="identifier">Produce::tree</span><span class="plain">(), </span><span class="identifier">iname2</span><span class="plain">);</span>
        <span class="functiontext">Emit::named_numeric_constant</span><span class="plain">(</span><span class="identifier">iname2</span><span class="plain">, (</span><span class="identifier">inter_t</span><span class="plain">) </span><span class="identifier">no_past_actions</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function Chronology::chronology_extents_i6_escape is used in 1/mr (<a href="1-mr.html#SP4_14">&#167;4.14</a>).</p>

<hr class="tocbar">
<ul class="toc"><li><a href="24-sf.html">Back to 'Stack Frames'</a></li><li><i>(This section ends Chapter 24: Compilation Context.)</i></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

