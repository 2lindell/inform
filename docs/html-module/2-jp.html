<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>2/hf</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">
		<link href="inweb.css" rel="stylesheet" rev="stylesheet" type="text/css">
	</head>
	<body>

<!--Weave of '2/jp' generated by 7-->
<ul class="crumbs"><li><a href="../webs.html">&#9733;</a></li><li><a href="index.html">html</a></li><li><a href="index.html#2">Chapter 2: HTML</a></li><li><b>Javascript Pastes</b></li></ul><p class="purpose">To write valid HTML for a paste icon which, when clicked, calls a Javascript function which will paste Inform source text into the Source panel of the application.</p>

<ul class="toc"><li><a href="#SP1">&#167;1. Definitions</a></li><li><a href="#SP7">&#167;7. Individual characters</a></li></ul><hr class="tocbar">

<p class="inwebparagraph"><a id="SP1"></a><b>&#167;1. Definitions. </b></p>

<p class="inwebparagraph"><a id="SP2"></a><b>&#167;2.  </b>The application is required to provide a Javascript function to copy text
into the source window. Broadly speaking, the application needs to support
Javascript in the following form:
</p>

<p class="inwebparagraph"></p>


<pre class="display">
        <span class="plain">var myProject = external.Project;</span>
        <span class="plain">myProject.selectView('source');</span>
        <span class="plain">myProject.pasteCode('Trying Taking Manhattan');</span>
</pre>

<p class="inwebparagraph">This for Windows: for OS X, the same code but <code class="display"><span class="extract">window.Project</span></code> rather
than <code class="display"><span class="extract">external.Project</span></code>.
</p>

<p class="inwebparagraph">As this implies, the details unfortunately differ on different platforms:
</p>

<ul class="items"><li>(a) Model 1 - paste in OS X style, directly within the HREF of a link.
</li><li>(b) Model 2 - paste in Windows style, defining a function and calling that.
</li></ul>
<p class="inwebparagraph">In model 2 we define a Javascript function for each individual paste
because this protects against long paste texts overflowing what Windows
considers the maximum permitted length of a link: the WebKit rendering
engine in OS X has no such limit, apparently. This means that for Windows
we define numerous copies of the Javascript code above. In model 1, we
never need to compile fresh Javascript functions because the template file
<code class="display"><span class="extract">ExtensionFileModel.html</span></code> for OS X contains a definition of the single
Javascript function:
</p>

<p class="inwebparagraph"></p>


<pre class="display">
        <span class="plain">&lt;script language="JavaScript"&gt;</span>
        <span class="plain">function pasteCode(code) {</span>
        <span class="plain">	var myProject = project();</span>
        <span class="plain">	myProject.selectView('source');</span>
        <span class="plain">	myProject.pasteCode(code);</span>
        <span class="plain">}</span>
        <span class="plain">&lt;/script&gt;</span>
</pre>

<p class="inwebparagraph">and we can simply call <code class="display"><span class="extract">href="javascript:pasteCode(...)"</span></code> from any link.
</p>

<p class="inwebparagraph">The text pasted may in some cases be quite long (say, 5K or more) and the
code below should work whatever its length. It will of course be UTF-8 encoded,
since all HTML produced by NI is.
</p>

<p class="inwebparagraph"><a id="SP3"></a><b>&#167;3.  </b>We have found that different Javascript implementations handle escape
characters in quoted text differently. (For instance, some allow a
double-quote <code class="display"><span class="extract">"</span></code> to appear as a literal in single-quoted text, others
require <code class="display"><span class="extract">&amp;quot;</span></code> to be used, others still do not recognise HTML entities
like <code class="display"><span class="extract">&amp;quot;</span></code> and treat them as literal text.) To avoid these tiresome
platform dependencies a single new escape-character syntax was added in
November 2007. This puts obligations both on NI (and <code class="display"><span class="extract">indoc</span></code>, which also
generates HTML with Javascript pastes), to make use of the escape syntax,
and also on the application, to understand and act on it.
</p>

<p class="inwebparagraph">The application must implement <code class="display"><span class="extract">myProject.pasteCode(code)</span></code> such that every
instance of <code class="display"><span class="extract">[=0xHHHH=]</span></code> is replaced with the Unicode character whose
hexadecimal code is <code class="display"><span class="extract">HHHH</span></code>. There will always be four digits, with leading
zeros as needed, and <code class="display"><span class="extract">A</span></code> to <code class="display"><span class="extract">F</span></code> will be written in upper case. The only
Unicode characters with codes below <code class="display"><span class="extract">0x0020</span></code> which must be handled are
newline, <code class="display"><span class="extract">0x000A</span></code>, and tab, <code class="display"><span class="extract">0x0009</span></code>.
</p>

<p class="inwebparagraph">The generator (NI or <code class="display"><span class="extract">indoc</span></code>) must always escape every instance of the
following characters:
</p>

<p class="inwebparagraph"></p>

<ul class="items"><li>(a) every tab is escaped to <code class="display"><span class="extract">[=0x0009=]</span></code>;
</li><li>(b) every newline is escaped to <code class="display"><span class="extract">[=0x000A=]</span></code>;
</li><li>(c) every double quotation mark is escaped to <code class="display"><span class="extract">[=0x0022=]</span></code>;
</li><li>(d) every ampersand is escaped to <code class="display"><span class="extract">[=0x0026=]</span></code>;
</li><li>(e) every single quotation mark is escaped to <code class="display"><span class="extract">[=0x0027=]</span></code>;
</li><li>(f) every less than sign is escaped to <code class="display"><span class="extract">[=0x003C=]</span></code>;
</li><li>(g) every greater than sign is escaped to <code class="display"><span class="extract">[=0x003E=]</span></code>;
</li><li>(h) every backslash is escaped to <code class="display"><span class="extract">[=0x005C=]</span></code>.
</li></ul>
<p class="inwebparagraph">It may also choose to escape other character codes, as it prefers. Other
characters are generated as literal UTF-8. In no case will any character
with code below <code class="display"><span class="extract">0x0020</span></code> be passed as a literal.
</p>

<p class="inwebparagraph"><a id="SP4"></a><b>&#167;4.  </b>At the top level, the form of link used depends on the Javascript model.
Note that model 0 results in no material at all being output. The actual
text to be passed is all set via <code class="display"><span class="extract">HTML::Javascript::javascript_string_out</span></code> below, and which
does not depend on the model.
</p>


<pre class="display">
    <span class="reserved">int</span><span class="plain"> </span><span class="identifier">javascript_fn_counter</span><span class="plain"> = 1000;</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">HTML::Javascript::paste_W</span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="identifier">wording</span><span class="plain"> </span><span class="identifier">W</span><span class="plain">) {</span>
        <span class="functiontext">HTML::Javascript::paste_inner</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">Wordings::first_wn</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">), </span><span class="identifier">Wordings::last_wn</span><span class="plain">(</span><span class="identifier">W</span><span class="plain">), </span><span class="identifier">NULL</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">HTML::Javascript::paste_stream</span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">alt_stream</span><span class="plain">) {</span>
        <span class="functiontext">HTML::Javascript::paste_inner</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, -1, -1, </span><span class="identifier">alt_stream</span><span class="plain">);</span>
    <span class="plain">}</span>
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">HTML::Javascript::paste_inner</span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">from</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">to</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">alt_stream</span><span class="plain">) {</span>
        <span class="plain">#</span><span class="identifier">ifndef</span><span class="plain"> </span><span class="identifier">WINDOWS_JAVASCRIPT</span><span class="plain"> </span>    <span class="comment">OS X style, with long function arguments allowed in links</span>
            <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">link</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">link</span><span class="plain">, </span><span class="string">"href=\</span><span class="plain">"</span><span class="string">javascript:pasteCode("</span><span class="plain">);</span>
            <span class="functiontext">HTML::Javascript::javascript_string_out</span><span class="plain">(</span><span class="identifier">link</span><span class="plain">, </span><span class="identifier">from</span><span class="plain">, </span><span class="identifier">to</span><span class="plain">, </span><span class="identifier">alt_stream</span><span class="plain">);</span>
            <span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">link</span><span class="plain">, </span><span class="string">")\</span><span class="plain">"</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">HTML_OPEN_WITH</span><span class="plain">(</span><span class="string">"a"</span><span class="plain">, </span><span class="string">"%S"</span><span class="plain">, </span><span class="identifier">link</span><span class="plain">);</span>
            <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">link</span><span class="plain">);</span>
            <span class="identifier">HTML_TAG_WITH</span><span class="plain">(</span><span class="string">"img"</span><span class="plain">, </span><span class="string">"border=0 src=inform:/doc_images/paste.png"</span><span class="plain">);</span>
            <span class="identifier">HTML_CLOSE</span><span class="plain">(</span><span class="string">"a"</span><span class="plain">);</span>
        <span class="plain">#</span><span class="identifier">endif</span>

        <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">WINDOWS_JAVASCRIPT</span><span class="plain"> </span>    <span class="comment">Windows style, with long function arguments in links unreliable</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;script language=\</span><span class="plain">"</span><span class="string">JavaScript\</span><span class="plain">"</span><span class="string">&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"function pasteCode%d(code) {\</span><span class="plain">n</span><span class="string">"</span><span class="plain">, </span><span class="identifier">javascript_fn_counter</span><span class="plain">); </span><span class="identifier">INDENT</span><span class="plain">;</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"var myProject = project();\</span><span class="plain">n</span><span class="string">\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"myProject.selectView('source');\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"myProject.pasteCode("</span><span class="plain">);</span>
            <span class="identifier">OUTDENT</span><span class="plain">; </span><span class="functiontext">HTML::Javascript::javascript_string_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">from</span><span class="plain">, </span><span class="identifier">to</span><span class="plain">, </span><span class="identifier">alt_stream</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">");\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"}\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"&lt;/script&gt;\</span><span class="plain">n</span><span class="string">"</span><span class="plain">);</span>
            <span class="identifier">HTML_OPEN_WITH</span><span class="plain">(</span><span class="string">"a"</span><span class="plain">, </span><span class="string">"href=\</span><span class="plain">"</span><span class="string">javascript:pasteCode%d()\</span><span class="plain">"</span><span class="string">"</span><span class="plain">, </span><span class="identifier">javascript_fn_counter</span><span class="plain">++);</span>
            <span class="identifier">HTML_TAG_WITH</span><span class="plain">(</span><span class="string">"img"</span><span class="plain">, </span><span class="string">"border=0 src=inform:/doc_images/paste.png"</span><span class="plain">);</span>
            <span class="identifier">HTML_CLOSE</span><span class="plain">(</span><span class="string">"a"</span><span class="plain">);</span>
        <span class="plain">#</span><span class="identifier">endif</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function HTML::Javascript::paste_W is used in 2/hd (<a href="2-hd.html#SP9_4_1">&#167;9.4.1</a>).</p>

<p class="endnote">The function HTML::Javascript::paste_stream appears nowhere else.</p>

<p class="endnote">The function HTML::Javascript::paste_inner appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP5"></a><b>&#167;5.  </b>Though the Javascript function is called <code class="display"><span class="extract">openFile</span></code>, it can equally well
compile a link to open a folder on the host filing system.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">HTML::Javascript::open_file</span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="identifier">pathname</span><span class="plain"> *</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">leaf</span><span class="plain">, </span><span class="reserved">char</span><span class="plain"> *</span><span class="identifier">contents</span><span class="plain">) {</span>
        <span class="identifier">TEMPORARY_TEXT</span><span class="plain">(</span><span class="identifier">fn</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">leaf</span><span class="plain">) </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">fn</span><span class="plain">, </span><span class="string">"%f"</span><span class="plain">, </span><span class="identifier">Filenames::in_folder</span><span class="plain">(</span><span class="identifier">P</span><span class="plain">, </span><span class="identifier">leaf</span><span class="plain">));</span>
        <span class="reserved">else</span><span class="plain"> </span><span class="identifier">WRITE_TO</span><span class="plain">(</span><span class="identifier">fn</span><span class="plain">, </span><span class="string">"%p"</span><span class="plain">, </span><span class="identifier">P</span><span class="plain">);</span>

        <span class="plain">#</span><span class="identifier">ifdef</span><span class="plain"> </span><span class="identifier">WINDOWS_JAVASCRIPT</span>
        <span class="identifier">LOOP_THROUGH_TEXT</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">, </span><span class="identifier">fn</span><span class="plain">) </span><span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Str::get</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">) == </span><span class="character">'\</span><span class="plain">\</span><span class="character">'</span><span class="plain">) </span><span class="identifier">Str::put</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">, </span><span class="character">'/'</span><span class="plain">);</span>
        <span class="plain">#</span><span class="identifier">endif</span>

        <span class="identifier">HTML_OPEN_WITH</span><span class="plain">(</span><span class="string">"a"</span><span class="plain">, </span><span class="string">"href='javascript:project().openFile(\</span><span class="plain">"</span><span class="string">%S\</span><span class="plain">"</span><span class="string">)'"</span><span class="plain">, </span><span class="identifier">fn</span><span class="plain">);</span>
        <span class="identifier">HTML_TAG_WITH</span><span class="plain">(</span><span class="string">"img"</span><span class="plain">, </span><span class="string">"%s"</span><span class="plain">, </span><span class="identifier">contents</span><span class="plain">);</span>
        <span class="identifier">HTML_CLOSE</span><span class="plain">(</span><span class="string">"a"</span><span class="plain">);</span>
        <span class="identifier">DISCARD_TEXT</span><span class="plain">(</span><span class="identifier">fn</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function HTML::Javascript::open_file appears nowhere else.</p>

<p class="inwebparagraph"><a id="SP6"></a><b>&#167;6.  </b>In the following, the source of the text can be either a range of words
from the lexer (as for instance when a portion of an extension is being
typeset as documentation, with an example that can be pasted), or can
be a C string: if the latter, then its encoding must be ISO Latin-1.
The conversion to UTF-8 is performed in <code class="display"><span class="extract">HTML::Javascript::javascript_char_out</span></code> below.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">HTML::Javascript::javascript_string_out</span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">from</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">to</span><span class="plain">, </span><span class="identifier">text_stream</span><span class="plain"> *</span><span class="identifier">alt_stream</span><span class="plain">) {</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"'"</span><span class="plain">);</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">alt_stream</span><span class="plain">) </span>&lt;<span class="cwebmacro">Write stream as Javascript string</span> <span class="cwebmacronumber">6.1</span>&gt;<span class="plain">;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">from</span><span class="plain"> &gt;= 0) </span>&lt;<span class="cwebmacro">Write word range as Javascript string</span> <span class="cwebmacronumber">6.2</span>&gt;<span class="plain">;</span>
        <span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"'"</span><span class="plain">);</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function HTML::Javascript::javascript_string_out is used in <a href="#SP4">&#167;4</a>.</p>

<p class="inwebparagraph"><a id="SP6_1"></a><b>&#167;6.1.  </b>The art of leadership is delegation.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Write stream as Javascript string</span> <span class="cwebmacronumber">6.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="identifier">LOOP_THROUGH_TEXT</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">, </span><span class="identifier">alt_stream</span><span class="plain">)</span>
            <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">Str::get</span><span class="plain">(</span><span class="identifier">pos</span><span class="plain">));</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6_2"></a><b>&#167;6.2.  </b>Writing a word range is much harder. In effect, we have to provide an
inverse function for the lexer, which converted raw source text to nicely
packaged up words.
</p>

<p class="inwebparagraph">See Lexer for details of how words are stored, and in particular for the
<code class="display"><span class="extract">lw_break</span></code> character, which is <code class="display"><span class="extract">'\t'</span></code> when the word followed a tab, but is
<code class="display"><span class="extract">'1'</span></code> to <code class="display"><span class="extract">'9'</span></code> when it followed a newline plus that many tabs. We need
this because lexing has otherwise removed whitespace from the source, and
we need it back again if we're to paste a faithful Javascript representation:
otherwise the tabs used as column-dividers in tables will not come through,
for instance. Moreover, indentation from the left margin is used to make
prettier pastes (which respect the layout of the original examples from
which the paste has been made), and for that we need the <code class="display"><span class="extract">'1'</span></code> to <code class="display"><span class="extract">'9'</span></code>
possibilities.
</p>

<p class="inwebparagraph">Note that we expect the material pasted to be indented at 1 tab stop from
the margin already, because it will almost always be a source text within
an example, where any matter unindented will be commentary rather than
source text. Thus a single tab after a newline is not significant, and we
only need to supply extra Javascript tabs when the indentation is 2 tab
stops or more.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Write word range as Javascript string</span> <span class="cwebmacronumber">6.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">i</span><span class="plain">, </span><span class="identifier">suppress_space</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">, </span><span class="identifier">follows_paragraph_break</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
        <span class="reserved">int</span><span class="plain"> </span><span class="identifier">close_I6_position</span><span class="plain"> = -1;</span>
        <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">i</span><span class="plain">=</span><span class="identifier">from</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">&lt;=</span><span class="identifier">to</span><span class="plain">; </span><span class="identifier">i</span><span class="plain">++) {</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">j</span><span class="plain">;</span>
            <span class="identifier">wchar_t</span><span class="plain"> *</span><span class="identifier">p</span><span class="plain"> = </span><span class="identifier">Lexer::word_raw_text</span><span class="plain">(</span><span class="identifier">i</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Lexer::word</span><span class="plain">(</span><span class="identifier">i</span><span class="plain">) == </span><span class="identifier">PARBREAK_V</span><span class="plain">) { </span>    <span class="comment">marker for a paragraph break</span>
                <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">'\</span><span class="plain">n</span><span class="character">'</span><span class="plain">);</span>
                <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">'\</span><span class="plain">n</span><span class="character">'</span><span class="plain">);</span>
                <span class="identifier">suppress_space</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
                <span class="identifier">follows_paragraph_break</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
                <span class="reserved">while</span><span class="plain"> (</span><span class="identifier">Lexer::word</span><span class="plain">(</span><span class="identifier">i</span><span class="plain">) == </span><span class="identifier">PARBREAK_V</span><span class="plain">) </span><span class="identifier">i</span><span class="plain">++; </span><span class="identifier">i</span><span class="plain">--; </span>    <span class="comment">elide multiple breaks</span>
                <span class="reserved">continue</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="reserved">int</span><span class="plain"> </span><span class="identifier">indentation</span><span class="plain"> = </span><span class="identifier">Lexer::indentation_level</span><span class="plain">(</span><span class="identifier">i</span><span class="plain">);</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">indentation</span><span class="plain"> &gt; 0) { </span>    <span class="comment">number of tab stops of indentation on this para</span>
                <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">'\</span><span class="plain">n</span><span class="character">'</span><span class="plain">);</span>
                <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">j</span><span class="plain">=0; </span><span class="identifier">j</span><span class="plain">&lt;</span><span class="identifier">indentation</span><span class="plain">-1; </span><span class="identifier">j</span><span class="plain">++) </span><span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">'\</span><span class="plain">t</span><span class="character">'</span><span class="plain">);</span>
                <span class="identifier">suppress_space</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">Lexer::break_before</span><span class="plain">(</span><span class="identifier">i</span><span class="plain">) == </span><span class="character">'\</span><span class="plain">t</span><span class="character">'</span><span class="plain">) &amp;&amp; (</span><span class="identifier">follows_paragraph_break</span><span class="plain"> == </span><span class="identifier">FALSE</span><span class="plain">)) {</span>
                <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">'\</span><span class="plain">t</span><span class="character">'</span><span class="plain">);</span>
                <span class="identifier">suppress_space</span><span class="plain"> = </span><span class="identifier">TRUE</span><span class="plain">;</span>
            <span class="plain">}</span>
            <span class="identifier">follows_paragraph_break</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
            <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">suppress_space</span><span class="plain">==</span><span class="identifier">FALSE</span><span class="plain">)</span>
                &lt;<span class="cwebmacro">Restore inter-word spaces unless this would be unnatural</span> <span class="cwebmacronumber">6.2.1</span>&gt;<span class="plain">;</span>
            <span class="identifier">suppress_space</span><span class="plain"> = </span><span class="identifier">FALSE</span><span class="plain">;</span>
            <span class="reserved">for</span><span class="plain"> (</span><span class="identifier">j</span><span class="plain">=0; </span><span class="identifier">p</span><span class="plain">[</span><span class="identifier">j</span><span class="plain">]; </span><span class="identifier">j</span><span class="plain">++) </span><span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="identifier">p</span><span class="plain">[</span><span class="identifier">j</span><span class="plain">]);</span>
            &lt;<span class="cwebmacro">Insert a close-literal-I6 escape sequence if necessary</span> <span class="cwebmacronumber">6.2.2</span>&gt;<span class="plain">;</span>
        <span class="plain">}</span>
        <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">'\</span><span class="plain">n</span><span class="character">'</span><span class="plain">);</span>
        <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">'\</span><span class="plain">n</span><span class="character">'</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6">&#167;6</a>.</p>

<p class="inwebparagraph"><a id="SP6_2_1"></a><b>&#167;6.2.1.  </b>The lexer also broke words around punctuation marks, so that, for instance,
"fish, finger" would have been lexed as <code class="display"><span class="extract">fish , finger</span></code> &mdash; three words.
But we want to restore the more natural spacing.
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Restore inter-word spaces unless this would be unnatural</span> <span class="cwebmacronumber">6.2.1</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> ((</span><span class="identifier">i</span><span class="plain">&gt;</span><span class="identifier">from</span><span class="plain">)</span>
            <span class="plain">&amp;&amp; ((</span><span class="identifier">p</span><span class="plain">[1] != 0) || (</span><span class="identifier">Lexer::is_punctuation</span><span class="plain">(</span><span class="identifier">p</span><span class="plain">[0]) == </span><span class="identifier">FALSE</span><span class="plain">) ||</span>
                <span class="plain">(</span><span class="identifier">p</span><span class="plain">[0] == </span><span class="character">'('</span><span class="plain">) || (</span><span class="identifier">p</span><span class="plain">[0] == </span><span class="character">'{'</span><span class="plain">) || (</span><span class="identifier">p</span><span class="plain">[0] == </span><span class="character">'}'</span><span class="plain">))</span>
            <span class="plain">&amp;&amp; (</span><span class="identifier">compare_word</span><span class="plain">(</span><span class="identifier">i</span><span class="plain">-1, </span><span class="identifier">OPENBRACKET_V</span><span class="plain">)==</span><span class="identifier">FALSE</span><span class="plain">))</span>
            <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">' '</span><span class="plain">);</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_2">&#167;6.2</a>.</p>

<p class="inwebparagraph"><a id="SP6_2_2"></a><b>&#167;6.2.2.  </b>Finally, the lexer rendered a literal I6 inclusion in the form
</p>

<blockquote>
    <p>(- self=2; -)</p>

</blockquote>

<p class="inwebparagraph">as a sequence of two lexical words: <code class="display"><span class="extract">(-</span></code> and then <code class="display"><span class="extract">self=2;</span></code>. In order
to paste back safely, we must supplement this with the closure "-)" once
again:
</p>


<p class="macrodefinition"><code class="display">
&lt;<span class="cwebmacrodefn">Insert a close-literal-I6 escape sequence if necessary</span> <span class="cwebmacronumber">6.2.2</span>&gt; =
</code></p>


<pre class="displaydefn">
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">Lexer::word</span><span class="plain">(</span><span class="identifier">i</span><span class="plain">) == </span><span class="identifier">OPENI6_V</span><span class="plain">) </span><span class="identifier">close_I6_position</span><span class="plain"> = </span><span class="identifier">i</span><span class="plain">+1;</span>
        <span class="reserved">if</span><span class="plain"> (</span><span class="identifier">close_I6_position</span><span class="plain"> == </span><span class="identifier">i</span><span class="plain">) {</span>
            <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">'-'</span><span class="plain">);</span>
            <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">')'</span><span class="plain">);</span>
            <span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUT</span><span class="plain">, </span><span class="character">' '</span><span class="plain">);</span>
        <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">This code is used in <a href="#SP6_2">&#167;6.2</a>.</p>

<p class="inwebparagraph"><a id="SP7"></a><b>&#167;7. Individual characters. </b>Note that every character within the single quotes of a Javascript string
is produced through the following routine. It escapes certain awkward
characters, but need not convert from ISO Latin-1 to UTF-8 since that will
happen automatically downstream of us when the output is written as a
UTF-8 encoded HTML file.
</p>


<pre class="display">
    <span class="reserved">void</span><span class="plain"> </span><span class="functiontext">HTML::Javascript::javascript_char_out</span><span class="plain">(</span><span class="identifier">OUTPUT_STREAM</span><span class="plain">, </span><span class="reserved">int</span><span class="plain"> </span><span class="identifier">c</span><span class="plain">) {</span>
        <span class="reserved">switch</span><span class="plain">(</span><span class="identifier">c</span><span class="plain">) {</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="character">'\</span><span class="plain">t</span><span class="character">'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"[=0x0009=]"</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="character">'\</span><span class="plain">n</span><span class="character">'</span><span class="plain">: </span><span class="reserved">case</span><span class="plain"> </span><span class="identifier">NEWLINE_IN_STRING</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"[=0x000A=]"</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="character">'"'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"[=0x0022=]"</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="character">'&amp;'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"[=0x0026=]"</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="character">'\</span><span class="plain">'</span><span class="character">'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"[=0x0027=]"</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="character">'&lt;'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"[=0x003C=]"</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="character">'&gt;'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"[=0x003E=]"</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">;</span>
            <span class="reserved">case</span><span class="plain"> </span><span class="character">'\</span><span class="plain">\</span><span class="character">'</span><span class="plain">: </span><span class="identifier">WRITE</span><span class="plain">(</span><span class="string">"[=0x005C=]"</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">;</span>
            <span class="reserved">default</span><span class="plain">: </span><span class="identifier">PUT</span><span class="plain">(</span><span class="identifier">c</span><span class="plain">); </span><span class="reserved">return</span><span class="plain">;</span>
        <span class="plain">}</span>
    <span class="plain">}</span>
</pre>

<p class="inwebparagraph"></p>

<p class="endnote">The function HTML::Javascript::javascript_char_out is used in <a href="#SP6_1">&#167;6.1</a>, <a href="#SP6_2">&#167;6.2</a>, <a href="#SP6_2_1">&#167;6.2.1</a>, <a href="#SP6_2_2">&#167;6.2.2</a>.</p>

<hr class="tocbar">
<ul class="toc"><li><a href="2-hf.html">Back to 'HTML Files'</a></li><li><a href="2-hd.html">Continue with 'HTML Documentation'</a></li></ul><hr class="tocbar">
<!--End of weave-->
	</body>
</html>

